<div class="distribution-site-permit-container">
    <section>
        <div class="container services">
            <h4 class="title">{{ 'DIST_SITE.TITLE' | translate }}</h4>
            <p class="mb-5">{{ 'DIST_SITE.DESCRIPTION' | translate }}</p>

            <!-- Loading state -->
            <div *ngIf="isLoading" class="text-center py-5">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">{{ 'COMMON.LOADING' | translate }}</span>
                </div>
                <p class="mt-3">{{ 'COMMON.LOADING_DATA' | translate }}</p>
            </div>

            <!-- Main Content -->
            <div *ngIf="!isLoading" class="row">
                <!-- Tabs Navigation -->
                <div class="col-lg-3 mb-4">
                    <div class="main-container h-100">
                        <!-- Tab 1: Main Information -->
                        <div class="step-navigation-item">
                            <div class="step-container" 
                                 [class.active]="isTabActive(1)" 
                                 [class.completed]="isTabCompleted(1)"
                                 [class.invalid]="currentTab > 1 && !isTabCompleted(1)">
                                <div class="step-bg"></div>
                                <div class="step">
                                    <span *ngIf="!isTabCompleted(1)">1</span>
                                    <i *ngIf="isTabCompleted(1)" class="fas fa-check"></i>
                                </div>
                            </div>
                            <div class="connecting-line" *ngIf="currentTab !== 5"></div>
                            <div class="step-content-wrapper">
                                <span class="step-title" 
                                      (click)="goToTab(1)"
                                      [class.text-success]="isTabCompleted(1)"
                                      [class.text-danger]="currentTab > 1 && !isTabCompleted(1)"
                                      [class.text-primary]="isTabActive(1)">
                                    {{ 'DIST_SITE.TAB1_TITLE' | translate }}
                                </span>
                                <small class="d-block text-muted step-description">{{ 'DIST_SITE.MAIN_INFO_DESC' | translate }}</small>
                            </div>
                        </div>
                        
                        <!-- Tab 2: Date Details -->
                        <div class="step-navigation-item">
                            <div class="step-container" 
                                 [class.active]="isTabActive(2)" 
                                 [class.completed]="isTabCompleted(2)"
                                 [class.invalid]="currentTab > 2 && !isTabCompleted(2)">
                                <div class="step-bg"></div>
                                <div class="step">
                                    <span *ngIf="!isTabCompleted(2)">2</span>
                                    <i *ngIf="isTabCompleted(2)" class="fas fa-check"></i>
                                </div>
                            </div>
                            <div class="connecting-line"></div>
                            <div class="step-content-wrapper">
                                <span class="step-title" 
                                      (click)="goToTab(2)"
                                      [class.text-success]="isTabCompleted(2)"
                                      [class.text-danger]="currentTab > 2 && !isTabCompleted(2)"
                                      [class.text-primary]="isTabActive(2)">
                                    {{ 'DIST_SITE.DATE_DETAILS_TAB' | translate }}
                                </span>
                                <small class="d-block text-muted step-description">{{ 'DIST_SITE.DATE_DETAILS_DESC' | translate }}</small>
                            </div>
                        </div>
                        
                        <!-- Tab 3: Supervisor Information -->
                        <div class="step-navigation-item">
                            <div class="step-container" 
                                 [class.active]="isTabActive(3)" 
                                 [class.completed]="isTabCompleted(3)"
                                 [class.invalid]="currentTab > 3 && !isTabCompleted(3)">
                                <div class="step-bg"></div>
                                <div class="step">
                                    <span *ngIf="!isTabCompleted(3)">3</span>
                                    <i *ngIf="isTabCompleted(3)" class="fas fa-check"></i>
                                </div>
                            </div>
                            <div class="connecting-line"></div>
                            <div class="step-content-wrapper">
                                <span class="step-title" 
                                      (click)="goToTab(3)"
                                      [class.text-success]="isTabCompleted(3)"
                                      [class.text-danger]="currentTab > 3 && !isTabCompleted(3)"
                                      [class.text-primary]="isTabActive(3)">
                                    {{ 'DIST_SITE.SUPERVISOR_INFO_TAB' | translate }}
                                </span>
                                <small class="d-block text-muted step-description">{{ 'DIST_SITE.SUPERVISOR_INFO_DESC' | translate }}</small>
                            </div>
                        </div>
                        
                        <!-- Tab 4: Partners -->
                        <div class="step-navigation-item">
                            <div class="step-container partners-tab" 
                                 [class.active]="isTabActive(4)" 
                                 [class.completed]="isTabCompleted(4)"
                                 [class.invalid]="currentTab > 4 && !isTabCompleted(4)">
                                <div class="step-bg"></div>
                                <div class="step">
                                    <span *ngIf="!isTabCompleted(4)">4</span>
                                    <i *ngIf="isTabCompleted(4)" class="fas fa-check"></i>
                                </div>
                            </div>
                            <div class="connecting-line"></div>
                            <div class="step-content-wrapper">
                                <span class="step-title" 
                                      (click)="goToTab(4)"
                                      [class.text-success]="isTabCompleted(4)"
                                      [class.text-danger]="currentTab > 4 && !isTabCompleted(4)"
                                      [class.text-primary]="isTabActive(4)">
                                    {{ 'DIST_SITE.TAB2_TITLE' | translate }}
                                </span>
                                <small class="d-block text-muted step-description">{{ 'DIST_SITE.PARTNERS_OPTIONAL_SHORT' | translate }}</small>
                            </div>
                        </div>
                        
                        <!-- Tab 5: Attachments -->
                        <div class="step-navigation-item">
                            <div class="step-container" 
                                 [class.active]="isTabActive(5)" 
                                 [class.completed]="isTabCompleted(5)"
                                 [class.invalid]="currentTab === 5 && !isTabCompleted(5)">
                                <div class="step-bg"></div>
                                <div class="step">
                                    <span *ngIf="!isTabCompleted(5)">5</span>
                                    <i *ngIf="isTabCompleted(5)" class="fas fa-check"></i>
                                </div>
                            </div>
                            <div class="step-content-wrapper">
                                <span class="step-title" 
                                      (click)="goToTab(5)"
                                      [class.text-success]="isTabCompleted(5)"
                                      [class.text-danger]="currentTab === 5 && !isTabCompleted(5)"
                                      [class.text-primary]="isTabActive(5)">
                                    {{ 'DIST_SITE.TAB3_TITLE' | translate }}
                                </span>
                                <small class="d-block text-muted step-description">{{ 'DIST_SITE.ATTACHMENTS_DESC' | translate }}</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Content Area -->
                <div class="col-lg-9 mb-4">
                    <div class="main-container h-100">
                        
                        <!-- Tab 1: Main Information Content -->
                        <div *ngIf="currentTab === 1" class="step-content">
                            <h5 class="mb-4">{{ 'DIST_SITE.MAIN_INFO' | translate }}</h5>
                            
                            <!-- Validation Status Indicator
                            <div class="alert" [class.alert-success]="isCurrentTabValid()" [class.alert-warning]="!isCurrentTabValid()" class="mb-3">
                                <strong>{{ 'VALIDATION.TAB_STATUS' | translate }}:</strong>
                                <span *ngIf="isCurrentTabValid()" class="text-success">{{ 'VALIDATION.ALL_REQUIRED_FIELDS_COMPLETED' | translate }}</span>
                                <span *ngIf="!isCurrentTabValid()" class="text-warning">{{ 'VALIDATION.PLEASE_COMPLETE_REQUIRED_FIELDS' | translate }}</span>
                            </div>
                             -->
                            <form [formGroup]="mainInfoForm">
                                <div class="row">
                                    <!-- Request Type Dropdown -->
                                    <div class="col-xl-6 mb-4">
                                        <label class="form-label">{{ 'DIST_SITE.REQUEST_TYPE' | translate }} <span class="text-danger">*</span></label>
                                        
                                        <ng-select 
                                            formControlName="locationTypeId"
                                            [placeholder]="'COMMON.SELECT_OPTION' | translate"
                                            [bindLabel]="getBindLabelField()"
                                            bindValue="id"
                                            [items]="distributionLocationTypes"
                                            [clearable]="true"
                                            (change)="onLocationTypeChange($event)"
                                            (ngModelChange)="onLocationTypeChange($event)"
                                            [class.is-invalid]="isFieldInvalid('locationTypeId')"
                                            [class.is-valid]="isFieldValid('locationTypeId')">
                                        </ng-select>
                                        <div *ngIf="isFieldInvalid('locationTypeId')" class="invalid-feedback d-block">
                                            {{ 'VALIDATION.REQUIRED_FIELD' | translate }}
                                        </div>
                                    </div>

                                    <!-- Owner Name -->
                                    <!-- <div class="col-xl-6 mb-4">
                                        <label class="form-label">{{ 'DIST_SITE.OWNER_NAME' | translate }}</label>
                                        <input type="text" class="form-control" formControlName="ownerName"
                                               [placeholder]="'DIST_SITE.OWNER_NAME_PLACEHOLDER' | translate">
                                    </div> -->

                                    <!-- Region Name -->
                                    <div class="col-xl-6 mb-4">
                                        <label class="form-label">{{ 'DIST_SITE.REGION_NAME' | translate }} <span class="text-danger">*</span></label>
                                        <ng-select 
                                            formControlName="regionName"
                                            [placeholder]="'COMMON.SELECT_OPTION' | translate"
                                            bindLabel="text"
                                            bindValue="text"
                                            [items]="regionOptions"
                                            [clearable]="true"
                                            [class.is-invalid]="isFieldInvalid('regionName')"
                                            [class.is-valid]="isFieldValid('regionName')">
                                        </ng-select>
                                        <div *ngIf="isFieldInvalid('regionName')" class="invalid-feedback d-block">
                                            {{ 'VALIDATION.REQUIRED_FIELD' | translate }}
                                        </div>
                                    </div>

                                    <!-- Street Name -->
                                    <div class="col-xl-6 mb-4">
                                        <label class="form-label">{{ 'DIST_SITE.STREET_NAME' | translate }} <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" formControlName="streetName"
                                               [placeholder]="'DIST_SITE.STREET_NAME_PLACEHOLDER' | translate"
                                               [class.is-invalid]="isFieldInvalid('streetName')"
                                               [class.is-valid]="isFieldValid('streetName')">
                                        <div *ngIf="isFieldInvalid('streetName')" class="invalid-feedback">
                                            {{ 'VALIDATION.REQUIRED_FIELD' | translate }}
                                        </div>
                                    </div>

                                    <!-- Ground Number -->
                                    <!-- <div class="col-xl-6 mb-4">
                                        <label class="form-label">{{ 'DIST_SITE.GROUND_NO' | translate }}</label>
                                        <input type="text" class="form-control" formControlName="groundNo"
                                               [placeholder]="'DIST_SITE.GROUND_NO_PLACEHOLDER' | translate">
                                    </div> -->

                                    <!-- Address -->
                                    <div class="col-xl-6 mb-4">
                                        <label class="form-label">{{ 'DIST_SITE.ADDRESS' | translate }}</label>
                                        <input type="text" class="form-control" formControlName="address"
                                               [placeholder]="'DIST_SITE.ADDRESS_PLACEHOLDER' | translate">
                                    </div>

                                    <!-- Notes -->
                                    <div class="col-xl-12 mb-4">
                                        <label class="form-label">{{ 'DIST_SITE.NOTES' | translate }}</label>
                                        <textarea class="form-control" formControlName="notes" rows="3"
                                                  [placeholder]="'DIST_SITE.NOTES_PLACEHOLDER' | translate"></textarea>
                                    </div>

                                    <!-- Map Section for Location Selection -->
                                    <div class="col-xl-12 mb-4">
                                        <label class="form-label">{{ 'DIST_SITE.SELECT_LOCATION_ON_MAP' | translate }} <span class="text-danger">*</span></label>
                                        <div id="distributionMap" style="height: 400px; border: 1px solid #ddd; border-radius: 4px;"
                                             [class.border-danger]="!selectedCoordinates && (currentTab > 1 || submitted)"
                                             [class.border-success]="selectedCoordinates"></div>
                                        <small class="text-muted d-block mt-2">
                                            {{ 'DIST_SITE.MAP_INSTRUCTIONS' | translate }}
                                        </small>
                                        <div *ngIf="!selectedCoordinates && (currentTab > 1 || submitted)" class="text-danger small mt-1">
                                            {{ 'VALIDATION.LOCATION_REQUIRED' | translate }}
                                        </div>
                                        
                                        <!-- Selected Coordinates Display -->
                                        <div *ngIf="selectedCoordinates" class="mt-2">
                                            <small class="text-success">
                                                <i class="fas fa-map-marker-alt"></i>
                                                {{ 'DIST_SITE.SELECTED_COORDINATES' | translate }}: {{ selectedCoordinates }}
                                            </small>
                                        </div>
                                    </div>

                                    <!-- Distribution Site Coordinators (Selected Coordinates) Field -->
                                    <div class="col-xl-12 mb-4">
                                        <label class="form-label">{{ 'DIST_SITE.SELECTED_COORDINATES' | translate }}</label>
                                        <input type="text" class="form-control" formControlName="distributionSiteCoordinators" readonly>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- Tab 2: Date Details Content -->
                        <div *ngIf="currentTab === 2" class="step-content">
                            <h5 class="mb-4">{{ 'DIST_SITE.DATE_DETAILS' | translate }}</h5>
                            
                            <!-- Validation Status Indicator
                            <div class="alert" [class.alert-success]="isCurrentTabValid()" [class.alert-warning]="!isCurrentTabValid()" class="mb-3">
                                <strong>{{ 'VALIDATION.TAB_STATUS' | translate }}:</strong>
                                <span *ngIf="isCurrentTabValid()" class="text-success">{{ 'VALIDATION.ALL_REQUIRED_FIELDS_COMPLETED' | translate }}</span>
                                <span *ngIf="!isCurrentTabValid()" class="text-warning">{{ 'VALIDATION.PLEASE_COMPLETE_REQUIRED_FIELDS' | translate }}</span>
                            </div> -->
                            
                            <form [formGroup]="mainInfoForm">
                                <div class="row">
                                    <!-- Start Date -->
                                    <div class="col-xl-6 mb-4">
                                        <label class="form-label">{{ 'DIST_SITE.START_DATE' | translate }} <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control" formControlName="startDate"
                                               [class.is-invalid]="isFieldInvalid('startDate')"
                                               [class.is-valid]="isFieldValid('startDate')">
                                        <div *ngIf="isFieldInvalid('startDate')" class="invalid-feedback">
                                            {{ 'VALIDATION.REQUIRED_FIELD' | translate }}
                                        </div>
                                        <div *ngIf="isStartDatePast()" class="text-danger small mt-1">
                                            {{ 'VALIDATION.START_DATE_PAST' | translate }}
                                        </div>
                                    </div>
                                    <!-- End Date -->
                                    <div class="col-xl-6 mb-4">
                                        <label class="form-label">{{ 'DIST_SITE.END_DATE' | translate }} <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control" formControlName="endDate"
                                               [class.is-invalid]="isFieldInvalid('endDate')"
                                               [class.is-valid]="isFieldValid('endDate')">
                                        <!-- <div *ngIf="isFieldInvalid('endDate')" class="invalid-feedback">
                                            {{ 'VALIDATION.REQUIRED_FIELD' | translate }}
                                        </div>
                                        <div *ngIf="isEndDateBeforeStart()" class="text-danger small mt-1">
                                            {{ 'VALIDATION.END_DATE_BEFORE_START' | translate }}
                                        </div> -->
                                        <div *ngIf="mainInfoForm.get('endDate')?.invalid && (mainInfoForm.get('endDate')?.touched || submitted)"
                                            class="invalid-feedback">
                                            {{ 'VALIDATION.REQUIRED_FIELD' | translate }}
                                        </div>
                                        <div *ngIf="isEndDateBeforeStart() || invalidEndDate" class="text-danger small mt-1">
                                            {{ 'VALIDATION.END_DATE_BEFORE_START' | translate }}
                                        </div>
                                    </div>



                                </div>
                            </form>
                        </div>

                        <!-- Tab 3: Supervisor Information Content -->
                        <div *ngIf="currentTab === 3" class="step-content">
                            <h5 class="mb-4">{{ 'DIST_SITE.SUPERVISOR_INFO' | translate }}</h5>
                            
                            <!-- Validation Status Indicator
                            <div class="alert" [class.alert-success]="isCurrentTabValid()" [class.alert-warning]="!isCurrentTabValid()" class="mb-3">
                                <strong>{{ 'VALIDATION.TAB_STATUS' | translate }}:</strong>
                                <span *ngIf="isCurrentTabValid()" class="text-success">{{ 'VALIDATION.ALL_REQUIRED_FIELDS_COMPLETED' | translate }}</span>
                                <span *ngIf="!isCurrentTabValid()" class="text-warning">{{ 'VALIDATION.PLEASE_COMPLETE_REQUIRED_FIELDS' | translate }}</span>
                            </div> -->
                            
                            <form [formGroup]="mainInfoForm">
                                <div class="row">
                                    <!-- Supervisor Name -->
                                    <div class="col-xl-6 mb-4">
                                        <label class="form-label">{{ 'DIST_SITE.SUPERVISOR_NAME' | translate }} <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" formControlName="supervisorName"
                                               [placeholder]="'DIST_SITE.SUPERVISOR_NAME_PLACEHOLDER' | translate"
                                               [class.is-invalid]="isFieldInvalid('supervisorName')"
                                               [class.is-valid]="isFieldValid('supervisorName')">
                                        <div *ngIf="isFieldInvalid('supervisorName')" class="invalid-feedback">
                                            {{ 'VALIDATION.REQUIRED_FIELD' | translate }}
                                        </div>
                                    </div>
                                    <!-- Job Title -->
                                    <div class="col-xl-6 mb-4">
                                        <label class="form-label">{{ 'DIST_SITE.JOB_TITLE' | translate }}</label>
                                        <input type="text" class="form-control" formControlName="jopTitle"
                                               [placeholder]="'DIST_SITE.JOB_TITLE_PLACEHOLDER' | translate">
                                    </div>
                                    <!-- Supervisor Mobile -->
                                    <div class="col-xl-6 mb-4">
                                        <label class="form-label">{{ 'DIST_SITE.SUPERVISOR_MOBILE' | translate }} <span class="text-danger">*</span></label>
                                        
                                        <!-- Mobile Number Input with UAE Flag and 971 prefix -->
                                        <div class="mobile-input-container" style="border : none !important;" [class.is-invalid]="(submitted || mainInfoForm.get('supervisorMobile')?.touched) && mainInfoForm.get('supervisorMobile')?.errors">
                                            <div class="mobile-prefix-container">
                                                <img src="assets/images/Flag_of_the_United_Arab_Emirates.svg.png" alt="UAE Flag" class="uae-flag-image">
                                                <span class="mobile-prefix">971</span>
                                            </div>
                                            <input 
                                                type="tel" 
                                                class="form-control mobile-number-input" 
                                                formControlName="supervisorMobile"
                                                placeholder="565666666"
                                                maxlength="9"
                                                (keypress)="restrictMobileInput($event)"
                                                (input)="onSupervisorMobileInput()"
                                                (blur)="onSupervisorMobileBlur()">
                                        </div>
                                        
                                        <div *ngIf="(submitted || mainInfoForm.get('supervisorMobile')?.touched) && mainInfoForm.get('supervisorMobile')?.errors" class="invalid-feedback">
                                            <div *ngIf="mainInfoForm.get('supervisorMobile')?.hasError('required')">
                                                {{ 'VALIDATION.REQUIRED_FIELD' | translate }}
                                            </div>
                                            <div *ngIf="mainInfoForm.get('supervisorMobile')?.hasError('pattern')">
                                                {{ 'VALIDATION.INVALID_PHONE_FORMAT' | translate }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- Tab 4: Partners Content -->
                        <div *ngIf="currentTab === 4" class="step-content">
                            <h5 class="mb-4">{{ 'DIST_SITE.PARTNERS' | translate }}</h5>
                            
                            <!-- Info Alert -->
                            <!-- <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle"></i>
                                <strong>{{ 'DISTRIBUTION_SITE.PARTNERS_OPTIONAL' | translate }}:</strong>
                                {{ 'DISTRIBUTION_SITE.PARTNERS_OPTIONAL_DESC' | translate }}
                            </div> -->
                            
                            <!-- Partner Form -->
                             <form [formGroup]="partnersForm">
                                <div class="row">

                                    <!-- Partner Name -->
                                    <div class="col-xl-6 mb-3">
                                        <label class="form-label">
                                            {{ 'FASTING_TENT_REQ.PARTNER_NAME' | translate }} <span
                                                class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" formControlName="name" maxlength="200">
                                        <div class="form-text text-danger"
                                            *ngIf="partnersForm.get('name')?.touched && partnersForm.get('name')?.errors as e">
                                            <div *ngIf="e['required']">{{ 'VALIDATION.REQUIRED_FIELD' | translate }}
                                            </div>
                                            <div *ngIf="e['maxlength']">{{ 'VALIDATION.MAX_LENGTH_EXCEEDED' | translate
                                                }} (<= 200)</div>
                                            </div>
                                        </div>

                                        <!-- Partner Type -->
                                        <div class="col-xl-6 mb-3">
                                            <label class="form-label">
                                                {{ 'FASTING_TENT_REQ.PARTNER_TYPE' | translate }} <span
                                                    class="text-danger">*</span>
                                            </label>
                                            <ng-select formControlName="type"
                                                [placeholder]="'COMMON.SELECT_OPTION' | translate" bindLabel="label"
                                                bindValue="id" [items]="partnerTypes" [clearable]="true"
                                                (change)="onPartnerTypeChange()">
                                            </ng-select>
                                            <div class="form-text text-danger"
                                                *ngIf="partnersForm.get('type')?.touched && partnersForm.get('type')?.errors?.['required']">
                                                {{ 'VALIDATION.REQUIRED_FIELD' | translate }}
                                            </div>
                                        </div>

                                        <!-- License Issuer -->
                                        <div class="col-xl-6 mb-3">
                                            <label class="form-label">
                                                {{ 'FASTING_TENT_REQ.LICENSE_ISSUER' | translate }}
                                                <span *ngIf="isSupplierOrCompany(partnersForm.get('type')?.value)"
                                                    class="text-danger">*</span>
                                            </label>
                                            <input type="text" class="form-control" formControlName="licenseIssuer"
                                                maxlength="200">
                                            <!-- required (شرطي) للمورد/الشركة -->
                                            <div class="form-text text-danger" *ngIf="isSupplierOrCompany(partnersForm.get('type')?.value)
                  && !partnersForm.get('licenseIssuer')?.value
                  && partnersForm.get('licenseIssuer')?.touched">
                                                {{ 'VALIDATION.REQUIRED_FIELD' | translate }}
                                            </div>
                                            <!-- maxlength -->
                                            <div class="form-text text-danger"
                                                *ngIf="partnersForm.get('licenseIssuer')?.touched && partnersForm.get('licenseIssuer')?.errors?.['maxlength']">
                                                {{ 'VALIDATION.MAX_LENGTH_EXCEEDED' | translate }} (<= 200) </div>
                                            </div>

                                            <!-- License Expiry Date -->
                                            <div class="col-xl-6 mb-3">
                                                <label class="form-label">
                                                    {{ 'FASTING_TENT_REQ.LICENSE_EXPIRY_DATE' | translate }}
                                                    <span *ngIf="isSupplierOrCompany(partnersForm.get('type')?.value)"
                                                        class="text-danger">*</span>
                                                </label>
                                                <input type="date" class="form-control"
                                                    formControlName="licenseExpiryDate">
                                                <div class="form-text text-danger" *ngIf="isSupplierOrCompany(partnersForm.get('type')?.value)
                  && !partnersForm.get('licenseExpiryDate')?.value
                  && partnersForm.get('licenseExpiryDate')?.touched">
                                                    {{ 'VALIDATION.REQUIRED_FIELD' | translate }}
                                                </div>
                                            </div>

                                            <!-- License Number -->
                                            <div class="col-xl-6 mb-3">
                                                <label class="form-label">
                                                    {{ 'FASTING_TENT_REQ.LICENSE_NUMBER' | translate }}
                                                    <span *ngIf="isSupplierOrCompany(partnersForm.get('type')?.value)"
                                                        class="text-danger">*</span>
                                                </label>
                                                <input type="text" class="form-control" formControlName="licenseNumber"
                                                    maxlength="100">
                                                <!-- required (شرطي) للمورد/الشركة -->
                                                <div class="form-text text-danger" *ngIf="isSupplierOrCompany(partnersForm.get('type')?.value)
                                                        && !partnersForm.get('licenseNumber')?.value
                                                        && partnersForm.get('licenseNumber')?.touched">
                                                    {{ 'VALIDATION.REQUIRED_FIELD' | translate }}
                                                </div>
                                                <!-- maxlength -->
                                                <div class="form-text text-danger"
                                                    *ngIf="partnersForm.get('licenseNumber')?.touched && partnersForm.get('licenseNumber')?.errors?.['maxlength']">
                                                    {{ 'VALIDATION.MAX_LENGTH_EXCEEDED' | translate }} (<= 100) </div>
                                                </div>

                                                <!-- Contact Details -->
                                                <div class="col-xl-6 mb-3">
                                                    <label class="form-label">
                                                        {{ 'FASTING_TENT_REQ.CONTACT_DETAILS' | translate }}
                                                    </label>
                                                    <input type="text" class="form-control"
                                                        formControlName="contactDetails" maxlength="1000">
                                                    <div class="form-text text-danger"
                                                        *ngIf="partnersForm.get('contactDetails')?.touched && partnersForm.get('contactDetails')?.errors?.['maxlength']">
                                                        {{ 'VALIDATION.MAX_LENGTH_EXCEEDED' | translate }}{{' (= 1000)'}}
                                                            </div>
                                                </div>

                                                <div class="col-xl-12 mb-3">
                                                    <label class="form-label">
                                                        {{ 'FASTING_TENT_REQ.jobRequirementsDetails' | translate }}
                                                    </label>
                                                    <input type="text" class="form-control"
                                                        formControlName="jobRequirementsDetails" >
                                                    
                                                </div>


                                                    <!-- Partner Attachments Section -->
                                                    <div *ngIf="showPartnerAttachments" class="col-xl-12 mb-4">
                                                        <div class="table-responsive">
                                                            <table class="table table-striped">
                                                                <thead>
                                                                    <tr>
                                                                        <th>{{ 'ATTACHMENTS.DOCUMENT_TYPE' | translate
                                                                            }}</th>
                                                                        <th>{{ 'ATTACHMENTS.FILE' | translate }}</th>
                                                                        <th>{{ 'COMMON.ACTIONS' | translate }}</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    <tr
                                                                        *ngFor="let config of getPartnerAttachmentConfigsForType(partnersForm.get('type')?.value); let i = index">
                                                                        <td>
                                                                            {{ getAttachmentName(config) }}
                                                                            <span *ngIf="config.mendatory"
                                                                                class="text-danger ms-1">*</span>
                                                                        </td>
                                                                        <td>
                                                                            <div *ngIf="!partnerSelectedFiles[partnersForm.get('type')?.value]?.[config.id!]"
                                                                                class="upload-area"
                                                                                (dragover)="onPartnerDragOver($event)"
                                                                                (dragleave)="onPartnerDragLeave($event)"
                                                                                (drop)="onPartnerDrop($event, config.id!, partnersForm.get('type')?.value)"
                                                                                [class.drag-over]="isDragOver"
                                                                                [class.border-danger]="config.mendatory && partnersForm.get('type')?.value && !partnerSelectedFiles[partnersForm.get('type')?.value][config.id!] && (currentTab === 4 || submitted)"
                                                                                [class.border-success]="partnerSelectedFiles[partnersForm.get('type')?.value][config.id!]">
                                                                                <input type="file" class="d-none"
                                                                                    [id]="'partner-file-' + partnersForm.get('type')?.value + '-' + config.id"
                                                                                    (change)="onPartnerFileSelected($event, config.id!, partnersForm.get('type')?.value)"
                                                                                    accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                                                                                <label
                                                                                    [for]="'partner-file-' + partnersForm.get('type')?.value + '-' + config.id"
                                                                                    class="upload-label">
                                                                                    <i
                                                                                        class="fas fa-cloud-upload-alt mb-2"></i>
                                                                                    <div>{{
                                                                                        'ATTACHMENTS.DRAG_DROP_OR_CLICK'
                                                                                        | translate }}</div>
                                                                                    <small class="text-muted">{{
                                                                                        'ATTACHMENTS.SUPPORTED_FORMATS'
                                                                                        | translate }}</small>
                                                                                </label>
                                                                            </div>

                                                                            <div *ngIf="partnerSelectedFiles[partnersForm.get('type')?.value][config.id!]"
                                                                                class="uploaded-file">
                                                                                <div class="d-flex align-items-center">
                                                                                    <i
                                                                                        class="fas fa-file me-2 text-success"></i>
                                                                                    <span class="file-name">{{
                                                                                        partnerSelectedFiles[partnersForm.get('type')?.value][config.id!].name
                                                                                        }}</span>
                                                                                </div>
                                                                                <div *ngIf="partnerFilePreviews[partnersForm.get('type')?.value][config.id!]"
                                                                                    class="mt-2">
                                                                                    <img [src]="partnerFilePreviews[partnersForm.get('type')?.value][config.id!]"
                                                                                        class="img-thumbnail"
                                                                                        style="max-height: 100px; max-width: 100px;"
                                                                                        *ngIf="partnerSelectedFiles[partnersForm.get('type')?.value][config.id!].type.startsWith('image/')"
                                                                                        [alt]="partnerSelectedFiles[partnersForm.get('type')?.value][config.id!].name">
                                                                                </div>
                                                                            </div>
                                                                        </td>
                                                                        <td>
                                                                            <button
                                                                                *ngIf="partnerSelectedFiles[partnersForm.get('type')?.value][config.id!]"
                                                                                type="button"
                                                                                class="btn btn-sm btn-danger"
                                                                                (click)="removePartnerFile(config.id!, partnersForm.get('type')?.value)">
                                                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                                                    width="24" height="24"
                                                                                    viewBox="0 0 24 24" fill="none">
                                                                                    <path
                                                                                        d="M21 4H17.9C17.6679 2.87141 17.0538 1.85735 16.1613 1.12872C15.2687 0.40009 14.1522 0.00145452 13 0H11C9.8478 0.00145452 8.73132 0.40009 7.83875 1.12872C6.94618 1.85735 6.3321 2.87141 6.1 4H3C2.73478 4 2.48043 4.10536 2.29289 4.29289C2.10536 4.48043 2 4.73478 2 5C2 5.26522 2.10536 5.51957 2.29289 5.70711C2.48043 5.89464 2.73478 6 3 6H4V19C4.00159 20.3256 4.52888 21.5964 5.46622 22.5338C6.40356 23.4711 7.67441 23.9984 9 24H15C16.3256 23.9984 17.5964 23.4711 18.5338 22.5338C19.4711 21.5964 19.9984 20.3256 20 19V6H21C21.2652 6 21.5196 5.89464 21.7071 5.70711C21.8946 5.51957 22 5.26522 22 5C22 4.73478 21.8946 4.48043 21.7071 4.29289C21.5196 4.10536 21.2652 4 21 4ZM11 2H13C13.6203 2.00076 14.2251 2.19338 14.7316 2.55144C15.2381 2.90951 15.6214 3.41549 15.829 4H8.171C8.37858 3.41549 8.7619 2.90951 9.26839 2.55144C9.77487 2.19338 10.3797 2.00076 11 2ZM18 19C18 19.7956 17.6839 20.5587 17.1213 21.1213C16.5587 21.6839 15.7956 22 15 22H9C8.20435 22 7.44129 21.6839 6.87868 21.1213C6.31607 20.5587 6 19.7956 6 19V6H18V19Z"
                                                                                        fill="#5B5B5B" />
                                                                                    <path
                                                                                        d="M10 18C10.2652 18 10.5196 17.8946 10.7071 17.7071C10.8946 17.5196 11 17.2652 11 17V11C11 10.7348 10.8946 10.4804 10.7071 10.2929C10.5196 10.1054 10.2652 10 10 10C9.73478 10 9.48043 10.1054 9.29289 10.2929C9.10536 10.4804 9 10.7348 9 11V17C9 17.2652 9.10536 17.5196 9.29289 17.7071C9.48043 17.8946 9.73478 18 10 18Z"
                                                                                        fill="#5B5B5B" />
                                                                                    <path
                                                                                        d="M14 18C14.2652 18 14.5196 17.8946 14.7071 17.7071C14.8947 17.5196 15 17.2652 15 17V11C15 10.7348 14.8947 10.4804 14.7071 10.2929C14.5196 10.1054 14.2652 10 14 10C13.7348 10 13.4804 10.1054 13.2929 10.2929C13.1054 10.4804 13 10.7348 13 11V17C13 17.2652 13.1054 17.5196 13.2929 17.7071C13.4804 17.8946 13.7348 18 14 18Z"
                                                                                        fill="#5B5B5B" />
                                                                                </svg>
                                                                                {{ 'COMMON.REMOVE' | translate }}
                                                                            </button>
                                                                        </td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>

                                                    <div class="col-xl-12 mb-4">
                                                        <button type="button" class="btn btn-primary"
                                                            (click)="addPartner()">
                                                            {{ 'FASTING_TENT_REQ.ADD_PARTNER' | translate }}
                                                        </button>
                                                    </div>
                                                </div>
                            </form>

                            <!-- Partners Table -->
                            <div *ngIf="partners.length > 0" class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>{{ 'DIST_SITE.PARTNER_NAME' | translate }}</th>
                                            <th>{{ 'DIST_SITE.PARTNER_TYPE' | translate }}</th>
                                            <th>{{ 'DIST_SITE.LICENSE_ISSUER' | translate }}</th>
                                            <th>{{ 'DIST_SITE.LICENSE_NUMBER' | translate }}</th>
                                            <th>{{ 'DIST_SITE.CONTACT_DETAILS' | translate }}</th>
                                            <th>{{ 'COMMON.ACTIONS' | translate }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let partner of partners; let i = index">
                                            <td>{{ partner.name }}</td>
                                            <td>{{ getPartnerTypeName(partner.type) }}</td>
                                            <td>{{ partner.licenseIssuer || '-' }}</td>
                                            <td>{{ partner.licenseNumber || '-' }}</td>
                                            <td>{{ partner.contactDetails || '-' }}</td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-danger" (click)="removePartner(i)">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div *ngIf="partners.length === 0" class="alert alert-info">
                                {{ 'DIST_SITE.NO_PARTNERS_ADDED' | translate }}
                            </div>
                        </div>

                        <!-- Tab 5: Attachments Content -->
                        <div *ngIf="currentTab === 5" class="step-content">
                            <h5 class="mb-4">{{ 'DIST_SITE.ATTACHMENTS' | translate }}</h5>
                            
                            <!-- Validation Status Indicator -->
                            <!-- <div class="alert" [class.alert-success]="isCurrentTabValid()" [class.alert-warning]="!isCurrentTabValid()" class="mb-3">
                                <strong>{{ 'VALIDATION.TAB_STATUS' | translate }}:</strong>
                                <span *ngIf="isCurrentTabValid()" class="text-success">{{ 'VALIDATION.ALL_REQUIRED_ATTACHMENTS_UPLOADED' | translate }}</span>
                                <span *ngIf="!isCurrentTabValid()" class="text-warning">{{ 'VALIDATION.PLEASE_UPLOAD_REQUIRED_ATTACHMENTS' | translate }}</span>
                            </div>
                             -->
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>{{ 'ATTACHMENTS.DOCUMENT_TYPE' | translate }}</th>
                                            <th>{{ 'ATTACHMENTS.FILE' | translate }}</th>
                                            <th>{{ 'COMMON.ACTIONS' | translate }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let config of attachmentConfigs; let i = index">
                                            <td>
                                                {{ getAttachmentName(config) }}
                                                <span *ngIf="isAttachmentMandatory(config.id!)" class="text-danger ms-1">*</span>
                                                <div *ngIf="isAttachmentMandatory(config.id!) && selectedFiles[config.id!]" class="text-success small">
                                                    <i class="fas fa-check-circle"></i> {{ 'VALIDATION.UPLOADED' | translate }}
                                                </div>
                                            </td>
                                            <td>
                                                <div *ngIf="!selectedFiles[config.id!]" class="upload-area"
                                                     (dragover)="onDragOver($event)"
                                                     (dragleave)="onDragLeave($event)"
                                                     (drop)="onDrop($event, config.id!)"
                                                     [class.drag-over]="isDragOver"
                                                     [class.border-danger]="isAttachmentMandatory(config.id!) && !selectedFiles[config.id!] && (currentTab === 5 || submitted)"
                                                     [class.border-success]="selectedFiles[config.id!]">
                                                    <input type="file" 
                                                           class="d-none" 
                                                           [id]="'file-' + config.id"
                                                           (change)="onFileSelected($event, config.id!)"
                                                           accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                                                    <label [for]="'file-' + config.id" class="upload-label">
                                                        <i class="fas fa-cloud-upload-alt"></i>
                                                        <span>{{ 'ATTACHMENTS.DRAG_DROP_OR_CLICK' | translate }}</span>
                                                    </label>
                                                </div>
                                                <div *ngIf="selectedFiles[config.id!]" class="file-preview">
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-file me-2"></i>
                                                        <div>
                                                            <span class="file-name">{{ selectedFiles[config.id!].name }}</span>
                                                            <small class="text-muted d-block">{{ (selectedFiles[config.id!].size / 1024).toFixed(1) }} KB</small>
                                                        </div>
                                                    </div>
                                                    <img *ngIf="filePreviews[config.id!] && selectedFiles[config.id!].type.startsWith('image/')" 
                                                         [src]="filePreviews[config.id!]" 
                                                         class="preview-image mt-2"
                                                         style="max-width: 200px; max-height: 100px; border-radius: 4px;">
                                                </div>
                                                <div *ngIf="isAttachmentMandatory(config.id!) && !selectedFiles[config.id!] && (currentTab === 5 || submitted)" class="text-danger small mt-1">
                                                    <i class="fas fa-exclamation-triangle"></i> {{ 'VALIDATION.ATTACHMENT_REQUIRED' | translate }}
                                                </div>
                                            </td>
                                            <td>
                                                <button *ngIf="selectedFiles[config.id!]" 
                                                        type="button" 
                                                        class="btn btn-sm btn-danger" 
                                                        (click)="removeFile(config.id!)">
                                                    <i class="fas fa-trash"></i> {{ 'COMMON.REMOVE' | translate }}
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Navigation Buttons: update for 5 tabs -->
                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" 
                                    class="btn btn-secondary" 
                                    (click)="previousTab()" 
                                    [disabled]="currentTab === 1">
                                <i class="fas fa-arrow-left"></i> {{ 'COMMON.PREVIOUS' | translate }}
                            </button>
                            
                            <!-- Next Button -->
                            <div *ngIf="currentTab < totalTabs" class="d-flex align-items-center">
                                <!-- <div *ngIf="!isCurrentTabValid()" class="me-3">
                                    <small class="text-warning">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        {{ 'VALIDATION.COMPLETE_REQUIRED_FIELDS_TO_CONTINUE' | translate }}
                                    </small>
                                </div> -->
                                <button type="button" 
                                        class="btn" 
                                        [class.btn-primary]="isCurrentTabValid()"
                                        [class.btn-outline-secondary]="!isCurrentTabValid()"
                                        (click)="nextTab()" 
                                        [disabled]="!canProceedToNext()">
                                    {{ 'COMMON.NEXT' | translate }} <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                            
                            <!-- Submit Button -->
                            <div *ngIf="currentTab === totalTabs" class="d-flex align-items-center">
                                <div *ngIf="!canSubmit()" class="me-3">
                                    <small class="text-warning">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        {{ 'VALIDATION.COMPLETE_ALL_REQUIRED_FIELDS_TO_SUBMIT' | translate }}
                                    </small>
                                </div>
                                <button type="button" 
                                        class="btn"
                                        [class.btn-success]="canSubmit()"
                                        [class.btn-outline-secondary]="!canSubmit()"
                                        (click)="onSubmit()" 
                                        [disabled]="!canSubmit() || isSaving">
                                    <span *ngIf="isSaving" class="spinner-border spinner-border-sm me-2"></span>
                                    <i *ngIf="!isSaving" class="fas fa-paper-plane me-2"></i>
                                    {{ 'COMMON.SUBMIT' | translate }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
