<div class="view-fasting-tent-request-container">
  <section>
    <div class="container services">

      <!-- Loading state -->
      <div *ngIf="isLoading" class="text-center py-5">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">{{ 'COMMON.LOADING' | translate }}</span>
        </div>
        <p class="mt-3">{{ 'COMMON.LOADING_DATA' | translate }}</p>
      </div>


        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="#">Requests</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ 'VIEW_FASTING_TENT.VIEW_TITLE' | translate }}</li>
          </ol>
        </nav>
      <!-- Main Content -->
      <div *ngIf="!isLoading && mainApplyService">


        <div class="service-info-card mb-4">
        

          <div class="w-100">
            <div class="d-flex align-items-center justify-content-between gap-3 mb-2">
              <h4 class="title mb-2">{{ 'VIEW_FASTING_TENT.VIEW_TITLE' | translate }}</h4>
              <button *ngIf="targetWorkFlowStep" type="button" class="btn btn-gold" data-bs-toggle="modal"
                data-bs-target="#commentModal">
                <i class="fas fa-plus me-2"></i>
                {{ 'COMMON.ADD_COMMENT' | translate }}
              </button>
            </div>
            <div class="row">
              <div class="col-xl-6">
                <p class="mb-1"><strong>{{ 'COMMON.APPLICATION_NO' | translate }}:</strong> {{mainApplyService.applyNo}}
                </p>
              </div>
              <div class="col-xl-6">
                <p class="mb-1"><strong>{{ 'COMMON.APPLICATION_DATE' | translate }}:</strong>
                  {{formatDate(mainApplyService.applyDate)}}</p>
              </div>
              <div class="col-xl-6" *ngIf="mainApplyService.permitNumber">
                <p class="mb-0">
                  <strong>{{ 'COMMON.PERMIT_NUMBER' | translate }}: </strong>
                  {{mainApplyService.permitNumber}}
                </p>
              </div>
              <div class="col-xl-6">
                <span class="badge bg-primary">{{mainApplyService.lastStatus}}</span>
              </div>
            </div>
          </div>


        </div>

        <div class="row">
          <!-- Sidebar: Workflow Timeline -->
          <div class="col-lg-3 mb-4">
            <div class="main-container h-100">
              <h6 class="fw-bold mb-3 text-primary">
                <i class="fas fa-route me-2"></i>
                {{ 'WORKFLOW.PROCESS_STEPS' | translate }}
              </h6>

              <div class="workflow-timeline" *ngIf="workFlowSteps && workFlowSteps.length > 0">
                <div *ngFor="let step of workFlowSteps; let i = index; trackBy: trackByStepId"
                  class="workflow-step-item" [class.completed]="isStepCompleted(step.serviceStatus)"
                  [class.rejected]="isStepRejected(step.serviceStatus)"
                  [class.pending]="isStepPending(step.serviceStatus)"
                  [class.last-step]="i === workFlowSteps.length - 1">

                  <!-- Step Circle with Icon -->
                  <div class="step-circle" [style.background-color]="getStatusColor(step.serviceStatus)"
                    [style.border-color]="getStatusColor(step.serviceStatus)">
                    <i [class]="getStatusIcon(step.serviceStatus)"></i>
                  </div>

                  <!-- Connecting Line -->
                  <div class="step-line" *ngIf="i < workFlowSteps.length - 1"
                    [class.completed-line]="isStepCompleted(step.serviceStatus)"></div>

                  <!-- Step Content -->
                  <div>
                    <div class="step-header">
                      <div class="step-number">{{ 'WORKFLOW.STEP' | translate }} {{step.stepOrder}}</div>
                      <div class="step-status" [style.color]="getStatusColor(step.serviceStatus)">
                        <i [class]="getStatusIcon(step.serviceStatus)" class="me-1"></i>
                        {{step.serviceStatusName || (getStatusLabel(step.serviceStatus) | translate)}}
                      </div>
                    </div>
                    <h6 class="department-name">{{step.departmentName}}</h6>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <!-- Content Area -->
          <div class="col-lg-9 mb-4">
            <div class="main-container mb-4">

              <!-- Section: Basic Information -->

              <div class="step-content mb-4">
                <h5 class="mb-3 gold">{{ 'VIEW_FASTING_TENT.BASIC_INFORMATION' | translate }}</h5>

                <div class="row" *ngIf="fastingTentService">
                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">{{ 'VIEW_FASTING_TENT.LOCATION_TYPE' | translate }}</label>
                    <div class="form-control-plaintext">{{fastingTentService.locationType || '-'}}</div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">{{ 'VIEW_FASTING_TENT.SUPERVISOR_NAME' | translate }}</label>
                    <div class="form-control-plaintext">{{fastingTentService.supervisorName || '-'}}</div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">{{ 'VIEW_FASTING_TENT.JOB_TITLE' | translate }}</label>
                    <div class="form-control-plaintext">{{fastingTentService.jopTitle || '-'}}</div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">{{ 'VIEW_FASTING_TENT.SUPERVISOR_MOBILE' | translate }}</label>
                    <div class="form-control-plaintext">{{fastingTentService.supervisorMobile || '-'}}</div>
                  </div>

                  <div class="col-md-12 mb-3">
                    <label class="form-label fw-bold">{{ 'VIEW_FASTING_TENT.NOTES' | translate }}</label>
                    <div class="form-control-plaintext">{{fastingTentService.notes || '-'}}</div>
                  </div>
                </div>
              </div>



              <!-- Section: Location Details -->

              <div class="step-content mb-4">
                <h5 class="mb-3 gold">{{ 'VIEW_FASTING_TENT.LOCATION_DETAILS' | translate }}</h5>

                <div *ngIf="fastingTentService?.location">
                  <div class="row mb-4">
                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">{{ 'VIEW_FASTING_TENT.LOCATION_NAME' | translate }}</label>
                      <div class="form-control-plaintext">{{fastingTentService?.location?.locationName || '-'}}</div>
                    </div>

                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">{{ 'VIEW_FASTING_TENT.LOCATION_OWNER' | translate }}</label>
                      <div class="form-control-plaintext">{{fastingTentService?.location?.locationOwner || '-'}}</div>
                    </div>

                    <div class="col-md-12 mb-3">
                      <label class="form-label fw-bold">{{ 'VIEW_FASTING_TENT.LOCATION_ADDRESS' | translate }}</label>
                      <div class="form-control-plaintext">{{fastingTentService?.location?.address || '-'}}</div>
                    </div>

                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">{{ 'VIEW_FASTING_TENT.REGION_NAME' | translate }}</label>
                      <div class="form-control-plaintext">{{fastingTentService?.regionName || '-'}}</div>
                    </div>

                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">{{ 'VIEW_FASTING_TENT.STREET_NAME' | translate }}</label>
                      <div class="form-control-plaintext">{{fastingTentService?.streetName || '-'}}</div>
                    </div>

                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">{{ 'VIEW_FASTING_TENT.GROUND_NO' | translate }}</label>
                      <div class="form-control-plaintext">{{fastingTentService?.groundNo || '-'}}</div>
                    </div>
                  </div>

                  <!-- Map Display -->
                  <div *ngIf="fastingTentService?.location?.locationCoordinates" class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <h6 class="fw-bold mb-0">{{ 'VIEW_FASTING_TENT.LOCATION_ON_MAP' | translate }}</h6>
                      <div>
                        <button type="button" class="btn btn-gold" (click)="refreshMap()" title="Refresh Map">
                          <i class="fas fa-sync-alt me-1"></i>
                          {{ 'COMMON.REFRESH' | translate }}
                        </button>
                      </div>
                    </div>

                    <div id="viewMap" style="height: 400px; width: 100%;" class="border rounded"></div>

                    <!-- Fallback when map fails to load -->
                    <div *ngIf="mapLoadError" class="alert alert-warning mt-3">
                      <i class="fas fa-exclamation-triangle me-2"></i>
                      <strong>{{ 'SHARED.MAP.LOADING_ISSUE' | translate }}:</strong> {{ 'SHARED.MAP.LOADING_ERROR' |
                      translate }}
                      <button type="button" class="btn btn-sm btn-outline-warning ms-2" (click)="refreshMap()">
                        <i class="fas fa-redo me-1"></i>
                        {{ 'SHARED.MAP.TRY_AGAIN' | translate }}
                      </button>
                    </div>
                  </div>
                </div>

                <div *ngIf="!fastingTentService?.location" class="alert alert-info">
                  {{ 'VIEW_FASTING_TENT.NO_LOCATION_INFO' | translate }}
                </div>
              </div>


              <!-- Section: Date Information -->

              <div class="step-content">
                <h5 class="mb-3 gold">{{ 'VIEW_FASTING_TENT.DATE_DETAILS_TITLE' | translate }}</h5>

                <div class="row" *ngIf="fastingTentService">
                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">{{ 'VIEW_FASTING_TENT.START_DATE' | translate }}</label>
                    <div class="form-control-plaintext">{{formatDate(fastingTentService.startDate) || '-'}}</div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">{{ 'VIEW_FASTING_TENT.END_DATE' | translate }}</label>
                    <div class="form-control-plaintext">{{formatDate(fastingTentService.endDate) || '-'}}</div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">{{ 'VIEW_FASTING_TENT.TENT_DATE' | translate }}</label>
                    <div class="form-control-plaintext">{{formatDate(fastingTentService.tentDate) || '-'}}</div>
                  </div>
                </div>

                <!-- Toggle Switches -->
                <div class="row">
                  <div class="col-xl-6 mb-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" [checked]="fastingTentService?.tentIsSetUp"
                        disabled id="tentIsSetUpView">
                      <label class="form-check-label" for="tentIsSetUpView">
                        {{ 'VIEW_FASTING_TENT.TENT_IS_SET_UP' | translate }}
                      </label>
                    </div>
                  </div>
                  <div class="col-xl-6 mb-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox"
                        [checked]="fastingTentService?.isConsultantApprovedFromPolice" disabled
                        id="consultantApprovedView">
                      <label class="form-check-label" for="consultantApprovedView">
                        {{ 'VIEW_FASTING_TENT.CONSULTANT_APPROVED_FROM_POLICE' | translate }}
                      </label>
                    </div>
                  </div>
                  <div class="col-xl-6 mb-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox"
                        [checked]="fastingTentService?.isConsultantFromAjman" disabled id="consultantFromAjmanView">
                      <label class="form-check-label" for="consultantFromAjmanView">
                        {{ 'VIEW_FASTING_TENT.CONSULTANT_FROM_AJMAN' | translate }}
                      </label>
                    </div>
                  </div>
                </div>

              </div>


              <!-- Accordion: Partners / Attachments / Workflow Comments -->



            </div>
            <div class="accordion" id="fastingTentAccordion">

              <!-- ACCORDION ITEM 1: Partners -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="partnersHeader">
                  <button class="accordion-button" type="button" data-bs-toggle="collapse"
                    data-bs-target="#partnersSection" aria-expanded="true" aria-controls="partnersSection">
                    {{ 'VIEW_FASTING_TENT.PARTNERS' | translate }}
                  </button>
                </h2>
                <div id="partnersSection" class="accordion-collapse collapse show" aria-labelledby="partnersHeader"
                  data-bs-parent="#fastingTentAccordion">
                  <div class="accordion-body">
                    <div class="step-content">
                      <div *ngIf="partners && partners.length > 0">
                        <div class="table-responsive">
                          <table class="table table-bordered">
                            <thead class="table-light">
                              <tr>
                                <th>{{ 'VIEW_FASTING_TENT.PARTNER_NAME' | translate }}</th>
                                <th>{{ 'VIEW_FASTING_TENT.PARTNER_TYPE' | translate }}</th>
                                <th>{{ 'VIEW_FASTING_TENT.LICENSE_NUMBER' | translate }}</th>
                                <th>{{ 'VIEW_FASTING_TENT.LICENSE_ISSUER' | translate }}</th>
                                <th>{{ 'VIEW_FASTING_TENT.LICENSE_EXPIRY_DATE' | translate }}</th>
                                <th>{{ 'VIEW_FASTING_TENT.CONTACT_DETAILS' | translate }}</th>
                                <th>{{ 'COMMON.ATTACHMENTS' | translate }}</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr *ngFor="let partner of partners">
                                <td>{{partner.name || '-'}}</td>
                                <td>{{partner.typeName || getPartnerTypeName(partner.type)}}</td>
                                <td>{{partner.licenseNumber || '-'}}</td>
                                <td>{{partner.licenseIssuer || '-'}}</td>
                                <td>{{formatDate(partner.licenseExpiryDate) || '-'}}</td>
                                <td>{{partner.contactDetails || '-'}}</td>
                                <td class="text-center">
                                  <button *ngIf="partner.attachments && partner.attachments.length > 0"
                                    class="btn btn-next-style" data-bs-toggle="modal"
                                    data-bs-target="#partnerAttachmentModal" (click)="viewPartnerAttachments(partner)">
                                    <i class="fas fa-eye me-1"></i>
                                    {{ 'COMMON.VIEW' | translate }} ({{partner.attachments.length}})
                                  </button>
                                  <button *ngIf="!partner.attachments || partner.attachments.length === 0"
                                    class="btn btn-next-style" data-bs-toggle="modal"
                                    data-bs-target="#partnerAttachmentModal" (click)="fetchPartnerAttachments(partner)">
                                    <i class="fas fa-eye me-1"></i>
                                    {{ 'COMMON.VIEW' | translate }}
                                  </button>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>

                      <div *ngIf="!partners || partners.length === 0" class="alert alert-info">
                        {{ 'VIEW_FASTING_TENT.NO_PARTNERS' | translate }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ACCORDION ITEM 2: Attachments -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="attachmentsHeader">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#attachmentsSection" aria-expanded="false" aria-controls="attachmentsSection">
                    {{ 'VIEW_FASTING_TENT.ATTACHMENTS' | translate }}
                  </button>
                </h2>
                <div id="attachmentsSection" class="accordion-collapse collapse" aria-labelledby="attachmentsHeader"
                  data-bs-parent="#fastingTentAccordion">
                  <div class="accordion-body">
                    <div class="step-content">
                      <div *ngIf="attachments && attachments.length > 0">
                        <div class="row">
                          <div class="col-xl-4 col-lg-6 mb-4" *ngFor="let attachment of attachments">
                            <div class="attachment-box">
                              <h6 class="card-title">{{attachment.attachmentTitle || ('COMMON.ATTACHMENT' |
                                translate)}}</h6>
                              <p class="mb-4">{{ 'COMMON.UPLOADED_ON' | translate }}:
                                {{formatDateTime(attachment.lastModified)}}</p>
                              <div class="d-flex justify-content-between mt-auto">
                                <button class="btn btn-next-style me-2" (click)="viewAttachment(attachment)">
                                  <i class="fas fa-eye me-1"></i>
                                  {{ 'COMMON.VIEW' | translate }}
                                </button>
                                <button class="btn btn-download-style" (click)="downloadAttachment(attachment)">
                                  <i class="fas fa-download me-1"></i>
                                  {{ 'COMMON.DOWNLOAD' | translate }}
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div *ngIf="!attachments || attachments.length === 0" class="alert alert-info">
                        {{ 'VIEW_FASTING_TENT.NO_ATTACHMENTS' | translate }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ACCORDION ITEM 3: Workflow Comments -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="wfHeader">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#wfComments" aria-expanded="false" aria-controls="wfComments">
                    {{ 'COMMON.WORKFLOW_COMMENTS' | translate }}
                  </button>
                </h2>
                <div id="wfComments" class="accordion-collapse collapse" aria-labelledby="wfHeader"
                  data-bs-parent="#fastingTentAccordion">
                  <div class="accordion-body">
                    <div class="step-content">

                      <div class="d-flex justify-content-end align-items-center mb-4">
                        <button *ngIf="targetWorkFlowStep" type="button" class="btn btn-gold" data-bs-toggle="modal"
                          data-bs-target="#commentModal">
                          <i class="fas fa-plus me-2"></i>
                          {{ 'COMMON.ADD_COMMENT' | translate }}
                        </button>
                      </div>

                      <!-- Loading state -->
                      <div *ngIf="isLoadingComments" class="text-center py-5">
                        <div class="spinner-border spinner-border-sm" role="status">
                          <span class="visually-hidden">{{ 'COMMON.LOADING' | translate }}</span>
                        </div>
                        <span class="ms-2">{{ 'COMMON.LOADING_COMMENTS' | translate }}</span>
                      </div>

                      <!-- <div class="comments-container">
                        <div class="comment-item">
                          <div class="d-flex align-items-center justify-content-between gap-3 mb-2">
                            <h5>Department Name</h5>
                            <div class="status-waiting">
                              Waiting
                            </div>
                          </div>
                          <div class="comment-area">
                            Lorem Ipsum is simply dummy text of the printing and typesetting
                            industry. Lorem Ipsum has been the industry's standard dummy
                            text ever since the 1500s, when an unknown printer took a galley
                            of type and scrambled it to make a type specimen book. It has
                            survived not only five centuries, but also the leap into
                            electronic typesetting, remaining essentially unchanged.
                          </div>
                          <button class="btn btn-view-attachment mt-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"
                              fill="none">
                              <g clip-path="url(#clip0_560_1674)">
                                <path
                                  d="M19.3923 7.84858C18.0998 5.74358 15.1598 2.21191 9.9998 2.21191C4.8398 2.21191 1.8998 5.74358 0.607299 7.84858C0.207739 8.49484 -0.00390625 9.23962 -0.00390625 9.99941C-0.00390625 10.7592 0.207739 11.504 0.607299 12.1502C1.8998 14.2552 4.8398 17.7869 9.9998 17.7869C15.1598 17.7869 18.0998 14.2552 19.3923 12.1502C19.7919 11.504 20.0035 10.7592 20.0035 9.99941C20.0035 9.23962 19.7919 8.49484 19.3923 7.84858V7.84858ZM17.9715 11.2777C16.8615 13.0827 14.349 16.1202 9.9998 16.1202C5.65063 16.1202 3.13813 13.0827 2.02813 11.2777C1.79074 10.8936 1.66501 10.451 1.66501 9.99941C1.66501 9.54785 1.79074 9.10521 2.02813 8.72108C3.13813 6.91608 5.65063 3.87858 9.9998 3.87858C14.349 3.87858 16.8615 6.91275 17.9715 8.72108C18.2089 9.10521 18.3346 9.54785 18.3346 9.99941C18.3346 10.451 18.2089 10.8936 17.9715 11.2777V11.2777Z"
                                  fill="#374957" />
                                <path
                                  d="M10.0007 5.83301C9.17656 5.83301 8.37098 6.07738 7.68578 6.53522C7.00057 6.99306 6.46652 7.6438 6.15115 8.40516C5.83579 9.16652 5.75328 10.0043 5.91405 10.8126C6.07482 11.6208 6.47166 12.3632 7.05437 12.946C7.63709 13.5287 8.37952 13.9255 9.18778 14.0863C9.99603 14.2471 10.8338 14.1645 11.5952 13.8492C12.3565 13.5338 13.0073 12.9998 13.4651 12.3146C13.9229 11.6293 14.1673 10.8238 14.1673 9.99967C14.166 8.89501 13.7266 7.83597 12.9455 7.05486C12.1644 6.27374 11.1053 5.83433 10.0007 5.83301V5.83301ZM10.0007 12.4997C9.5062 12.4997 9.02285 12.3531 8.61173 12.0783C8.2006 11.8036 7.88017 11.4132 7.69095 10.9564C7.50173 10.4996 7.45223 9.9969 7.54869 9.51195C7.64515 9.027 7.88325 8.58154 8.23289 8.23191C8.58252 7.88228 9.02797 7.64417 9.51293 7.54771C9.99788 7.45125 10.5005 7.50076 10.9574 7.68998C11.4142 7.87919 11.8046 8.19963 12.0793 8.61075C12.354 9.02187 12.5007 9.50522 12.5007 9.99967C12.5007 10.6627 12.2373 11.2986 11.7684 11.7674C11.2996 12.2363 10.6637 12.4997 10.0007 12.4997Z"
                                  fill="#374957" />
                              </g>
                              <defs>
                                <clipPath id="clip0_560_1674">
                                  <rect width="20" height="20" fill="white" />
                                </clipPath>
                              </defs>
                            </svg>
                            View Attachment
                          </button>
                        </div>
                        <div class="comment-item">
                          <div class="d-flex align-items-center justify-content-between gap-3 mb-2">
                            <h5>Department Name</h5>
                            <div class="status-approved">
                              Accepted
                            </div>
                          </div>
                          <div class="comment-area">
                            Lorem Ipsum is simply dummy text of the printing and typesetting
                            industry. Lorem Ipsum has been the industry's standard dummy
                            text ever since the 1500s, when an unknown printer took a galley
                            of type and scrambled it to make a type specimen book. It has
                            survived not only five centuries, but also the leap into
                            electronic typesetting, remaining essentially unchanged.
                          </div>
                        </div>
                        <div class="comment-item">
                          <div class="d-flex align-items-center justify-content-between gap-3 mb-2">
                            <h5>Department Name</h5>
                            <div class="status-waiting">
                              Waiting
                            </div>
                          </div>
                          <div class="comment-area">
                            Lorem Ipsum is simply dummy text of the printing and typesetting
                            industry. Lorem Ipsum has been the industry's standard dummy
                            text ever since the 1500s, when an unknown printer took a galley
                            of type and scrambled it to make a type specimen book. It has
                            survived not only five centuries, but also the leap into
                            electronic typesetting, remaining essentially unchanged.
                          </div>
                        </div>

                      </div>

                       <div *ngIf="!isLoadingComments">
                        <app-generic-data-table [columnDefs]="commentsColumnDefs" [rowData]="allWorkFlowComments"
                          [totalCount]="allWorkFlowComments.length" [pageSize]="10" [currentPage]="0"
                          [showActionColumn]="false" [columnHeaderMap]="commentsColumnHeaderMap"
                          (actionClick)="onCommentsTableAction($event)" (cellClicked)="onTableCellClick($event)">
                        </app-generic-data-table>
                      </div> -->
  <div class="comments-container">
                        <div class="comment-item" *ngFor="let comment of allWorkFlowComments">
                          <div class="d-flex align-items-center justify-content-between gap-3 mb-2">
                            <div>
                              <h5 class="mb-0">{{ comment.employeeDepartmentName || 'N/A' }}</h5>
                              <small class="text-muted">
                                {{ comment.lastModified | date:'dd/MM/yyyy' }}
                              </small>
                            </div>
                          </div>
                           <div class="comment-area">
                            {{ comment.comment }}
                          </div>
                           <div>
                                                      <button class="btn btn-view-attachment mt-2">
                              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"
                                fill="none">
                                <g clip-path="url(#clip0_560_1674)">
                                  <path
                                    d="M19.3923 7.84858C18.0998 5.74358 15.1598 2.21191 9.9998 2.21191C4.8398 2.21191 1.8998 5.74358 0.607299 7.84858C0.207739 8.49484 -0.00390625 9.23962 -0.00390625 9.99941C-0.00390625 10.7592 0.207739 11.504 0.607299 12.1502C1.8998 14.2552 4.8398 17.7869 9.9998 17.7869C15.1598 17.7869 18.0998 14.2552 19.3923 12.1502C19.7919 11.504 20.0035 10.7592 20.0035 9.99941C20.0035 9.23962 19.7919 8.49484 19.3923 7.84858V7.84858ZM17.9715 11.2777C16.8615 13.0827 14.349 16.1202 9.9998 16.1202C5.65063 16.1202 3.13813 13.0827 2.02813 11.2777C1.79074 10.8936 1.66501 10.451 1.66501 9.99941C1.66501 9.54785 1.79074 9.10521 2.02813 8.72108C3.13813 6.91608 5.65063 3.87858 9.9998 3.87858C14.349 3.87858 16.8615 6.91275 17.9715 8.72108C18.2089 9.10521 18.3346 9.54785 18.3346 9.99941C18.3346 10.451 18.2089 10.8936 17.9715 11.2777V11.2777Z"
                                    fill="#374957" />
                                  <path
                                    d="M10.0007 5.83301C9.17656 5.83301 8.37098 6.07738 7.68578 6.53522C7.00057 6.99306 6.46652 7.6438 6.15115 8.40516C5.83579 9.16652 5.75328 10.0043 5.91405 10.8126C6.07482 11.6208 6.47166 12.3632 7.05437 12.946C7.63709 13.5287 8.37952 13.9255 9.18778 14.0863C9.99603 14.2471 10.8338 14.1645 11.5952 13.8492C12.3565 13.5338 13.0073 12.9998 13.4651 12.3146C13.9229 11.6293 14.1673 10.8238 14.1673 9.99967C14.166 8.89501 13.7266 7.83597 12.9455 7.05486C12.1644 6.27374 11.1053 5.83433 10.0007 5.83301V5.83301ZM10.0007 12.4997C9.5062 12.4997 9.02285 12.3531 8.61173 12.0783C8.2006 11.8036 7.88017 11.4132 7.69095 10.9564C7.50173 10.4996 7.45223 9.9969 7.54869 9.51195C7.64515 9.027 7.88325 8.58154 8.23289 8.23191C8.58252 7.88228 9.02797 7.64417 9.51293 7.54771C9.99788 7.45125 10.5005 7.50076 10.9574 7.68998C11.4142 7.87919 11.8046 8.19963 12.0793 8.61075C12.354 9.02187 12.5007 9.50522 12.5007 9.99967C12.5007 10.6627 12.2373 11.2986 11.7684 11.7674C11.2996 12.2363 10.6637 12.4997 10.0007 12.4997Z"
                                    fill="#374957" />
                                </g>
                                <defs>
                                  <clipPath id="clip0_560_1674">
                                    <rect width="20" height="20" fill="white" />
                                  </clipPath>
                                </defs>
                              </svg>
                              {{ 'COMMON.VIEW' | translate}} </button>
                          </div>
                        </div>
                      </div>



                       <div *ngIf="!targetWorkFlowStep" class="alert alert-warning">
                        {{ 'COMMON.NO_WORKFLOW_STEP_FOUND' | translate }}
                      </div>

                    </div>
                  </div>
                </div>
              </div>

            </div>


          </div>
        </div>
      </div>

      <!-- Error state -->
      <div *ngIf="!isLoading && !mainApplyService" class="alert alert-danger text-center">
        <h5>{{ 'COMMON.ERROR' | translate }}</h5>
        <p>{{ 'COMMON.DATA_NOT_FOUND' | translate }}</p>
        <button class="btn btn-secondary" (click)="goBack()">
          {{ 'COMMON.GO_BACK' | translate }}
        </button>
      </div>
    </div>
  </section>
</div>

<!-- Add Comment Modal -->
<div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="commentModalLabel">{{ 'COMMON.ADD_COMMENT' | translate }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <form [formGroup]="commentForm" (ngSubmit)="addWorkFlowComment()">
          <div class="mb-3">
            <label for="commentText" class="form-label mb-2">{{ 'COMMON.COMMENT' | translate }}</label>
            <textarea class="form-control" id="commentText" rows="4" [(ngModel)]="newCommentText"
              [ngModelOptions]="{standalone: true}" placeholder="{{ 'COMMON.ENTER_COMMENT' | translate }}"
              required></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label mb-2">{{ 'COMMON.ATTACHMENTS' | translate }} ({{ 'COMMON.OPTIONAL' | translate
              }})</label>

            <!-- Comment Attachment Configurations -->
            <div *ngIf="commentAttachmentConfigs.length > 0" class="">
              <div>
                <div *ngFor="let config of commentAttachmentConfigs">

                  <div *ngIf="!commentSelectedFiles[config.id!] && !commentFilePreviews[config.id!]" class="upload-area"
                    (dragover)="onCommentDragOver($event)" (dragleave)="onCommentDragLeave($event)"
                    (drop)="onCommentDrop($event, config.id!)" [class.drag-over]="isCommentDragOver"
                    [class.border-danger]="isCommentAttachmentMandatory(config.id!) && !commentSelectedFiles[config.id!] && !commentFilePreviews[config.id!] && commentValidationSubmitted"
                    [class.border-success]="commentSelectedFiles[config.id!] || commentFilePreviews[config.id!]">
                    <input type="file" class="d-none" [id]="'comment-file-' + config.id"
                      (change)="onCommentFileSelected($event, config.id!)" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                    <label [for]="'comment-file-' + config.id" class="upload-label">
                      <i class="fas fa-cloud-upload-alt mb-2"></i>
                      <div>{{ 'ATTACHMENTS.DRAG_DROP_OR_CLICK' | translate }}</div>
                      <small class="text-muted">{{ 'ATTACHMENTS.SUPPORTED_FORMATS' | translate }}</small>
                    </label>
                  </div>

                  <div *ngIf="commentSelectedFiles[config.id!] || commentFilePreviews[config.id!]"
                    class="uploaded-file">
                    <div class="d-flex align-items-center gap-2">
                      <div *ngIf="commentFilePreviews[config.id!]">
                        <img [src]="commentFilePreviews[config.id!]" class="img-thumbnail uploaded-img"
                          *ngIf="commentSelectedFiles[config.id!].type?.startsWith('image/')"
                          [alt]="commentAttachments[config.id!].fileName || 'File'">
                      </div>
                      <span class="file-name">{{ commentAttachments[config.id!].fileName || ('FASTING_TENT.FILE' |
                        translate) }}</span>
                    </div>

                    <button *ngIf="commentSelectedFiles[config.id!] || commentFilePreviews[config.id!]" type="button"
                      class="btn-remove-uploaded-file" (click)="removeCommentFile(config.id!)">

                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path
                          d="M21 4H17.9C17.6679 2.87141 17.0538 1.85735 16.1613 1.12872C15.2687 0.40009 14.1522 0.00145452 13 0L11 0C9.8478 0.00145452 8.73132 0.40009 7.83875 1.12872C6.94618 1.85735 6.3321 2.87141 6.1 4H3C2.73478 4 2.48043 4.10536 2.29289 4.29289C2.10536 4.48043 2 4.73478 2 5C2 5.26522 2.10536 5.51957 2.29289 5.70711C2.48043 5.89464 2.73478 6 3 6H4V19C4.00159 20.3256 4.52888 21.5964 5.46622 22.5338C6.40356 23.4711 7.67441 23.9984 9 24H15C16.3256 23.9984 17.5964 23.4711 18.5338 22.5338C19.4711 21.5964 19.9984 20.3256 20 19V6H21C21.2652 6 21.5196 5.89464 21.7071 5.70711C21.8946 5.51957 22 5.26522 22 5C22 4.73478 21.8946 4.48043 21.7071 4.29289C21.5196 4.10536 21.2652 4 21 4ZM11 2H13C13.6203 2.00076 14.2251 2.19338 14.7316 2.55144C15.2381 2.90951 15.6214 3.41549 15.829 4H8.171C8.37858 3.41549 8.7619 2.90951 9.26839 2.55144C9.77487 2.19338 10.3797 2.00076 11 2ZM18 19C18 19.7956 17.6839 20.5587 17.1213 21.1213C16.5587 21.6839 15.7956 22 15 22H9C8.20435 22 7.44129 21.6839 6.87868 21.1213C6.31607 20.5587 6 19.7956 6 19V6H18V19Z"
                          fill="#5B5B5B" />
                        <path
                          d="M10 18C10.2652 18 10.5196 17.8946 10.7071 17.7071C10.8946 17.5196 11 17.2652 11 17V11C11 10.7348 10.8946 10.4804 10.7071 10.2929C10.5196 10.1054 10.2652 10 10 10C9.73478 10 9.48043 10.1054 9.29289 10.2929C9.10536 10.4804 9 10.7348 9 11V17C9 17.2652 9.10536 17.5196 9.29289 17.7071C9.48043 17.8946 9.73478 18 10 18Z"
                          fill="#5B5B5B" />
                        <path
                          d="M14 18C14.2652 18 14.5196 17.8946 14.7071 17.7071C14.8947 17.5196 15 17.2652 15 17V11C15 10.7348 14.8947 10.4804 14.7071 10.2929C14.5196 10.1054 14.2652 10 14 10C13.7348 10 13.4804 10.1054 13.2929 10.2929C13.1054 10.4804 13 10.7348 13 11V17C13 17.2652 13.1054 17.5196 13.2929 17.7071C13.4804 17.8946 13.7348 18 14 18Z"
                          fill="#5B5B5B" />
                      </svg>
                    </button>

                  </div>

                </div>
              </div>
            </div>

            <!-- Legacy file input (keeping for backward compatibility) -->
            <div *ngIf="commentAttachmentConfigs.length === 0" class="mb-3">
              <input type="file" class="form-control" id="commentFiles" multiple (change)="onFileSelected($event)">

              <div *ngIf="selectedFiles.length > 0" class="mt-2">
                <div class="d-flex flex-wrap gap-2">
                  <span *ngFor="let file of selectedFiles; let i = index" class="badge bg-light text-dark border">
                    {{file.name}}
                    <button type="button" class="btn-close btn-close-sm ms-2" (click)="removeSelectedFile(i)"></button>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" data-bs-dismiss="modal">
          {{ 'COMMON.CANCEL' | translate }}
        </button>
        <button type="button" class="btn btn-gold" (click)="addWorkFlowComment()"
          [disabled]="!newCommentText.trim() || isSavingComment">
          <span *ngIf="isSavingComment" class="spinner-border spinner-border-sm me-2" role="status"></span>
          {{ 'COMMON.ADD_COMMENT' | translate }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Attachment Preview Modal -->
<div class="modal fade" id="attachmentModal" tabindex="-1" aria-labelledby="attachmentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="attachmentModalLabel">
          <i class="fas fa-paperclip me-2"></i>
          {{ 'COMMON.ATTACHMENTS' | translate }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <!-- Loading State -->
        <div *ngIf="isLoadingAttachments" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">{{ 'COMMON.LOADING' | translate }}</span>
          </div>
          <p class="mt-3 text-muted">{{ 'COMMON.LOADING_ATTACHMENTS' | translate }}</p>
        </div>

        <!-- No Attachments State -->
        <div *ngIf="!isLoadingAttachments && selectedCommentAttachments.length === 0"
          class="text-center text-muted py-4">
          <i class="fas fa-file-alt fa-3x mb-3 text-muted"></i>
          <p>{{ 'COMMON.NO_ATTACHMENTS' | translate }}</p>
        </div>

        <!-- Attachments List -->
        <div *ngIf="!isLoadingAttachments && selectedCommentAttachments.length > 0" class="row g-3">
          <div *ngFor="let attachment of selectedCommentAttachments" class="col-md-6 col-lg-4">
            <div class="card h-100 border-0 shadow-sm hover-shadow">
              <div class="card-body text-center p-3">
                <div class="mb-3">
                  <i class="fas fa-file-alt fa-2x text-primary"></i>
                </div>
                <h6 class="card-title small mb-2">{{ attachment.attachmentTitle || ('FASTING_TENT.ATTACHMENT' |
                  translate) }}</h6>
                <div class="d-grid gap-2">
                  <button class="btn btn-download-style" (click)="downloadAttachment(attachment)">
                    <i class="fas fa-download me-1"></i>
                    {{ 'COMMON.DOWNLOAD' | translate }}
                  </button>
                  <button class="btn btn-next-style" (click)="viewAttachment(attachment)">
                    <i class="fas fa-eye me-1"></i>
                    {{ 'COMMON.VIEW' | translate }}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" data-bs-dismiss="modal">
          {{ 'COMMON.CLOSE' | translate }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Partner Attachment Preview Modal -->
<div class="modal fade" id="partnerAttachmentModal" tabindex="-1" aria-labelledby="partnerAttachmentModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="partnerAttachmentModalLabel">
          <i class="fas fa-user-tie me-2"></i>
          {{ 'FASTING_TENT.PARTNER_ATTACHMENTS' | translate }}
          <span *ngIf="selectedPartner" class="fw-normal"> - {{selectedPartner.name}}</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <!-- Loading State -->
        <div *ngIf="isLoadingPartnerAttachments" class="text-center py-5">
          <div class="spinner-border text-success" role="status">
            <span class="visually-hidden">{{ 'COMMON.LOADING' | translate }}</span>
          </div>
          <p class="mt-3 text-muted">{{ 'COMMON.LOADING_ATTACHMENTS' | translate }}</p>
        </div>

        <!-- No Attachments State -->
        <div *ngIf="!isLoadingPartnerAttachments && selectedPartnerAttachments.length === 0"
          class="text-center text-muted py-4">
          <i class="fas fa-file-alt fa-3x mb-3 text-muted"></i>
          <p>{{ 'COMMON.NO_ATTACHMENTS' | translate }}</p>
        </div>

        <!-- Attachments List -->
        <div *ngIf="!isLoadingPartnerAttachments && selectedPartnerAttachments.length > 0" class="row g-3">
          <div *ngFor="let attachment of selectedPartnerAttachments" class="col-md-6 col-lg-4">
            <div class="card h-100 border-0 shadow-sm hover-shadow">
              <div class="card-body text-center p-3">
                <div class="mb-3">
                  <i class="fas fa-file-alt fa-2x text-success"></i>
                </div>
                <h6 class="card-title small mb-2">{{ attachment.attachmentTitle || ('FASTING_TENT.ATTACHMENT' |
                  translate) }}</h6>
                <div class="d-grid gap-2">
                  <button class="btn btn-download-style" (click)="downloadAttachment(attachment)">
                    <i class="fas fa-download me-1"></i>
                    {{ 'COMMON.DOWNLOAD' | translate }}
                  </button>
                  <button class="btn btn-next-style" (click)="viewAttachment(attachment)">
                    <i class="fas fa-eye me-1"></i>
                    {{ 'COMMON.VIEW' | translate }}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" data-bs-dismiss="modal">
          {{ 'COMMON.CLOSE' | translate }}
        </button>
      </div>
    </div>
  </div>
</div>