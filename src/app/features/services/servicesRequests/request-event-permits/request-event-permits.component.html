<div class="request-plaint-container">
  <section>
    <div class="container services">
      <h4 class="title">{{ "REQUEST_EVENT_PERMIT.TITLE" | translate }}</h4>
      <!-- <p class="mb-5">{{ 'REQUEST_PLAINT.DESCRIPTION' | translate }}</p> -->
      <!-- Loading state -->
      <div *ngIf="isLoading" class="text-center py-5">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">
            {{
            "COMMON.LOADING" | translate
            }}
          </span>
        </div>
        <p class="mt-3">{{ "COMMON.LOADING_DATA" | translate }}</p>
      </div>

      <!-- Main Content -->
      <div *ngIf="!isLoading" class="row">
        <!-- Steps Navigation -->
        <div class="col-lg-3 mb-4">
          <div class="main-container h-100">
            <!-- Step 1 -->
            <div class="step-navigation-item">
              <div class="step-container" [class.active]="isStepActive(1)"
                [class.completed]="isStepCompleted(1)"
                [class.invalid]="currentStep > 1 && !isStepCompleted(1)">
                <div class="step-bg"></div>
                <div class="step">
                  <span *ngIf="!isStepCompleted(1)">1</span>
                  <i *ngIf="isStepCompleted(1)" class="fas fa-check"></i>
                </div>
              </div>
              <div class="connecting-line"></div>
              <div class="step-content-wrapper">
                <span class="step-title" (click)="goToStep(1)" [class.text-success]="isStepCompleted(1)"
                  [class.text-danger]="currentStep > 1 && !isStepCompleted(1)"
                  [class.text-primary]="isStepActive(1)">
                  {{ 'REQUEST_PLAINT.STEP1_TITLE' | translate }}
                </span>
                <small class="d-block text-muted step-description">{{ 'REQUEST_EVENT_PERMIT.STEP1_DESC' | translate }}</small>
              </div>
            </div>

            <!-- Step 2 -->
            <div class="step-navigation-item">
              <div class="step-container" [class.active]="isStepActive(2)"
                [class.completed]="isStepCompleted(2)">
                <div class="step-bg"></div>
                <div class="step">
                  <span *ngIf="!isStepCompleted(2)">2</span>
                  <i *ngIf="isStepCompleted(2)" class="fas fa-check"></i>
                </div>
              </div>
              <div class="connecting-line"></div>
              <div class="step-content-wrapper">
                <span class="step-title" (click)="goToStep(2)" [class.text-success]="isStepCompleted(2)"
                  [class.text-primary]="isStepActive(2)">
                  {{ 'CHARITY_EVENT.PARTNERS_TITLE' | translate }}
                </span>
                <small class="d-block text-muted step-description">{{ 'CHARITY_EVENT.PARTNERS_DESC' | translate }}</small>
              </div>
            </div>

            <!-- Step 3 -->
            <div class="step-navigation-item">
              <div class="step-container" [class.active]="isStepActive(3)"
                [class.completed]="isStepCompleted(3)">
                <div class="step-bg"></div>
                <div class="step">
                  <span *ngIf="!isStepCompleted(3)">3</span>
                  <i *ngIf="isStepCompleted(3)" class="fas fa-check"></i>
                </div>
              </div>
              <div class="connecting-line"></div>
              <div class="step-content-wrapper">
                <span class="step-title" (click)="goToStep(3)" [class.text-success]="isStepCompleted(3)"
                  [class.text-primary]="isStepActive(3)">
                  {{ 'CHARITY_EVENT.ADVERTISEMENT_TYPE' | translate }}
                </span>
                <small class="d-block text-muted step-description">{{ 'CHARITY_EVENT.ADVERTISEMENT_DESC' | translate }}</small>
              </div>
            </div>

            <!-- Step 4 -->
            <div class="step-navigation-item">
              <div class="step-container" [class.active]="isStepActive(4)"
                [class.completed]="isStepCompleted(4)"
                [class.invalid]="currentStep === 4 && !isStepCompleted(4)">
                <div class="step-bg"></div>
                <div class="step">
                  <span *ngIf="!isStepCompleted(4)">4</span>
                  <i *ngIf="isStepCompleted(4)" class="fas fa-check"></i>
                </div>
              </div>
              <div class="step-content-wrapper">
                <span class="step-title" (click)="goToStep(4)" [class.text-success]="isStepCompleted(4)"
                  [class.text-danger]="currentStep === 4 && !isStepCompleted(4)"
                  [class.text-primary]="isStepActive(4)">
                  {{ 'REQUEST_PLAINT.STEP5_TITLE' | translate }}
                </span>
                <small class="d-block text-muted step-description">{{ 'REQUEST_PLAINT.ATTACHMENTS_DESC' | translate }}</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Content Area -->
        <div class="col-lg-9 mb-4">
          <div class="main-container h-100">
            <!-- Single form wraps all steps -->
            <form [formGroup]="firstStepForm" (ngSubmit)="onSubmit()">
              <!-- Step 1: Main Information -->
              <div *ngIf="currentStep === 1" class="step-content">
                <h5 class="mb-4">
                  {{ "CHARITY_EVENT.STEP1_TITLE" | translate }}
                </h5>

                <div class="row">
                  <!-- Request No (عرض فقط) -->
                  <!-- <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{
                      "CHARITY_EVENT.REQUEST_NO" | translate
                      }}
                    </label>
                    <input type="text" class="form-control" value="0" readonly />
                  </div> -->

                  <!-- Request Date -->
                  <!-- <div class="col-xl-6 mb-4">
                                        <label class="form-label">
                                            {{ 'CHARITY_EVENT.REQUEST_DATE' | translate }} <span
                                                class="text-danger">*</span>
                                        </label>
                                        <input type="datetime-local" class="form-control"
                                            [class.is-invalid]="firstStepForm.get('requestDate')?.touched && firstStepForm.get('requestDate')?.invalid"
                                            [value]="(firstStepForm.get('requestDate')?.value | date:'yyyy-MM-ddTHH:mm')"
                                            (change)="onLocalDateChange(firstStepForm.get('requestDate')?.value,'requestDate')" />
                                        <div class="invalid-feedback"
                                            *ngIf="firstStepForm.get('requestDate')?.touched && firstStepForm.get('requestDate')?.errors">
                                            {{ 'VALIDATION.REQUIRED_FIELD' | translate }}
                                        </div>
                  </div> -->
                  <!-- <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{ "CHARITY_EVENT.REQUEST_DATE" | translate }}
                      <span class="text-danger">*</span>
                    </label>

                    
                    <div class="form-control bg-light">
                      {{
                      firstStepForm.get("requestDate")?.value
                      | date : "yyyy-MM-dd"
                      }}
                    </div>
                  </div> -->

                  <!-- Request Side -->
                  <!-- <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{ "event.RequestSide" | translate }}
                      <span class="text-danger">*</span>
                    </label>
                    <input class="form-control" formControlName="requestSide" [class.is-invalid]="
                        firstStepForm.get('requestSide')?.touched &&
                        firstStepForm.get('requestSide')?.invalid
                      " />
                    <div class="invalid-feedback" *ngIf="
                        firstStepForm.get('requestSide')?.touched &&
                        firstStepForm.get('requestSide')?.errors
                      ">
                      {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                    </div>
                  </div> -->

                  <!-- Supervising Side -->
                  <!-- <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{ "event.SupervisingSide" | translate }}
                      <span class="text-danger">*</span>
                    </label>
                    <input class="form-control" formControlName="supervisingSide" [class.is-invalid]="
                        firstStepForm.get('supervisingSide')?.touched &&
                        firstStepForm.get('supervisingSide')?.invalid
                      " />
                    <div class="invalid-feedback" *ngIf="
                        firstStepForm.get('supervisingSide')?.touched &&
                        firstStepForm.get('supervisingSide')?.errors
                      ">
                      {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                    </div>
                  </div> -->

                  <!-- Event Name -->
                  <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{ "CHARITY_EVENT.EVENT_NAME" | translate }}
                      <span class="text-danger">*</span>
                    </label>
                    <input class="form-control" formControlName="eventName" [class.is-invalid]="
                        firstStepForm.get('eventName')?.touched &&
                        firstStepForm.get('eventName')?.invalid
                      " />
                    <div class="invalid-feedback" *ngIf="
                        firstStepForm.get('eventName')?.touched &&
                        firstStepForm.get('eventName')?.errors
                      ">
                      {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                    </div>
                  </div>

                  <!-- Request Type (ng-select) -->
                  <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{ "event.LkpRequestTypeId" | translate }}
                      <span class="text-danger">*</span>
                    </label>
                    <ng-select formControlName="lkpRequestTypeId" [items]="requestTypes" bindLabel="text" bindValue="id"
                      [clearable]="true" [searchable]="true" [placeholder]="'COMMON.SELECT_OPTION' | translate"
                      class="ng-select-custom" [ngClass]="{
                        'is-invalid':
                          firstStepForm.get('lkpRequestTypeId')?.touched &&
                          firstStepForm.get('lkpRequestTypeId')?.invalid
                      }" (change)="onRequestTypeChange()">
                    </ng-select>
                    <div class="invalid-feedback" *ngIf="
                        firstStepForm.get('lkpRequestTypeId')?.touched &&
                        firstStepForm.get('lkpRequestTypeId')?.errors
                      ">
                      {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                    </div>
                  </div>
                  <!-- Beneficiary ID Number - Show only for individual request type -->
                  <div class="col-xl-12 mb-4" *ngIf="isIndividualRequestType()">
                    <label class="form-label">
                      {{
                      "event.beneficiaryIdNumber" | translate
                      }} <span class="text-danger">*</span>
                    </label>

                    <div class="input-group">
                      <input type="text" class="form-control" formControlName="beneficiaryIdNumber"
                        placeholder="784-____-_______-_" maxlength="15" (keypress)="restrictToNumbers($event)"
                        [class.is-invalid]="firstStepForm.get('beneficiaryIdNumber')?.touched && firstStepForm.get('beneficiaryIdNumber')?.invalid" />

                      <button type="button" class="btn btn-outline-primary" (click)="readIdentityCardData()"
                        [disabled]="isLoadingIdentityCard || !firstStepForm.get('beneficiaryIdNumber')?.value">
                        <span *ngIf="isLoadingIdentityCard" class="spinner-border spinner-border-sm me-1"></span>
                        <i *ngIf="!isLoadingIdentityCard" class="fas fa-id-card me-1"></i>
                        {{ "COMMON.READ_CARD" | translate }}
                      </button>
                      <button type="button" class="btn btn-outline-info" (click)="navigateToPreviousAidRequests()"
                        [disabled]="!firstStepForm.get('beneficiaryIdNumber')?.value">
                        <i class="fas fa-history me-1"></i>
                        {{ "AID_REQUESTS.PREVIOUS_AID_REQUESTS" | translate }}
                      </button>
                    </div>

                    <div class="invalid-feedback d-block"
                      *ngIf="firstStepForm.get('beneficiaryIdNumber')?.touched && firstStepForm.get('beneficiaryIdNumber')?.errors">
                      <div *ngIf="firstStepForm.get('beneficiaryIdNumber')?.hasError('required')">
                        {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                      </div>
                      <div *ngIf="firstStepForm.get('beneficiaryIdNumber')?.hasError('pattern')">
                        {{ "VALIDATION.INVALID_EMIRATES_ID" | translate }}
                      </div>
                      <div *ngIf="firstStepForm.get('beneficiaryIdNumber')?.hasError('identityCardNotRead')">
                        {{ "VALIDATION.IDENTITY_CARD_MUST_BE_READ" | translate }}
                      </div>
                    </div>
                  </div>
                  <!-- Event Location -->
                  <!-- <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{ "CHARITY_EVENT.EVENT_LOCATION" | translate }}
                      <span class="text-danger">*</span>
                    </label>
                    <input class="form-control" formControlName="eventLocation" [class.is-invalid]="
                        firstStepForm.get('eventLocation')?.touched &&
                        firstStepForm.get('eventLocation')?.invalid
                      " />
                    <div class="invalid-feedback" *ngIf="
                        firstStepForm.get('eventLocation')?.touched &&
                        firstStepForm.get('eventLocation')?.errors
                      ">
                      {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                    </div>
                  </div> -->
                  <!-- Permit Type (ng-select) -->
                  <!-- <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{ "event.LkpPermitTypeId" | translate }}
                      <span class="text-danger">*</span>
                    </label>
                    <ng-select formControlName="lkpPermitTypeId" [items]="permitsTypes" bindLabel="text" bindValue="id"
                      [clearable]="true" [searchable]="true" [placeholder]="'COMMON.SELECT_OPTION' | translate"
                      class="ng-select-custom" [ngClass]="{
                        'is-invalid':
                          firstStepForm.get('lkpPermitTypeId')?.touched &&
                          firstStepForm.get('lkpPermitTypeId')?.invalid
                      }">
                    </ng-select>
                    <div class="invalid-feedback" *ngIf="
                        firstStepForm.get('lkpPermitTypeId')?.touched &&
                        firstStepForm.get('lkpPermitTypeId')?.errors
                      ">
                      {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                    </div>
                  </div> -->

                  <!-- Start / End -->
                  <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{ "CHARITY_EVENT.START_DATE" | translate }}
                      <span class="text-danger">*</span>
                    </label>
                    <!-- <input type="datetime-local" class="form-control"
                                            [value]="(firstStepForm.get('startDate')?.value | date:'yyyy-MM-ddTHH:mm')"
                                            (change)="onLocalDateChange(firstStepForm.get('startDate')?.value,'startDate')"
                                            [class.is-invalid]="firstStepForm.get('startDate')?.touched && firstStepForm.get('startDate')?.invalid"> -->
                    <input type="datetime-local" class="form-control" [value]="
                        firstStepForm.get('startDate')?.value
                          | date : 'yyyy-MM-ddTHH:mm'
                      " (change)="onLocalDateChange($event, 'startDate')" [class.is-invalid]="
                        (firstStepForm.get('startDate')?.touched &&
                        firstStepForm.get('startDate')?.invalid) ||
                        firstStepForm.hasError('startBeforeToday')
                      " />

                    <div class="invalid-feedback" *ngIf="
                        firstStepForm.get('startDate')?.touched &&
                        firstStepForm.get('startDate')?.errors &&
                        firstStepForm.get('startDate')?.hasError('required')
                      ">
                      {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                    </div>
                    
                    <div style="color:red" *ngIf="firstStepForm.hasError('startBeforeToday')">
                      {{ 'VALIDATION.START_NOT_BEFORE_TODAY' | translate }}
                    </div>
                  </div>

                  <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{ "CHARITY_EVENT.END_DATE" | translate }}
                      <span class="text-danger">*</span>
                    </label>
                    <!-- <input type="datetime-local" class="form-control"
                                            [value]="(firstStepForm.get('endDate')?.value | date:'yyyy-MM-ddTHH:mm')"
                                            (change)="onLocalDateChange(firstStepForm.get('endDate')?.value,'endDate')"
                                            [class.is-invalid]="firstStepForm.get('endDate')?.touched && firstStepForm.get('endDate')?.invalid"> -->
                    <input type="datetime-local" class="form-control" [value]="
                        firstStepForm.get('endDate')?.value
                          | date : 'yyyy-MM-ddTHH:mm'
                      " (change)="onLocalDateChange($event, 'endDate')" [class.is-invalid]="
                        firstStepForm.get('endDate')?.touched &&
                        firstStepForm.get('endDate')?.invalid
                      " />

                    <div class="invalid-feedback" *ngIf="
                        firstStepForm.get('endDate')?.touched &&
                        firstStepForm.get('endDate')?.errors &&
                        firstStepForm.get('endDate')?.hasError('required')
                      ">
                      {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                    </div>
                  </div>

                  <!-- خطأ ترتيب التواريخ العام -->
                  <div class="col-12 mb-4" *ngIf="firstStepForm.hasError('order')">
                    <div class="text-danger small">
                      {{ "VALIDATION.DATE_RANGE" | translate }}
                    </div>
                  </div>
                  <!-- AM Start Time -->
                  <!-- <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{ "event.AmStartTime" | translate }}
                      <span class="text-danger">*</span>
                    </label>
                    <input type="time" class="form-control" [value]="
                        getTimeOnly(firstStepForm.get('amStartTime')?.value)
                      " (change)="onTimeChange($event, 'amStartTime')"
                      [disabled]="!firstStepForm.get('startDate')?.value" [title]="
                        !firstStepForm.get('startDate')?.value
                          ? 'Please select the start date first'
                          : ''
                      " [class.is-invalid]="
                        firstStepForm.get('amStartTime')?.touched &&
                        firstStepForm.get('amStartTime')?.invalid
                      " />

                    <div class="invalid-feedback" *ngIf="
                        firstStepForm.get('amStartTime')?.touched &&
                        firstStepForm.get('amStartTime')?.errors
                      ">
                      {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                    </div>
                  </div> -->

                  <!-- AM End Time -->
                  <!-- <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{
                      "event.AmEndTime" | translate
                      }}<span class="text-danger">*</span>
                    </label>
                    <input type="time" class="form-control" [value]="
                        getTimeOnly(firstStepForm.get('amEndTime')?.value)
                      " (change)="onTimeChange($event, 'amEndTime')"
                      [disabled]="!firstStepForm.get('startDate')?.value" [title]="
                        !firstStepForm.get('startDate')?.value
                          ? 'Please select the start date first'
                          : ''
                      " [class.is-invalid]="
                        firstStepForm.get('amEndTime')?.touched &&
                        firstStepForm.get('amEndTime')?.invalid
                      " />

                    <div class="invalid-feedback" *ngIf="
                        firstStepForm.get('amEndTime')?.touched &&
                        firstStepForm.get('amEndTime')?.errors
                      ">
                      {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                    </div>
                  </div> -->

                  <!-- PM Start Time -->
                  <!-- <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{ "event.PmStartTime" | translate }}
                      <span class="text-danger">*</span>
                    </label>
                    <input type="time" class="form-control" [value]="getLocalTimeValue('pmStartTime')"
                      (change)="onTimeChange($event, 'pmStartTime')" [disabled]="!firstStepForm.get('startDate')?.value"
                      [title]="
                        !firstStepForm.get('startDate')?.value
                          ? 'Please select the start date first'
                          : ''
                      " [class.is-invalid]="
                        firstStepForm.get('pmStartTime')?.touched &&
                        firstStepForm.get('pmStartTime')?.invalid
                      " />

                    <div class="invalid-feedback" *ngIf="
                        firstStepForm.get('pmStartTime')?.touched &&
                        firstStepForm.get('pmStartTime')?.errors
                      ">
                      {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                    </div>
                  </div> -->

                  <!-- PM End Time -->
                  <!-- <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{ "event.PmEndTime" | translate }}
                      <span class="text-danger">*</span>
                    </label>
                    <input type="time" class="form-control" [value]="getLocalTimeValue('pmEndTime')"
                      (change)="onTimeChange($event, 'pmEndTime')" [disabled]="!firstStepForm.get('startDate')?.value"
                      [title]="
                        !firstStepForm.get('startDate')?.value
                          ? 'Please select the start date first'
                          : ''
                      " [class.is-invalid]="
                        firstStepForm.get('pmEndTime')?.touched &&
                        firstStepForm.get('pmEndTime')?.invalid
                      " />

                    <div class="invalid-feedback" *ngIf="
                        firstStepForm.get('pmEndTime')?.touched &&
                        firstStepForm.get('pmEndTime')?.errors
                      ">
                      {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                    </div>
                  </div> -->

                  <!-- Admin / Delegate / Alternate -->

                  <!-- <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{ "event.DelegateName" | translate }}
                      <span class="text-danger">*</span>
                    </label>
                    <input class="form-control" formControlName="delegateName" [class.is-invalid]="
                        firstStepForm.get('delegateName')?.touched &&
                        firstStepForm.get('delegateName')?.invalid
                      " />
                    <div class="invalid-feedback" *ngIf="
                        firstStepForm.get('delegateName')?.touched &&
                        firstStepForm.get('delegateName')?.errors
                      ">
                      {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                    </div>
                  </div> -->

                  <!-- <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{ "event.AlternateName" | translate }}
                      <span class="text-danger">*</span>
                    </label>
                    <input class="form-control" formControlName="alternateName" [class.is-invalid]="
                        firstStepForm.get('alternateName')?.touched &&
                        firstStepForm.get('alternateName')?.invalid
                      " />
                    <div class="invalid-feedback" *ngIf="
                        firstStepForm.get('alternateName')?.touched &&
                        firstStepForm.get('alternateName')?.errors
                      ">
                      {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                    </div>
                  </div> -->
                  <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{ "event.Admin" | translate }}
                      <span class="text-danger">*</span>
                    </label>
                    <input class="form-control" formControlName="admin" [class.is-invalid]="
                        firstStepForm.get('admin')?.touched &&
                        firstStepForm.get('admin')?.invalid
                      " />
                    <div class="invalid-feedback" *ngIf="
                        firstStepForm.get('admin')?.touched &&
                        firstStepForm.get('admin')?.errors
                      ">
                      {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                    </div>
                  </div>
                  <!-- Phones -->
                  <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{ "event.AdminTel" | translate }}
                      <span class="text-danger">*</span>
                    </label>

                    <!-- Mobile Number Input with UAE Flag and 971 prefix -->
                    <div class="mobile-input-container" style="border: none !important" [class.is-invalid]="
                        (submitted || firstStepForm.get('adminTel')?.touched) &&
                        firstStepForm.get('adminTel')?.errors
                      ">
                      <div class="mobile-prefix-container">
                        <img src="assets/images/Flag_of_the_United_Arab_Emirates.svg.png" alt="UAE Flag"
                          class="uae-flag-image" />
                        <span class="mobile-prefix">971</span>
                      </div>
                      <input type="tel" class="form-control mobile-number-input" formControlName="adminTel"
                        placeholder="5**********" maxlength="9" (keypress)="restrictMobileInput($event)"
                        (input)="onAdminTelInput()" (blur)="onAdminTelBlur()" />
                    </div>

                    <div *ngIf="
                        (submitted || firstStepForm.get('adminTel')?.touched) &&
                        firstStepForm.get('adminTel')?.errors
                      " class="invalid-feedback">
                      <div *ngIf="
                          firstStepForm.get('adminTel')?.hasError('required')
                        ">
                        {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                      </div>
                      <div *ngIf="
                          firstStepForm.get('adminTel')?.hasError('pattern')
                        ">
                        {{ "VALIDATION.INVALID_PHONE_FORMAT" | translate }}
                      </div>
                    </div>
                  </div>

                  <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{ "event.TELEPHONE" | translate }}
                      <!-- <span class="text-danger">*</span> -->
                    </label>

                    <!-- Mobile Number Input with UAE Flag and 971 prefix -->
                    <div class="mobile-input-container" style="border: none !important" [class.is-invalid]="
                        (submitted ||
                          firstStepForm.get('telephone')?.touched) &&
                        firstStepForm.get('telephone')?.errors
                      ">
                      <div class="mobile-prefix-container">
                        <img src="assets/images/Flag_of_the_United_Arab_Emirates.svg.png" alt="UAE Flag"
                          class="uae-flag-image" />
                        <span class="mobile-prefix">971</span>
                      </div>
                      <input type="tel" class="form-control mobile-number-input" formControlName="telephone"
                        placeholder="5**********" maxlength="9" (keypress)="restrictMobileInput($event)"
                        (input)="onTelephoneInput()" (blur)="onTelephoneBlur()" />
                    </div>

                    <div *ngIf="
                        (submitted ||
                          firstStepForm.get('telephone')?.touched) &&
                        firstStepForm.get('telephone')?.errors
                      " class="invalid-feedback">
                      <!-- <div *ngIf="
                          firstStepForm.get('telephone')?.hasError('required')
                        ">
                        {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                      </div> -->
                      <div *ngIf="
                          firstStepForm.get('telephone')?.hasError('pattern')
                        ">
                        {{ "VALIDATION.INVALID_PHONE_FORMAT" | translate }}
                      </div>
                    </div>
                  </div>

                  <!-- Email -->
                  <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{
                      "CHARITY_EVENT.EMAIL" | translate
                      }}
                    </label>
                    <input type="email" class="form-control" formControlName="email" [class.is-invalid]="
                        firstStepForm.get('email')?.touched &&
                        firstStepForm.get('email')?.invalid
                      " />
                    <div class="invalid-feedback" *ngIf="
                        firstStepForm.get('email')?.touched &&
                        firstStepForm.get('email')?.errors
                      ">
                      {{ "VALIDATION.INVALID_EMAIL" | translate }}
                    </div>
                  </div>

                  <!-- Targeted Amount -->
                  <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{
                      "CHARITY_EVENT.TARGETED_AMOUNT" | translate
                      }} <span class="text-danger">*</span>
                    </label>
                    <input type="number" step="any" min="0" class="form-control" formControlName="targetedAmount"
                      [class.is-invalid]="
                        firstStepForm.get('targetedAmount')?.touched &&
                        firstStepForm.get('targetedAmount')?.invalid
                      " />
                    <div class="invalid-feedback" *ngIf="
                        firstStepForm.get('targetedAmount')?.touched &&
                        firstStepForm.get('targetedAmount')?.errors
                      ">
                      <div *ngIf="firstStepForm.get('targetedAmount')?.hasError('required')">
                        {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                      </div>
                      <div *ngIf="firstStepForm.get('targetedAmount')?.hasError('min')">
                        {{ "VALIDATION.MIN_ZERO" | translate }}
                      </div>
                    </div>
                  </div>



                  <!-- Donation Channels (multi) ng-select -->
                  <div class="col-xl-12 mb-4">
                    <label class="form-label">
                      {{ "CHARITY_EVENT.DONATION_CHANNELS" | translate }}
                    </label>
                    <ng-select formControlName="donationCollectionChannelIds" [items]="donationChannelsLookup"
                      bindLabel="text" bindValue="id" [multiple]="true" [closeOnSelect]="false" [clearable]="true"
                      [searchable]="true" [placeholder]="'COMMON.SELECT_OPTION' | translate" class="ng-select-custom"
                      [ngClass]="{
                        'is-invalid':
                          firstStepForm.get('donationCollectionChannelIds')
                            ?.touched &&
                          firstStepForm.get('donationCollectionChannelIds')
                            ?.invalid
                      }">
                    </ng-select>
                    <div class="invalid-feedback" *ngIf="
                        firstStepForm.get('donationCollectionChannelIds')
                          ?.touched &&
                        firstStepForm
                          .get('donationCollectionChannelIds')
                          ?.hasError('minArrayLength')
                      ">
                      {{
                      "VALIDATIONCHARITY_EVENT.MIN_ONE_CHANNEL" | translate
                      }}
                    </div>
                  </div>

                  <!-- Notes -->
                  <div class="col-xl-12 mb-2">
                    <label class="form-label">
                      {{
                      "CHARITY_EVENT.NOTES" | translate
                      }}
                    </label>
                    <textarea class="form-control" rows="3" formControlName="notes" [placeholder]="
                        'CHARITY_EVENT.NOTES_PLACEHOLDER' | translate
                      "></textarea>
                  </div>

                  <!-- Identity Card Data Section -->
                  <div class="col-12 mt-4" *ngIf="showIdentityCardData && identityCardData">
                    <div class="card" style="border: 2px solid #8D734D;">
                      <div class="card-header text-white" style="background-color: #8D734D;">
                        <h6 class="mb-0">
                          <i class="fas fa-id-card me-2"></i>
                          {{ "IDENTITY_CARD.TITLE" | translate }}
                        </h6>
                      </div>
                      <div class="card-body">
                        <div class="row">
                          <!-- Full Name -->
                          <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">{{ "IDENTITY_CARD.FULL_NAME" | translate }}</label>
                            <div class="form-control-plaintext bg-light p-2 rounded">
                              {{ translationService.currentLang === 'ar' ? identityCardData.fullNameAr :
                              identityCardData.fullNameEn }}
                            </div>
                          </div>

                          <!-- IDN -->
                          <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">{{ "IDENTITY_CARD.IDN" | translate }}</label>
                            <div class="form-control-plaintext bg-light p-2 rounded">
                              {{ identityCardData.idn }}
                            </div>
                          </div>

                          <!-- Nationality -->
                          <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">{{ "IDENTITY_CARD.NATIONALITY" | translate }}</label>
                            <div class="form-control-plaintext bg-light p-2 rounded">
                              {{ translationService.currentLang === 'ar' ? identityCardData.nationalityAr :
                              identityCardData.nationalityEn }}
                            </div>
                          </div>

                          <!-- Gender -->
                          <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">{{ "IDENTITY_CARD.GENDER" | translate }}</label>
                            <div class="form-control-plaintext bg-light p-2 rounded">
                              {{ translationService.currentLang === 'ar' ? identityCardData.genderAr :
                              identityCardData.genderEn }}
                            </div>
                          </div>

                          <!-- Birth Date -->
                          <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">{{ "IDENTITY_CARD.BIRTH_DATE" | translate }}</label>
                            <div class="form-control-plaintext bg-light p-2 rounded">
                              {{ identityCardData.birthDate | date: 'dd/MM/yyyy' }}
                            </div>
                          </div>

                          <!-- Marital Status -->
                          <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">{{ "IDENTITY_CARD.MARITAL_STATUS" | translate }}</label>
                            <div class="form-control-plaintext bg-light p-2 rounded">
                              {{ translationService.currentLang === 'ar' ? identityCardData.maritalStatusAr :
                              identityCardData.maritalStatusEn }}
                            </div>
                          </div>

                          <!-- Mobile Number -->
                          <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">{{ "IDENTITY_CARD.MOBILE" | translate }}</label>
                            <div class="form-control-plaintext bg-light p-2 rounded">
                              {{ identityCardData.mobileNo || '-' }}
                            </div>
                          </div>

                          <!-- Home Phone -->
                          <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">{{ "IDENTITY_CARD.HOME_PHONE" | translate }}</label>
                            <div class="form-control-plaintext bg-light p-2 rounded">
                              {{ identityCardData.homePhone || '-' }}
                            </div>
                          </div>

                          <!-- Occupation -->
                          <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">{{ "IDENTITY_CARD.OCCUPATION" | translate }}</label>
                            <div class="form-control-plaintext bg-light p-2 rounded">
                              {{ translationService.currentLang === 'ar' ? (identityCardData.occupationAr || '-') :
                              (identityCardData.occupationEn || '-') }}
                            </div>
                          </div>

                          <!-- Address -->
                          <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">{{ "IDENTITY_CARD.ADDRESS" | translate }}</label>
                            <div class="form-control-plaintext bg-light p-2 rounded">
                              {{ translationService.currentLang === 'ar' ? (identityCardData.addressAr || '-') :
                              (identityCardData.addressEn || '-') }}
                            </div>
                          </div>

                          <!-- Issue Date -->
                          <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">{{ "IDENTITY_CARD.ISSUE_DATE" | translate }}</label>
                            <div class="form-control-plaintext bg-light p-2 rounded">
                              {{ identityCardData.issueDate | date: 'dd/MM/yyyy' }}
                            </div>
                          </div>

                          <!-- Expiry Date -->
                          <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">{{ "IDENTITY_CARD.EXPIRY_DATE" | translate }}</label>
                            <div class="form-control-plaintext bg-light p-2 rounded">
                              {{ identityCardData.expiryDate | date: 'dd/MM/yyyy' }}
                            </div>
                          </div>

                          <!-- Passport Number (if available) -->
                          <div class="col-md-6 mb-3" *ngIf="identityCardData.passportNo">
                            <label class="form-label fw-bold">{{ "IDENTITY_CARD.PASSPORT_NO" | translate }}</label>
                            <div class="form-control-plaintext bg-light p-2 rounded">
                              {{ identityCardData.passportNo }}
                            </div>
                          </div>

                          <!-- Family Persons Number -->
                          <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">{{ "IDENTITY_CARD.FAMILY_PERSONS" | translate }}</label>
                            <div class="form-control-plaintext bg-light p-2 rounded">
                              {{ identityCardData.familyPersNo || '-' }}
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Step 2: Partners -->
              <div *ngIf="currentStep === 2" class="step-content" [formGroup]="partnerForm">
                <h5 class="mb-4">
                  {{ "CHARITY_EVENT.PARTNERS_TITLE" | translate }}
                </h5>

                <div class="row">
                  <!-- Name (required) -->
                  <div class="col-xl-6 mb-3">
                    <label class="form-label">
                      {{ "PARTNERS.NAME" | translate }}
                      <span class="text-danger">*</span>
                    </label>
                    <input class="form-control" formControlName="name" [class.is-invalid]="
                        partnerForm.get('name')?.touched &&
                        partnerForm.get('name')?.invalid
                      " />
                    <div class="invalid-feedback" *ngIf="
                        partnerForm.get('name')?.touched &&
                        partnerForm.get('name')?.errors
                      ">
                      {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                    </div>
                  </div>

                  <!-- NameEn (required) -->
                  <div class="col-xl-6 mb-3">
                    <label class="form-label">
                      {{ "PARTNERS.NAME_EN" | translate }}
                      <span class="text-danger">*</span>
                    </label>
                    <input class="form-control" formControlName="nameEn" [class.is-invalid]="
                        partnerForm.get('nameEn')?.touched &&
                        partnerForm.get('nameEn')?.invalid
                      " />
                    <div class="invalid-feedback" *ngIf="
                        partnerForm.get('nameEn')?.touched &&
                        partnerForm.get('nameEn')?.errors
                      ">
                      {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                    </div>
                  </div>

                  <!-- Type (required) -->
                  <div class="col-xl-6 mb-3">
                    <label class="form-label">
                      {{ "PARTNERS.TYPE" | translate }}
                      <span class="text-danger">*</span>
                    </label>
                    <ng-select formControlName="type" [items]="partnerTypes" bindLabel="label" bindValue="id"
                      [multiple]="false" [closeOnSelect]="true" [clearable]="true" [searchable]="true"
                      [placeholder]="'COMMON.SELECT_OPTION' | translate" class="ng-select-custom" [ngClass]="{
                        'is-invalid':
                          partnerForm.get('type')?.touched &&
                          partnerForm.get('type')?.invalid
                      }" (change)="onPartnerTypeChange()">
                    </ng-select>
                    <div class="invalid-feedback" *ngIf="
                        partnerForm.get('type')?.touched &&
                        partnerForm.get('type')?.errors
                      ">
                      {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                    </div>
                  </div>

                  <!-- License Issuer (required) -->
                  <div class="col-xl-6 mb-3">
                    <label class="form-label">
                      {{ "PARTNERS.LICENSE_ISSUER" | translate }}
                      <span class="text-danger"
                        *ngIf="partnerForm.get('type')?.value == 3 || partnerForm.get('type')?.value == 4">*</span>
                    </label>
                    <input class="form-control" formControlName="licenseIssuer" [class.is-invalid]="
                        partnerForm.get('licenseIssuer')?.touched &&
                        partnerForm.get('licenseIssuer')?.invalid
                      " />
                    <div class="invalid-feedback" *ngIf="
                        partnerForm.get('licenseIssuer')?.touched &&
                        partnerForm.get('licenseIssuer')?.errors
                      && (partnerForm.get('type')?.value == 3 || partnerForm.get('type')?.value == 4) ">
                      {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                    </div>
                  </div>

                  <!-- License Number (required) -->
                  <div class="col-xl-6 mb-3">
                    <label class="form-label">
                      {{ "PARTNERS.LICENSE_NUMBER" | translate }}
                      <span class="text-danger"
                        *ngIf="partnerForm.get('type')?.value == 3 || partnerForm.get('type')?.value == 4">*</span>
                    </label>
                    <input class="form-control" formControlName="licenseNumber" [class.is-invalid]="
                        partnerForm.get('licenseNumber')?.touched &&
                        partnerForm.get('licenseNumber')?.invalid
                      " />
                    <div class="invalid-feedback" *ngIf="
                        partnerForm.get('licenseNumber')?.touched &&
                        partnerForm.get('licenseNumber')?.errors
                       && (partnerForm.get('type')?.value == 3 || partnerForm.get('type')?.value == 4)">
                      {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                    </div>
                  </div>

                  <!-- License Expiry Date (required) -->
                  <div class="col-xl-6 mb-3">
                    <label class="form-label">
                      {{ "PARTNERS.LICENSE_EXPIRY" | translate }}
                      <span class="text-danger"
                        *ngIf="partnerForm.get('type')?.value == 3 || partnerForm.get('type')?.value == 4">*</span>
                    </label>
                    <input type="date" class="form-control" formControlName="licenseExpiryDate" [class.is-invalid]="
                        partnerForm.get('licenseExpiryDate')?.touched &&
                        partnerForm.get('licenseExpiryDate')?.invalid
                      " />
                    <div class="invalid-feedback" *ngIf="
                        partnerForm.get('licenseExpiryDate')?.touched &&
                        partnerForm.get('licenseExpiryDate')?.errors
                      && (partnerForm.get('type')?.value == 3 || partnerForm.get('type')?.value == 4) ">
                      {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                    </div>
                  </div>

                  <!-- Contact Details (optional) -->
                  <!-- <div class="col-xl-6 mb-3">
                    <label class="form-label">
                      {{
                      "PARTNERS.CONTACT_DETAILS" | translate
                      }}
                    </label>
                    <textarea rows="1" class="form-control" formControlName="contactDetails"></textarea>
                  </div> -->

                  <!-- Contact Details (optional converted to required) -->
                  <div class="col-xl-6 mb-3">
                    <label class="form-label">
                      {{ 'PARTNERS.CONTACT_DETAILS' | translate }}
                      <span class="text-danger">*</span>
                    </label>

                    <!-- Mobile Number Input with UAE Flag and 971 prefix -->
                    <div class="mobile-input-container" style="border: none !important" [class.is-invalid]="
                        partnerForm.get('contactDetails')?.touched &&
                        partnerForm.get('contactDetails')?.invalid
                      ">
                      <div class="mobile-prefix-container">
                        <img src="assets/images/Flag_of_the_United_Arab_Emirates.svg.png" alt="UAE Flag"
                          class="uae-flag-image" />
                        <span class="mobile-prefix">971</span>
                      </div>
                      <input type="tel" class="form-control mobile-number-input" formControlName="contactDetails"
                        placeholder="5**********" maxlength="9" (keypress)="restrictMobileInput($event)"
                        (input)="onContactDetailsInput()" (blur)="onContactDetailsBlur()" />
                    </div>

                    <div *ngIf="
                        partnerForm.get('contactDetails')?.touched &&
                        partnerForm.get('contactDetails')?.errors
                      " class="invalid-feedback">
                      <div *ngIf="
                          partnerForm.get('contactDetails')?.hasError('required')
                        ">
                        {{ 'VALIDATION.REQUIRED_FIELD' | translate }}
                      </div>
                      <div *ngIf="
                          partnerForm.get('contactDetails')?.hasError('pattern')
                        ">
                        {{ 'VALIDATION.INVALID_PHONE_FORMAT' | translate }}
                      </div>
                    </div>
                  </div>


                  <div class="col-xl-12 mb-3">
                    <label class="form-label">
                      {{ 'FASTING_TENT_REQ.jobRequirementsDetails' | translate }}
                    </label>
                    <input type="text" class="form-control" formControlName="jobRequirementsDetails">

                  </div>
                  <!-- Partner Attachments (AttachmentsConfigType.Partner) -->
                  <!-- Partner Attachments (AttachmentsConfigType.Partner) -->
                  <div *ngIf="showPartnerAttachments" class="col-12 mt-4">
                    <h6 class="mb-3">{{ 'PARTNERS.ATTACHMENTS' | translate }}</h6>

                    <div class="table-responsive">
                      <table class="table table-striped align-middle">
                        <thead>
                          <tr>
                            <th>{{ 'ATTACHMENTS.DOCUMENT_TYPE' | translate }}</th>
                            <th>{{ 'ATTACHMENTS.FILE' | translate }}</th>
                            <th>{{ 'COMMON.ACTIONS' | translate }}</th>
                          </tr>
                        </thead>

                        <tbody>
                          <ng-container *ngFor="let cfg of state(AttachmentsConfigType.Partner).configs">
                            <tr *ngIf="isPartnerAttachmentAllowed(cfg.id!)">

                              <td>
                                <!-- {{ cfg.id}} -->
                                {{
                                getAttachmentName(AttachmentsConfigType.Partner,
                                cfg.id!)
                                }}
                              </td>

                              <td>
                                <!-- Upload area -->
                                <div *ngIf="!hasSelected(AttachmentsConfigType.Partner, cfg.id!)" class="upload-area"
                                  (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)"
                                  (drop)="onDrop($event, AttachmentsConfigType.Partner, cfg.id!)"
                                  [class.drag-over]="isDragOver">

                                  <input type="file" class="d-none" [id]="'file-partner-' + cfg.id"
                                    (change)="onFileSelected($event, AttachmentsConfigType.Partner, cfg.id!)"
                                    accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">

                                  <label [for]="'file-partner-' + cfg.id" class="upload-label">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <span>
                                      {{
                                      'ATTACHMENTS.DRAG_DROP_OR_CLICK' |
                                      translate
                                      }}
                                    </span>
                                  </label>
                                </div>

                                <!-- Preview -->
                                <div *ngIf="hasSelected(AttachmentsConfigType.Partner, cfg.id!)" class="file-preview">
                                  <span class="file-name">
                                    {{
                                    selectedFileName(AttachmentsConfigType.Partner,
                                    cfg.id!)
                                    }}
                                  </span>

                                  <img style="width: 150px; height: 100px;" *ngIf="getPreview(AttachmentsConfigType.Partner, cfg.id!)
                              && state(AttachmentsConfigType.Partner).selected[cfg.id!].type?.startsWith('image/')"
                                    [src]="getPreview(AttachmentsConfigType.Partner, cfg.id!)" class="preview-image">
                                </div>
                              </td>

                              <td>
                                <button *ngIf="hasSelected(AttachmentsConfigType.Partner, cfg.id!)" type="button"
                                  class="btn btn-sm btn-danger"
                                  (click)="removeFile(AttachmentsConfigType.Partner, cfg.id!)">
                                  {{ 'COMMON.REMOVE' | translate }}
                                </button>
                              </td>
                            </tr>
                          </ng-container>
                        </tbody>

                      </table>
                    </div>
                  </div>
                  <!-- Add Button -->
                  <div class="col-12 d-flex justify-content-end">
                    <button type="button" class="btn btn-primary" (click)="addPartner()">
                      {{ "COMMON.ADD" | translate }}
                    </button>
                  </div>
                </div>

                <!-- Table -->
                <div class="table-responsive mt-4" *ngIf="partners.length > 0">
                  <table class="table table-striped">
                    <thead>
                      <tr>
                        <th>#</th>
                        <th>{{ "PARTNERS.NAME" | translate }}</th>
                        <th>{{ "PARTNERS.TYPE" | translate }}</th>
                        <th>{{ "PARTNERS.LICENSE_ISSUER" | translate }}</th>
                        <th>{{ "PARTNERS.LICENSE_NUMBER" | translate }}</th>
                        <th>{{ "PARTNERS.LICENSE_EXPIRY" | translate }}</th>
                        <th>{{ "PARTNERS.CONTACT_DETAILS" | translate }}</th>
                        <th>{{ "COMMON.ACTIONS" | translate }}</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let p of partners; let i = index">
                        <td>{{ i + 1 }}</td>
                        <td>{{ p.name }}</td>
                        <td>{{ getPartnerTypeLabel(p.type) }}</td>
                        <td>{{ p.licenseIssuer }}</td>
                        <td>{{ p.licenseNumber }}</td>
                        <td>{{ p.licenseExpiryDate | date : "dd/MM/yyyy" }}</td>
                        <td>{{ p.contactDetails }}</td>
                        <td>
                          <button type="button" class="btn btn-sm btn-danger" (click)="removePartner(i)">
                            {{ "COMMON.REMOVE" | translate }}
                          </button>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Step 3: Advertisements Ads -->
              <div *ngIf="currentStep === adsStepIndex && advertForm" class="step-content" [formGroup]="advertForm">
                <h5 class="mb-4">
                  {{ "CHARITY_EVENT.ADS_STEP_TITLE" | translate }}
                </h5>

                <!-- hidden / readonly system fields to exist in form -->
                <input type="hidden" formControlName="parentId" />
                <input type="hidden" formControlName="mainApplyServiceId" />
                <input type="hidden" formControlName="requestNo" />
                <!-- <input type="hidden" formControlName="userId" /> -->
                <input type="hidden" formControlName="requestEventPermitId" />

                <div class="row">
                  <!-- Request Date (readonly visual) -->
                  <!-- <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{
                      "CHARITY_EVENT.REQUEST_DATE" | translate
                      }}
                    </label>
                    <div class="form-control" readonly>
                      {{ advertForm.value.requestDate | date : "dd/MM/yyyy HH:mm" }}
                    </div>
                  </div> -->

                  <!-- Provider (optional) -->
                  <!-- <div class="col-xl-6 mb-4">
                                        <label class="form-label">{{ 'CHARITY_EVENT.PROVIDER' | translate }}</label>
                                        <input class="form-control" formControlName="provider">
                                    </div> -->
                  <!-- Title (required) -->
                  <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{ "CHARITY_EVENT.AD_TITLE" | translate }}
                      <span class="text-danger">*</span>
                    </label>
                    <input class="form-control" formControlName="adTitle" [class.is-invalid]="
                        advertForm.get('adTitle')?.touched &&
                        advertForm.get('adTitle')?.invalid
                      " />
                    <div class="invalid-feedback" *ngIf="
                        advertForm.get('adTitle')?.touched &&
                        advertForm.get('adTitle')?.errors
                      ">
                      {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                    </div>
                  </div>

                  <!-- Language (required) -->
                  <!-- <div class="col-xl-6 mb-4">
                                        <label class="form-label">
                                            {{ 'CHARITY_EVENT.AD_LANG' | translate }} <span class="text-danger">*</span>
                                        </label>
                                        <ng-select formControlName="adLang" [items]="languages" bindLabel="text"
                                            bindValue="id" [multiple]="false" [closeOnSelect]="true" [clearable]="false"
                                            [searchable]="false" class="ng-select-custom"
                                            [ngClass]="{'is-invalid': advertForm.get('adLang')?.touched && advertForm.get('adLang')?.invalid}">
                                        </ng-select>
                                        <div class="invalid-feedback"
                                            *ngIf="advertForm.get('adLang')?.touched && advertForm.get('adLang')?.errors">
                                            {{ 'VALIDATION.REQUIRED_FIELD' | translate }}
                                        </div>
                                    </div> -->
                  <!-- Service Type (required) -->
                  <!-- <div class="col-xl-6 mb-4">
                                        <label class="form-label">
                                            {{ 'CHARITY_EVENT.SERVICE_TYPE' | translate }} <span
                                                class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" formControlName="serviceType"
                                            [class.is-invalid]="advertForm.get('serviceType')?.touched && advertForm.get('serviceType')?.invalid">
                                            <option [ngValue]="1">{{ 'CHARITY_EVENT.SERVICE_TYPE_1' | translate }}
                                            </option>
                                            <option [ngValue]="2">{{ 'CHARITY_EVENT.SERVICE_TYPE_2' | translate }}
                                            </option>
                                        </select>
                                        <div class="invalid-feedback"
                                            *ngIf="advertForm.get('serviceType')?.touched && advertForm.get('serviceType')?.errors">
                                            {{ 'VALIDATION.REQUIRED_FIELD' | translate }}
                                        </div>
                                    </div> -->
                  <!-- Workflow Type (required) -->
                  <!-- <div class="col-xl-6 mb-4">
                                        <label class="form-label">
                                            {{ 'CHARITY_EVENT.WORKFLOW_SERVICE_TYPE' | translate }} <span
                                                class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" formControlName="workFlowServiceType"
                                            [class.is-invalid]="advertForm.get('workFlowServiceType')?.touched && advertForm.get('workFlowServiceType')?.invalid">
                                            <option [ngValue]="1">{{ 'CHARITY_EVENT.WORKFLOW_TYPE_1' | translate }}
                                            </option>
                                            <option [ngValue]="2">{{ 'CHARITY_EVENT.WORKFLOW_TYPE_2' | translate }}
                                            </option>
                                        </select>
                                        <div class="invalid-feedback"
                                            *ngIf="advertForm.get('workFlowServiceType')?.touched && advertForm.get('workFlowServiceType')?.errors">
                                            {{ 'VALIDATION.REQUIRED_FIELD' | translate }}
                                        </div>
                                    </div> -->
                  <!-- Date range (required) -->
                  <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{ "CHARITY_EVENT.START_DATE" | translate }}
                      <span class="text-danger">*</span>
                    </label>
                    <input type="datetime-local" class="form-control" formControlName="startDate" [class.is-invalid]="
                        (advertForm.get('startDate')?.touched &&
                          advertForm.get('startDate')?.invalid) ||
                        advertForm.hasError('dateRange') ||
                        advertForm.hasError('startBeforeToday')
                      " />
                    <div class="invalid-feedback d-block" *ngIf="
                        advertForm.get('startDate')?.touched &&
                        advertForm.get('startDate')?.errors
                      ">
                      <div *ngIf="advertForm.get('startDate')?.hasError('required')">
                        {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                      </div>
                    </div>
                    <div class="invalid-feedback d-block" style="color:red" *ngIf="advertForm.hasError('startBeforeToday')">
                      {{ 'VALIDATION.START_NOT_BEFORE_TODAY' | translate }}
                    </div>
                  </div>

                  <div class="col-xl-6 mb-1">
                    <label class="form-label">
                      {{ "CHARITY_EVENT.END_DATE" | translate }}
                      <span class="text-danger">*</span>
                    </label>
                    <input type="datetime-local" class="form-control" formControlName="endDate" [class.is-invalid]="
                        (advertForm.get('endDate')?.touched &&
                          advertForm.get('endDate')?.invalid) ||
                        advertForm.hasError('dateRange')
                      " />
                    <div class="invalid-feedback d-block" *ngIf="
                        advertForm.get('endDate')?.touched &&
                        advertForm.get('endDate')?.errors
                      ">
                      <div *ngIf="advertForm.get('endDate')?.hasError('required')">
                        {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                      </div>
                    </div>
                  </div>

                  <div class="col-12 mb-4" *ngIf="advertForm.hasError('dateRange')">
                    <div class="invalid-feedback d-block">
                      {{ "VALIDATION.DATE_RANGE" | translate }}
                    </div>
                  </div>

                  <!-- Contact info (all optional) -->
                  <!-- <div class="col-xl-6 mb-4">
                                        <label class="form-label">{{ 'CHARITY_EVENT.MOBILE' | translate }}</label>
                                        <input type="tel" class="form-control" formControlName="mobile">
                                    </div>

                                    <div class="col-xl-6 mb-4">
                                        <label class="form-label">{{ 'CHARITY_EVENT.SUPERVISOR_NAME' | translate
                                            }}</label>
                                        <input class="form-control" formControlName="supervisorName">
                                    </div>

                                    <div class="col-xl-6 mb-4">
                                        <label class="form-label">{{ 'CHARITY_EVENT.FAX' | translate }}</label>
                                        <input class="form-control" formControlName="fax">
                                    </div>

                                    <div class="col-xl-6 mb-4">
                                        <label class="form-label">{{ 'CHARITY_EVENT.EMAIL' | translate }}</label>
                                        <input type="email" class="form-control" formControlName="eMail"
                                            [class.is-invalid]="advertForm.get('eMail')?.touched && advertForm.get('eMail')?.invalid">
                                        <div class="invalid-feedback"
                                            *ngIf="advertForm.get('eMail')?.touched && advertForm.get('eMail')?.errors">
                                            {{ 'VALIDATION.INVALID_EMAIL' | translate }}
                                        </div>
                                    </div> -->
                  <!-- Targeted Amount (optional) -->
                  <!-- <div class="col-xl-6 mb-4">
                                        <label class="form-label">{{ 'CHARITY_EVENT.TARGETED_AMOUNT' | translate
                                            }}</label>
                                        <input type="number" class="form-control" formControlName="targetedAmount">
                                    </div> -->
                  <!-- New / Renew + oldPermNumber -->
                  <!-- <div class="col-xl-6 mb-4">
                                        <label class="form-label d-block">{{ 'CHARITY_EVENT.AD_STATUS' | translate
                                            }}</label>

                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" id="adNew" name="adMode"
                                                (change)="onAdModeChange('new')"
                                                [checked]="advertForm.value.newAd === true">
                                            <label class="form-check-label" for="adNew">{{ 'CHARITY_EVENT.AD_NEW' |
                                                translate }}</label>
                                        </div>

                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" id="adRenew" name="adMode"
                                                (change)="onAdModeChange('renew')"
                                                [checked]="advertForm.value.reNewAd === true">
                                            <label class="form-check-label" for="adRenew">{{ 'CHARITY_EVENT.AD_RENEW' |
                                                translate }}</label>
                                        </div>

                                        <div class="mt-3" *ngIf="advertForm.value.reNewAd === true">
                                            <label class="form-label">
                                                {{ 'CHARITY_EVENT.OLD_PERM_NUMBER' | translate }} <span
                                                    class="text-danger">*</span>
                                            </label>
                                            <input class="form-control" formControlName="oldPermNumber"
                                                [class.is-invalid]="advertForm.hasError('oldPermRequired') && (advertForm.get('oldPermNumber')?.touched || submitted)">
                                            <div class="invalid-feedback"
                                                *ngIf="advertForm.hasError('oldPermRequired')">
                                                {{ 'VALIDATION.REQUIRED_FIELD' | translate }}
                                            </div>
                                        </div>
                                    </div> -->
                  <!-- Targets (multi) -> requestAdvertisementTargets -->
                  <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{ "CHARITY_EVENT.TARGET_TYPES" | translate }}
                      <span class="text-danger">*</span>
                    </label>
                    <ng-select formControlName="targetTypeIds" [items]="advertisementTargetType" bindLabel="text"
                      bindValue="id" [multiple]="true" [closeOnSelect]="false" [clearable]="true" [searchable]="true"
                      [placeholder]="'COMMON.SELECT_OPTION' | translate" class="ng-select-custom" [ngClass]="{
                        'is-invalid':
                          advertForm.get('targetTypeIds')?.touched &&
                          advertForm.get('targetTypeIds')?.invalid
                      }">
                    </ng-select>
                    <div class="invalid-feedback d-block" *ngIf="
                        advertForm.get('targetTypeIds')?.touched &&
                        advertForm.get('targetTypeIds')?.invalid
                      ">
                      <div *ngIf="advertForm.get('targetTypeIds')?.hasError('required')">
                        {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                      </div>
                      <div *ngIf="advertForm.get('targetTypeIds')?.hasError('minArrayLength')">
                        {{ "VALIDATION.MIN_ONE_TARGET" | translate }}
                      </div>
                    </div>
                  </div>

                  <!-- Methods (multi) -> requestAdvertisementAdMethods -->
                  <div class="col-xl-6 mb-4">
                    <label class="form-label">
                      {{ "CHARITY_EVENT.AD_METHODS" | translate }}
                      <span class="text-danger">*</span>
                    </label>
                    <ng-select formControlName="adMethodIds" [items]="advertisementMethodType" bindLabel="text"
                      bindValue="id" [multiple]="true" [closeOnSelect]="false" [clearable]="true" [searchable]="true"
                      [placeholder]="'COMMON.SELECT_OPTION' | translate" class="ng-select-custom" [ngClass]="{
                        'is-invalid':
                          advertForm.get('adMethodIds')?.touched &&
                          advertForm.get('adMethodIds')?.invalid
                      }">
                    </ng-select>
                    <div class="invalid-feedback d-block" *ngIf="
                        advertForm.get('adMethodIds')?.touched &&
                        advertForm.get('adMethodIds')?.invalid
                      ">
                      <div *ngIf="advertForm.get('adMethodIds')?.hasError('required')">
                        {{ "VALIDATION.REQUIRED_FIELD" | translate }}
                      </div>
                      <div *ngIf="advertForm.get('adMethodIds')?.hasError('minArrayLength')">
                        {{ "VALIDATION.MIN_ONE_METHOD" | translate }}
                      </div>
                    </div>
                  </div>

                  <!-- Locations (chips) -> requestAdvertisementAdLocations -->
                  <div class="col-xl-12 mb-2">
                    <label class="form-label">
                      {{ "CHARITY_EVENT.AD_LOCATIONS" | translate }}
                      <span class="text-danger">*</span>
                    </label>

                    <div class="d-flex gap-2 mb-2">
                      <input class="form-control" [(ngModel)]="newLocationInput" [ngModelOptions]="{ standalone: true }"
                        name="newLocationInput" placeholder="{{
                          'CHARITY_EVENT.ADD_LOCATION_PLACEHOLDER' | translate
                        }}" />
                      <button type="button" class="btn btn-outline-primary" (click)="addLocation()">
                        {{ "COMMON.ADD" | translate }}
                      </button>
                    </div>

                    <div class="d-flex flex-wrap gap-2">
                      <span class="badge bg-secondary" *ngFor="let loc of adLocations; let i = index">
                        {{ loc }}
                        <button type="button" class="btn-close btn-close-white btn-sm ms-1" aria-label="Close"
                          (click)="removeLocation(i)"></button>
                      </span>
                    </div>

                    <div class="invalid-feedback d-block mt-1" *ngIf="(submitted || advertForm.get('adLocations')?.touched) && adLocations.length === 0">
                      {{ "VALIDATION.MIN_ONE_LOCATION" | translate }}
                    </div>
                  </div>
                </div>

                <div class="col-xl-12 mb-2">
                  <label class="form-label">{{ 'CHARITY_EVENT.NOTES' | translate }}</label>
                  <textarea class="form-control" rows="3" formControlName="notes"
                    [placeholder]="'CHARITY_EVENT.NOTES_PLACEHOLDER' | translate"></textarea>
                </div>

                <!-- Ad Attachments (RequestAnEventAnnouncementOrDonationCampaign) -->
                <div class="mt-4">
                  <h6 class="mb-3">
                    {{ "PROFILE.DOCUMENTS" | translate }}
                  </h6>

                  <div class="table-responsive">
                    <table class="table table-striped align-middle">
                      <thead>
                        <tr>
                          <th>{{ "ATTACHMENTS.DOCUMENT_TYPE" | translate }}</th>
                          <th>{{ "ATTACHMENTS.FILE" | translate }}</th>
                          <th>{{ "COMMON.ACTIONS" | translate }}</th>
                        </tr>
                      </thead>

                      <tr *ngFor="
  let cfg of state(AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign).configs
">
  <!-- نوع المستند -->
  <td class="align-middle">
    {{ getAttachmentName(AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign, cfg.id!) }}
    <span *ngIf="isMandatory(cfg)" class="text-danger ms-1">*</span>

    <!-- تم الرفع -->
    <div *ngIf="isMandatory(cfg)
                && hasSelected(AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign, cfg.id!)"
         class="text-success small mt-1">
      <i class="fas fa-check-circle"></i> {{ 'VALIDATION.UPLOADED' | translate }}
    </div>
  </td>

  <!-- الملف -->
  <td class="align-middle">
    <!-- منطقة الرفع -->
    <div *ngIf="!hasSelected(AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign, cfg.id!)"
         class="upload-area"
         (dragover)="onDragOver($event)"
         (dragleave)="onDragLeave($event)"
         (drop)="onDrop($event, AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign, cfg.id!)"
         [class.drag-over]="isDragOver"
         [class.border-danger]="isMandatory(cfg)
                                && !hasSelected(AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign, cfg.id!)
                                && (currentStep === 4 || submitted)"
         [class.border-success]="hasSelected(AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign, cfg.id!)">

      <input type="file" class="d-none"
             [id]="'file-reqAd-' + cfg.id"
             (change)="onFileSelected($event, AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign, cfg.id!)"
             accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" />

      <label [for]="'file-reqAd-' + cfg.id" class="upload-label">
        <i class="fas fa-cloud-upload-alt"></i>
        <span>{{ 'ATTACHMENTS.DRAG_DROP_OR_CLICK' | translate }}</span>
      </label>
    </div>

    <!-- المعاينة -->
    <div *ngIf="hasSelected(AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign, cfg.id!)"
         class="file-preview">
      <span class="file-name">
        {{ selectedFileName(AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign, cfg.id!) }}
      </span>

      <img style="width:150px;height:100px"
           *ngIf="getPreview(AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign, cfg.id!)
                  && state(AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign)
                        .selected[cfg.id!]?.type?.startsWith('image/')"
           [src]="getPreview(AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign, cfg.id!)"
           class="preview-image" />
    </div>

    <!-- رسالة: المرفق مطلوب -->
    <div *ngIf="isMandatory(cfg)
                && !hasSelected(AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign, cfg.id!)
                && (currentStep === 3 || submitted)"
         class="mt-2 d-flex align-items-center gap-2 text-danger">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M12 2L1 21h22L12 2z" stroke="currentColor" fill="none"/>
        <path d="M12 8v6M12 17v1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span>{{ 'VALIDATION.ATTACHMENT_REQUIRED' | translate }}</span>
    </div>
  </td>

  <!-- الإجراءات -->
  <td class="align-middle">
    <button *ngIf="hasSelected(AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign, cfg.id!)"
            type="button" class="btn btn-sm btn-danger"
            (click)="removeFile(AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign, cfg.id!)">
      {{ 'COMMON.REMOVE' | translate }}
    </button>
  </td>
</tr>

                    </table>
                  </div>
                </div>

                <!-- Add button -->
                <div class="d-flex justify-content-end mt-3">
                  <button type="button" class="btn btn-primary" (click)="addAdvertisement()">
                    {{ "COMMON.ADD" | translate }}
                  </button>
                </div>

                <!-- Table -->
                <div class="table-responsive mt-4" *ngIf="requestAdvertisements.length > 0">
                  <table class="table table-striped align-middle">
                    <thead>
                      <tr>
                        <th>#</th>
                        <th>{{ "CHARITY_EVENT.AD_TITLE" | translate }}</th>
                        <th>{{ "CHARITY_EVENT.AD_LANG" | translate }}</th>
                        <th>
                          {{ "CHARITY_EVENT.DATE_RANGE_COL" | translate }}
                        </th>
                        <th>
                          {{ "CHARITY_EVENT.TARGETED_AMOUNT" | translate }}
                        </th>
                        <th>{{ "CHARITY_EVENT.TARGETS_COUNT" | translate }}</th>
                        <th>{{ "CHARITY_EVENT.METHODS_COUNT" | translate }}</th>
                        <th>
                          {{ "CHARITY_EVENT.LOCATIONS_COUNT" | translate }}
                        </th>
                        <th>{{ "COMMON.ACTIONS" | translate }}</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let ad of requestAdvertisements; let i = index">
                        <td>{{ i + 1 }}</td>
                        <td>{{ ad.adTitle }}</td>
                        <td>{{ ad.adLang | uppercase }}</td>
                        <td>
                          <div class="small">
                            <div>{{ ad.startDate | date : "dd/MM/yyyy HH:mm" }}</div>
                            <div>{{ ad.endDate | date : "dd/MM/yyyy HH:mm" }}</div>
                          </div>
                        </td>
                        <td>{{ ad.targetedAmount || "-" }}</td>
                        <td>{{ len(ad.requestAdvertisementTargets) }}</td>
                        <td>{{ len(ad.requestAdvertisementAdMethods) }}</td>
                        <td>{{ len(ad.requestAdvertisementAdLocations) }}</td>
                        <td>
                          <button type="button" class="btn btn-sm btn-danger" (click)="removeAdvertisement(i)">
                            {{ "COMMON.REMOVE" | translate }}
                          </button>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <!-- Step 4: Attachment -->
              <div *ngIf="currentStep === 4" class="step-content">
                <h5 class="mb-4">
                  {{ "REQUEST_PLAINT.ATTACHMENTS" | translate }}
                </h5>

                <div class="table-responsive">
                  <table class="table table-striped">
                    <thead>
                      <tr>
                        <th>{{ "ATTACHMENTS.DOCUMENT_TYPE" | translate }}</th>
                        <th>{{ "ATTACHMENTS.FILE" | translate }}</th>
                        <th>{{ "COMMON.ACTIONS" | translate }}</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="
  let config of state(AttachmentsConfigType.RequestAnEventOrDonationCampaignPermit).configs
">
                        <!-- نوع المستند -->
                        <td class="align-middle">
                          {{ getAttachmentName(AttachmentsConfigType.RequestAnEventOrDonationCampaignPermit, config.id!)
                          }}
                          <span *ngIf="isMandatory(config)" class="text-danger ms-1">*</span>

                          <!-- تم الرفع -->
                          <div
                            *ngIf="isMandatory(config) && hasSelected(AttachmentsConfigType.RequestAnEventOrDonationCampaignPermit, config.id!)"
                            class="text-success small mt-1">
                            <i class="fas fa-check-circle"></i> {{ 'VALIDATION.UPLOADED' | translate }}
                          </div>
                        </td>

                        <!-- الملف -->
                        <td class="align-middle">
                          <!-- منطقة الرفع (تظهر عندما لا يوجد ملف محدد ولا يوجد مرفق موجود) -->
                          <div
                            *ngIf="!state(AttachmentsConfigType.RequestAnEventOrDonationCampaignPermit).selected[config.id!] && !existingAttachments[config.id!]"
                            class="upload-area" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)"
                            (drop)="onDrop($event, AttachmentsConfigType.RequestAnEventOrDonationCampaignPermit, config.id!)"
                            [class.drag-over]="isDragOver" [class.border-danger]="isMandatory(config)
                                && !state(AttachmentsConfigType.RequestAnEventOrDonationCampaignPermit).selected[config.id!] && !existingAttachments[config.id!]
                                && (currentStep === 4 || submitted)"
                            [class.border-success]="state(AttachmentsConfigType.RequestAnEventOrDonationCampaignPermit).selected[config.id!] || existingAttachments[config.id!]">

                            <input type="file" class="d-none" [id]="'file-permit-' + config.id"
                              (change)="onFileSelected($event, AttachmentsConfigType.RequestAnEventOrDonationCampaignPermit, config.id!)"
                              accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" />

                            <label [for]="'file-permit-' + config.id" class="upload-label">
                              <i class="fas fa-cloud-upload-alt"></i>
                              <span>{{ 'ATTACHMENTS.DRAG_DROP_OR_CLICK' | translate }}</span>
                            </label>
                          </div>

                          <!-- عرض الملف الموجود (existing attachment) -->
                          <div *ngIf="existingAttachments[config.id!] && !state(AttachmentsConfigType.RequestAnEventOrDonationCampaignPermit).selected[config.id!]" 
                               class="file-preview existing-attachment-container"
                               style="position: relative;">
                            <div class="d-flex align-items-center gap-3">
                              <!-- Preview Image/Icon -->
                              <div style="position: relative; display: inline-block;">
                                <img style="width:150px;height:100px"
                                     *ngIf="getPreview(AttachmentsConfigType.RequestAnEventOrDonationCampaignPermit, config.id!) && isImageFile(existingAttachments[config.id!]?.imgPath)"
                                     [src]="getPreview(AttachmentsConfigType.RequestAnEventOrDonationCampaignPermit, config.id!)"
                                     class="preview-image">
                                <div *ngIf="!getPreview(AttachmentsConfigType.RequestAnEventOrDonationCampaignPermit, config.id!) || !isImageFile(existingAttachments[config.id!]?.imgPath)"
                                     class="file-icon">
                                  <i class="fas fa-file"></i>
                                </div>
                                
                                <!-- Hover overlay with edit button -->
                                <div class="attachment-hover-overlay">
                                  <button type="button"
                                          class="btn btn-sm btn-primary"
                                          (click)="triggerFileInput(config.id!, AttachmentsConfigType.RequestAnEventOrDonationCampaignPermit); $event.stopPropagation()"
                                          title="{{ 'EDIT_PROFILE.UPDATE_ATTACHMENT' | translate }}">
                                    <i class="fas fa-edit"></i>
                                    {{ 'COMMON.UPDATE' | translate }}
                                  </button>
                                  <button type="button"
                                          class="btn btn-sm btn-info"
                                          (click)="viewAttachment(config.id!); $event.stopPropagation()"
                                          title="{{ 'COMMON.VIEW' | translate }}">
                                    <i class="fas fa-eye"></i>
                                    {{ 'COMMON.VIEW' | translate }}
                                  </button>
                                </div>
                              </div>
                              
                              <!-- File Info and Actions -->
                              <div class="d-flex flex-column gap-2">
                                <span class="file-name">
                                  {{ getFileNameFromPath(existingAttachments[config.id!]?.imgPath) }}
                                </span>
                                
                                <!-- Action Buttons -->
                                <div class="d-flex gap-2">
                                  <button type="button"
                                          class="btn btn-sm btn-info"
                                          (click)="viewAttachment(config.id!)"
                                          [title]="'COMMON.VIEW' | translate">
                                    <i class="fas fa-eye me-1"></i>
                                    {{ 'COMMON.VIEW' | translate }}
                                  </button>
                                  
                                  <button type="button"
                                          class="btn btn-sm btn-primary"
                                          (click)="triggerFileInput(config.id!, AttachmentsConfigType.RequestAnEventOrDonationCampaignPermit)"
                                          [title]="'COMMON.UPDATE' | translate">
                                    <i class="fas fa-edit me-1"></i>
                                    {{ 'COMMON.UPDATE' | translate }}
                                  </button>
                                  
                                  <button type="button"
                                          class="btn btn-sm btn-danger"
                                          (click)="removeExistingFile(config.id!)"
                                          [title]="'COMMON.DELETE' | translate">
                                    <i class="fas fa-trash me-1"></i>
                                    {{ 'COMMON.DELETE' | translate }}
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>

                          <!-- المعاينة (للملفات الجديدة المحددة) -->
                          <div
                            *ngIf="state(AttachmentsConfigType.RequestAnEventOrDonationCampaignPermit).selected[config.id!]"
                            class="file-preview">
                            <span class="file-name">
                              {{ selectedFileName(AttachmentsConfigType.RequestAnEventOrDonationCampaignPermit,
                              config.id!) }}
                            </span>
                            <img style="width:150px;height:100px"
                              *ngIf="getPreview(AttachmentsConfigType.RequestAnEventOrDonationCampaignPermit, config.id!)
                  && state(AttachmentsConfigType.RequestAnEventOrDonationCampaignPermit).selected[config.id!]?.type?.startsWith('image/')"
                              [src]="getPreview(AttachmentsConfigType.RequestAnEventOrDonationCampaignPermit, config.id!)"
                              class="preview-image" />
                          </div>

                          <!-- رسالة المرفق مطلوب -->
                          <div *ngIf="isMandatory(config)
                && !state(AttachmentsConfigType.RequestAnEventOrDonationCampaignPermit).selected[config.id!] && !existingAttachments[config.id!]
                && (currentStep === 4 || submitted)" class="mt-2 d-flex align-items-center gap-2 text-danger">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                              fill="none">
                              <path d="M12 2L1 21h22L12 2z" stroke="currentColor" fill="none" />
                              <path d="M12 8v6M12 17v1" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                            </svg>
                            <span>{{ 'VALIDATION.ATTACHMENT_REQUIRED' | translate }}</span>
                          </div>
                        </td>

                        <!-- الإجراءات -->
                        <td class="align-middle">
                          <button
                            *ngIf="state(AttachmentsConfigType.RequestAnEventOrDonationCampaignPermit).selected[config.id!] || existingAttachments[config.id!]"
                            type="button" class="btn btn-sm btn-danger"
                            (click)="removeFile(AttachmentsConfigType.RequestAnEventOrDonationCampaignPermit, config.id!)">
                            {{ 'COMMON.REMOVE' | translate }}
                          </button>
                        </td>
                      </tr>

                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Navigation Buttons -->
              <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-secondary" (click)="previousStep()" [disabled]="currentStep === 1">
                  <i class="fas me-2" [ngClass]="isRtl ? 'fa-arrow-right' : 'fa-arrow-left'"></i>
                  {{ "COMMON.PREVIOUS" | translate }}
                </button>

                <div class="d-flex gap-2 align-items-center">
                  <button *ngIf="currentStep < totalSteps" type="button" class="btn btn-primary"
                    (click)="handleNextClick()" [disabled]="isLoading || !isFormInitialized || isSaving">
                    {{ "COMMON.NEXT" | translate }}
                    <i class="fas ms-2" [ngClass]="isRtl ? 'fa-arrow-left' : 'fa-arrow-right'"></i>
                  </button>

                  <!-- Save as Draft button - available in all tabs -->
                  <button *ngIf="currentStep < totalSteps" type="button" class="btn btn-outline-secondary"
                    (click)="onSaveDraft()" [disabled]="isSaving || !isFormInitialized">
                    <span *ngIf="isSaving" class="spinner-border spinner-border-sm me-2"></span>
                    {{ 'COMMON.SAVE_AS_DRAFT' | translate }}
                  </button>

                  <div *ngIf="currentStep === totalSteps" class="d-flex align-items-center gap-2">
                    <div *ngIf="!canSubmit()" class="me-3">
                      <small class="text-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        {{ 'VALIDATION.COMPLETE_ALL_REQUIRED_FIELDS_TO_SUBMIT' | translate }}
                      </small>
                    </div>
                    <!--<button type="button" class="btn btn-outline-secondary"
                            (click)="onSaveDraft()" [disabled]="isSaving || !isFormInitialized">
                      <span *ngIf="isSaving" class="spinner-border spinner-border-sm me-2"></span>
                      {{ 'COMMON.SAVE_AS_DRAFT' | translate }}
                    </button>-->

                    <button type="button" class="btn btn-outline-secondary"
                            (click)="onSaveDraft()">
                      <span *ngIf="isSaving" class="spinner-border spinner-border-sm me-2"></span>
                      {{ 'COMMON.SAVE_AS_DRAFT' | translate }}
                    </button>
                    <button type="button" class="btn" [class.btn-success]="canSubmit()"
                            [class.btn-outline-secondary]="!canSubmit()" (click)="onSubmit()"
                            [disabled]="!canSubmit() || isSaving">
                      <span *ngIf="isSaving" class="spinner-border spinner-border-sm me-2"></span>
                      <i *ngIf="!isSaving" class="fas fa-paper-plane me-2"></i>
                      {{ "COMMON.SUBMIT" | translate }}
                    </button>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>



<div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="historyModalLabel" class="modal-title">
          {{ 'WORKFLOW.HISTORY' | translate }}
        </h5>
        <button type="button" class="btn-close" (click)="closeHistoryModal()" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <ng-container *ngIf="historyForModal?.length; else noHistory">

          <div class="history-timeline">
            <div class="history-item" *ngFor="let h of historyForModal; let i = index">
              <div class="dot"></div>
              <div class="content">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <small class="text-muted">
                    {{ h.historyDate | date:'dd/MM/yyyy HH:mm' }}
                  </small>
                </div>

                <div class="mb-1">
                  <small class="text-muted">{{ 'mainApplyServiceResourceName.WORKFLOW.BY' | translate }}:</small>
                  <span>{{ h.userName }}</span>
                </div>

                <div class="mb-1" *ngIf="h.fromDepartmentName">
                  <small class="text-muted">{{ 'mainApplyServiceResourceName.WORKFLOW.FROM_DEPT' | translate }}:</small>
                  <span>{{ h.fromDepartmentName }}</span>
                </div>

                <div class="mb-1" *ngIf="h.toDepartmentName">
                  <small class="text-muted">{{ 'mainApplyServiceResourceName.WORKFLOW.TO_DEPT' | translate }}:</small>
                  <span>{{ h.toDepartmentName }}</span>
                </div>

                <div class="mb-1" *ngIf="getHistoryNote(h)">
                  <small class="text-muted">{{ 'mainApplyServiceResourceName.WORKFLOW.NOTE' | translate }}:</small>
                  <span>{{ getHistoryNote(h) }}</span>
                </div>

                <div class="mb-1" *ngIf="h.description">
                  <small class="text-muted">{{ 'mainApplyServiceResourceName.WORKFLOW.DESCRIPTION' | translate
                    }}:</small>
                  <span>{{ h.description }}</span>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <ng-template #noHistory>
          <div class="text-center text-muted py-4">
            {{ 'WORKFLOW.NO_HISTORY' | translate }}
          </div>
        </ng-template>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" (click)="closeHistoryModal()">
          {{ 'COMMON.CLOSE' | translate }}
        </button>
      </div>
    </div>
  </div>
</div>
