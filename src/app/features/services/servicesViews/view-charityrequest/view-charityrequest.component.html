<div class="view-charity-event-permit-container">
  <section>
    <div class="container services">



      <!-- Loading (kept as in original) -->
      <div *ngIf="!mainApplyService" class="text-center py-5">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">{{ 'COMMON.LOADING' | translate }}</span>
        </div>
        <p class="mt-3">{{ 'COMMON.LOADING_DATA' | translate }}</p>
      </div>

      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a routerLink="/request">{{ 'NAVIGATION.REQUEST' | translate }}</a></li>
          <li class="breadcrumb-item active" aria-current="page">
            {{ 'CHARITY_EVENT_PERMIT.VIEW_TITLE' | translate }}
          </li>
        </ol>
      </nav>
      <!-- Main Content -->
      <div *ngIf="mainApplyService">

        <div class="service-info-card mb-4 ">


          <div class="w-100">
            <div class="d-flex align-items-center justify-content-between gap-3 mb-2">
              <h4 class="title ">{{ 'CHARITY_EVENT_PERMIT.VIEW_TITLE' | translate }}</h4>

              <div class="dropdown"
                *ngIf="(targetWorkFlowStep && mainApplyService?.serviceStatus === 7)||(mainApplyService?.serviceStatus === 1)">
                <button class="btn btn-gold dropdown-toggle" type="button" data-bs-toggle="dropdown"
                  aria-expanded="false" style="padding: 12px !important;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path
                      d="M17 11H13V7C13 6.73478 12.8946 6.48043 12.7071 6.29289C12.5196 6.10536 12.2652 6 12 6C11.7348 6 11.4804 6.10536 11.2929 6.29289C11.1054 6.48043 11 6.73478 11 7V11H7C6.73478 11 6.48043 11.1054 6.29289 11.2929C6.10536 11.4804 6 11.7348 6 12C6 12.2652 6.10536 12.5196 6.29289 12.7071C6.48043 12.8946 6.73478 13 7 13H11V17C11 17.2652 11.1054 17.5196 11.2929 17.7071C11.4804 17.8946 11.7348 18 12 18C12.2652 18 12.5196 17.8946 12.7071 17.7071C12.8946 17.5196 13 17.2652 13 17V13H17C17.2652 13 17.5196 12.8946 17.7071 12.7071C17.8946 12.5196 18 12.2652 18 12C18 11.7348 17.8946 11.4804 17.7071 11.2929C17.5196 11.1054 17.2652 11 17 11Z"
                      fill="white" />
                  </svg>
                </button>
                <ul class="dropdown-menu">
                  <li>
                    <a class="dropdown-item" *ngIf="targetWorkFlowStep && mainApplyService?.serviceStatus === 7"
                      data-bs-toggle="modal" data-bs-target="#commentModal">{{ 'COMMON.ADD_COMMENT' | translate }}</a>
                  </li>
                  <li>
                    <a class="dropdown-item" *ngIf="mainApplyService?.serviceStatus === 1" data-bs-toggle="modal"
                      data-bs-target="#addAdvertisementModal">{{'ADD_ADVERTISEMENT' | translate}}</a>
                  </li>
                </ul>
              </div>


            </div>
            <div class="row">
              <div class="col-xl-6">
                <p class="mb-1">
                  <strong>{{ 'COMMON.APPLICATION_NO' | translate }}:</strong> {{
                  mainApplyService.applyNo
                  }}
                </p>
              </div>
              <div class="col-xl-6">
                <p class="mb-1">
                  <strong>{{ 'COMMON.APPLICATION_DATE' | translate }}:</strong> {{
                  formatDateTime(mainApplyService.applyDate)
                  }}
                </p>
              </div>
              <div class="col-xl-6">
                <p class="mb-1">
                  <strong>{{ 'COMMON.STATUS' | translate }}:</strong>
                  <span class="badge bg-primary ms-2">{{ mainApplyService.serviceStatusName || mainApplyService.lastStatus }}</span>
                </p>
              </div>
              <div class="col-xl-6" *ngIf="mainApplyService.permitNumber">
                <p class="mb-0">
                  <strong>{{ 'COMMON.PERMIT_NUMBER' | translate }}:</strong> {{
                  mainApplyService.permitNumber
                  }}
                </p>
              </div>
              <div class="col-xl-6" *ngIf="isApproved">
                <button type="button"
                        class="btn btn-outline-secondary"
                        (click)="printReport()">
                  {{ 'Common.Print' | translate }}
                </button>
              </div>
            </div>
          </div>

        </div>



        <!-- Sidebar: Workflow Timeline -->
        <div class="row">
          <div class="col-lg-3 mb-4">
            <div class="main-container h-100">

              <h6 class="fw-bold mb-3 text-primary">
                <i class="fas fa-route me-2"></i>
                {{ 'WORKFLOW.PROCESS_STEPS' | translate }}
              </h6>

              <div class="workflow-timeline" *ngIf="workFlowSteps?.length">
                <div *ngFor="let step of workFlowSteps; let i = index; trackBy: trackByStepId"
                  class="workflow-step-item" [class.completed]="isStepCompleted(step.serviceStatus)"
                  [class.rejected]="isStepRejected(step.serviceStatus)"
                  [class.pending]="isStepPending(step.serviceStatus)"
                  [class.last-step]="i === workFlowSteps.length - 1">

                  <div class="step-circle" [style.background-color]="getStatusColor(step.serviceStatus)"
                    [style.border-color]="getStatusColor(step.serviceStatus)">
                    <i [class]="getStatusIcon(step.serviceStatus)"></i>
                  </div>

                  <div class="step-line" *ngIf="i < workFlowSteps.length - 1"
                    [class.completed-line]="isStepCompleted(step.serviceStatus)"></div>

                  <div>
                    <div class="step-header">
                      <div class="step-number">
                        <!--{{ 'WORKFLOW.STEP' | translate }} {{step.stepOrder}}-->
                        {{ step?.stepName || (('WORKFLOW.STEP' | translate) + ' ' + step?.stepOrder) }}
                      </div>
                      <div class="step-status" [style.color]="getStatusColor(step.serviceStatus)">
                        <i [class]="getStatusIcon(step.serviceStatus)" class="me-1"></i>
                        {{ step.serviceStatusName || (getStatusLabel(step.serviceStatus) | translate) }}
                      </div>
                    </div>
                    <h6 class="department-name">{{ step.departmentName }}</h6>
                    <small class="text-muted d-block mb-2" *ngIf="step.lastModified">
                      <i class="bi bi-calendar3 me-1"></i>
                      {{ formatDate(step.lastModified) }}
                    </small>
                    <button type="button" class="btn btn-link p-0"
                            (click)="openHistoryModal(step.workFlowHistories || [])">
                      <i class="bi bi-clock-history me-1"></i>{{'WORKFLOW.VIEW_HISTORY' | translate}}
                    </button>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <!-- Content Area -->
          <div class="col-lg-9 mb-4">
            <div class="main-container mb-4">
              <!-- Section: Basic -->

              <div class="step-content mb-4">
                <!-- Service Information Card (moved here from left) -->

                <h5 class="mb-3 gold">{{ 'CHARITY_EVENT_PERMIT.BASIC' | translate }}</h5>

                <div class="row" *ngIf="charityEventPermit">
                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">{{ 'CHARITY_EVENT_PERMIT.REQUEST_DATE' | translate }}</label>
                    <div class="form-control-plaintext">{{ formatDateTime(charityEventPermit.requestDate) }}</div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">
                      {{
                      'CHARITY_EVENT_PERMIT.ADVERTISEMENT_TYPE' | translate
                      }}
                    </label>
                    <div class="form-control-plaintext">
                      {{ charityEventPermit.advertisementTypeName || charityEventPermit.advertisementType || '-' }}
                    </div>
                  </div>

                  <div class="col-12 mb-3">
                    <label class="form-label fw-bold">{{ 'COMMON.STATUS' | translate }}</label>
                    <div class="form-control-plaintext">
                      {{ mainApplyService.serviceStatusName || mainApplyService.lastStatus }}
                    </div>
                  </div>
                </div>

              </div>


              <!-- Section: Event Details -->

              <div class="step-content mb-4">
                <h5 class="mb-3 gold">{{ 'CHARITY_EVENT_PERMIT.EVENT_DETAILS' | translate }}</h5>

                <div class="row" *ngIf="charityEventPermit">
                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">{{ 'CHARITY_EVENT_PERMIT.EVENT_NAME' | translate }}</label>
                    <div class="form-control-plaintext">{{ charityEventPermit.eventName || '-' }}</div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">{{ 'CHARITY_EVENT_PERMIT.EVENT_LOCATION' | translate }}</label>
                    <div class="form-control-plaintext">{{ charityEventPermit.eventLocation || '-' }}</div>
                  </div>

                  <div class="col-12 mb-3">
                    <label class="form-label fw-bold">{{ 'CHARITY_EVENT_PERMIT.NOTES' | translate }}</label>
                    <div class="form-control-plaintext">{{ charityEventPermit.notes || '-' }}</div>
                  </div>
                </div>
              </div>


              <!-- Section: Dates -->

              <div class="step-content mb-4">
                <h5 class="mb-3 gold">{{ 'CHARITY_EVENT_PERMIT.DATES' | translate }}</h5>

                <div class="row" *ngIf="charityEventPermit">
                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">{{ 'CHARITY_EVENT_PERMIT.START_DATE' | translate }}</label>
                    <div class="form-control-plaintext">{{ formatDateTime(charityEventPermit.startDate) }}</div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">{{ 'CHARITY_EVENT_PERMIT.END_DATE' | translate }}</label>
                    <div class="form-control-plaintext">{{ formatDateTime(charityEventPermit.endDate) }}</div>
                  </div>
                </div>
              </div>


              <!-- Section: Contacts -->

              <div class="step-content mb-4">
                <h5 class="mb-3 gold">{{ 'CHARITY_EVENT_PERMIT.CONTACTS' | translate }}</h5>

                <div class="row" *ngIf="charityEventPermit">
                  <div class="col-xl-6 mb-3">
                    <label class="form-label fw-bold">{{ 'CHARITY_EVENT_PERMIT.SUPERVISOR_NAME' | translate }}</label>
                    <div class="form-control-plaintext">{{ charityEventPermit.supervisorName || '-' }}</div>
                  </div>
                  <div class="col-xl-6 mb-3">
                    <label class="form-label fw-bold">{{ 'CHARITY_EVENT_PERMIT.JOB_TITLE' | translate }}</label>
                    <div class="form-control-plaintext">{{ charityEventPermit.jopTitle || '-' }}</div>
                  </div>
                  <div class="col-xl-6 mb-3">
                    <label class="form-label fw-bold">{{ 'CHARITY_EVENT_PERMIT.EMAIL' | translate }}</label>
                    <div class="form-control-plaintext">{{ charityEventPermit.email || '-' }}</div>
                  </div>

                  <div class="col-xl-6 mb-3">
                    <label class="form-label fw-bold">{{ 'CHARITY_EVENT_PERMIT.TELEPHONE1' | translate }}</label>
                    <div class="form-control-plaintext">{{ charityEventPermit.telephone1 || '-' }}</div>
                  </div>
                  <div class="col-xl-6 mb-3">
                    <label class="form-label fw-bold">{{ 'CHARITY_EVENT_PERMIT.TELEPHONE2' | translate }}</label>
                    <div class="form-control-plaintext">{{ charityEventPermit.telephone2 || '-' }}</div>
                  </div>
                  9

                  <!-- Donation channels -->
                  <div class="col-12 mb-2" *ngIf="charityEventPermit.donationCollectionChannels?.length">
                    <label class="form-label fw-bold">
                      {{
                      'CHARITY_EVENT_PERMIT.DONATION_CHANNELS' | translate
                      }}
                    </label>
                    <ul class="list-group">
                      <li class="list-group-item" *ngFor="let ch of charityEventPermit.donationCollectionChannels">
                        {{ channelName(ch) }}
                        <span *ngIf="ch.isActive" class="badge bg-success ms-2">
                          {{
                          'COMMON.ACTIVE' | translate
                          }}
                        </span>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>






            </div>

            <div class="accordion" id="charitySectionsAccordion">

              <!-- ACCORDION ITEM 1: Advertisements -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="adsHeader">
                  <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#adsSection"
                    aria-expanded="false" aria-controls="adsSection">
                    {{ 'CHARITY_EVENT_PERMIT.ADVERTISEMENTS' | translate }}
                  </button>
                </h2>
                <div id="adsSection" class="accordion-collapse collapse" aria-labelledby="adsHeader"
                  data-bs-parent="#charitySectionsAccordion">
                  <div class="accordion-body">
                    <!-- Section: Advertisements (original content preserved) -->
                    <div class="step-content">

                      <div *ngIf="charityEventPermit?.requestAdvertisements?.length; else noAds">
                        <div class="accordion" id="adsAccordion">
                          <div class="accordion-item"
                            *ngFor="let ad of charityEventPermit!.requestAdvertisements; let i = index">
                            <h2 class="accordion-header d-flex" [id]="'ad-h-'+i">
                              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                [attr.data-bs-target]="'#ad-c-'+i" aria-expanded="false">
                                <div class="d-flex flex-column">
                                  <div>
                                    {{ i + 1 }} — {{ ad.adTitle }}
                                  </div>
                                  <div class="step-status pt-1" [style.color]="getStatusColor(ad.advertisementStatus)"
                                    style="font-weight: normal; font-size: 16px;">
                                    <i [class]="getStatusIcon(ad.advertisementStatus)" class="me-1"></i>
                                    {{
                                    ad.advertisementStatusName || (getStatusLabel(ad.advertisementStatus) |
                                    translate)
                                    }}
                                  </div>
                                </div>
                              </button>

                            </h2>
                            <div [id]="'ad-c-'+i" class="accordion-collapse collapse" [attr.aria-labelledby]="'ad-h-'+i"
                              data-bs-parent="#adsAccordion">
                              <div class="accordion-body">
                                <div class="ms-auto pb-1">
                                  <button type="button" class="btn btn-gold dropdown-toggle"
                                    style="padding: 12px !important;" (click)="openAdWorkflow(ad)">
                                    <i class="fas fa-route me-1"></i>
                                    {{ 'WORKFLOW.PROCESS_STEPS' | translate }}
                                  </button>
                                </div>
                                <div class="row">
                                  <div class="col-md-6 mb-2">
                                    <strong>{{ 'CHARITY_EVENT_PERMIT.AD_START' | translate }}:</strong> {{
                                    formatDateTime(ad.startDate)
                                    }}
                                  </div>
                                  <div class="col-md-6 mb-2">
                                    <strong>{{ 'CHARITY_EVENT_PERMIT.AD_END' | translate }}:</strong> {{
                                    formatDateTime(ad.endDate)
                                    }}
                                  </div>
                                  <!-- <div class="col-md-6 mb-2">
                          <strong>{{ 'CHARITY_EVENT_PERMIT.AD_MOBILE' | translate }}:</strong> {{
                          ad.mobile }}
                        </div>
                        <div class="col-md-6 mb-2">
                          <strong>{{ 'CHARITY_EVENT_PERMIT.AD_EMAIL' | translate }}:</strong> {{
                          ad.eMail
                          }}
                        </div>
                        <div class="col-md-6 mb-2">
                          <strong>{{ 'CHARITY_EVENT_PERMIT.AD_SUPERVISOR' | translate }}:</strong> {{
                          ad.supervisorName }}
                        </div>
                        <div class="col-md-6 mb-2">
                          <strong>{{ 'CHARITY_EVENT_PERMIT.AD_TARGETED_AMOUNT' | translate }}:</strong>
                          {{
                          ad.targetedAmount }}
                        </div>
                        <div class="col-md-6 mb-2">
                          <strong>{{ 'CHARITY_EVENT_PERMIT.AD_FLAGS' | translate }}:</strong>
                          <span class="badge bg-primary me-2" *ngIf="ad.newAd">{{
                            'CHARITY_EVENT_PERMIT.NEW_AD' | translate }}</span>
                          <span class="badge bg-warning text-dark" *ngIf="ad.reNewAd">{{
                            'CHARITY_EVENT_PERMIT.RENEW_AD' | translate }}</span>
                        </div> -->
                                  <!-- Targets -->
                                  <div class="col-12 mt-3" *ngIf="ad.requestAdvertisementTargets?.length">
                                    <h6 class="fw-bold">{{ 'CHARITY_EVENT_PERMIT.AD_TARGETS' | translate }}</h6>
                                    <ul class="mb-0">
                                      <li *ngFor="let t of ad.requestAdvertisementTargets">
                                        {{ t.lkpTargetTypeText}}
                                        <span *ngIf="t.othertxt"> {{ t.othertxt }}</span>
                                      </li>
                                    </ul>
                                  </div>

                                  <!-- Locations -->
                                  <div class="col-12 mt-3" *ngIf="ad.requestAdvertisementAdLocations?.length">
                                    <h6 class="fw-bold">{{ 'CHARITY_EVENT_PERMIT.AD_LOCATIONS' | translate }}</h6>
                                    <ul class="mb-0">
                                      <li *ngFor="let loc of ad.requestAdvertisementAdLocations">
                                        {{
                                        loc.location
                                        }}
                                      </li>
                                    </ul>
                                  </div>

                                  <!-- Methods -->
                                  <div class="col-12 mt-3" *ngIf="ad.requestAdvertisementAdMethods?.length">
                                    <h6 class="fw-bold">{{ 'CHARITY_EVENT_PERMIT.AD_METHODS' | translate }}</h6>
                                    <ul class="mb-0">
                                      <li *ngFor="let m of ad.requestAdvertisementAdMethods">
                                        {{ m.lkpAdMethodText }}
                                        <span *ngIf="m.othertxt">— {{ m.othertxt }}</span>
                                      </li>
                                    </ul>
                                  </div>

                                  <!-- Ad Attachments -->
                                  <!-- <div class="col-12 mt-3" *ngIf="ad.attachments?.length">
                          <h6 class="fw-bold">{{ 'COMMON.ATTACHMENTS' | translate }}</h6>
                          <div class="d-flex flex-wrap gap-2">
                            <button *ngFor="let a of ad.attachments" class="btn btn-sm btn-next-style"
                              (click)="viewAttachment(a)">
                              <i class="fas fa-eye me-1"></i>{{ a.attachmentTitle ||
                              ('CHARITY_EVENT_PERMIT.ATTACHMENT' | translate) }}
                            </button>
                          </div>
                        </div> -->
                                  <!-- Ad Attachments -->
                                  <div class="col-12">
                                    <label class="form-label fw-bold">{{ 'COMMON.ATTACHMENTS' | translate }}</label>

                                    <ng-container *ngIf="ad.attachments && ad.attachments.length > 0; else noAdAtts">
                                      <div class="row">
                                        <div class="col-xl-4 col-lg-6 mb-3" *ngFor="let att of ad.attachments">
                                          <div class="attachment-box">
                                            <h6 class="card-title">
                                              {{
 att.attachmentTitle || ('REQUEST_EVENT_PERMIT.ATTACHMENT' |
                                              translate)
                                              }}
                                            </h6>
                                            <p class="mb-3">
                                              {{ 'COMMON.UPLOADED_ON' | translate }}:
                                              {{ formatDateTime(att.lastModified) }}
                                            </p>
                                            <div class="d-flex justify-content-end">
                                              <button class="btn btn-next-style me-2" (click)="viewAttachment(att)">
                                                <i class="fas fa-eye me-1"></i>{{ 'COMMON.VIEW' | translate }}
                                              </button>
                                              <button class="btn btn-download-style" (click)="downloadAttachment(att)">
                                                <i class="fas fa-download me-1"></i>{{
 'COMMON.DOWNLOAD' | translate
                                                }}
                                              </button>
                                            </div>
                                          </div>
                                        </div>
                                      </div>
                                    </ng-container>
                                    <ng-template #noAdAtts>
                                      <div class="alert alert-info py-2 mb-0">
                                        {{
                                        'REQUEST_EVENT_PERMIT.NO_ATTACHMENTS'
                                        | translate
                                        }}
                                      </div>
                                    </ng-template>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <ng-template #noAds>
                        <div class="alert alert-info">{{ 'CHARITY_EVENT_PERMIT.NO_ADS' | translate }}</div>
                      </ng-template>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ACCORDION ITEM 2: Partners -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="partnersHeader">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#partnersSection" aria-expanded="false" aria-controls="partnersSection">
                    {{ 'CHARITY_EVENT_PERMIT.PARTNERS' | translate }}
                  </button>
                </h2>
                <div id="partnersSection" class="accordion-collapse collapse" aria-labelledby="partnersHeader"
                  data-bs-parent="#charitySectionsAccordion">
                  <div class="accordion-body">
                    <!-- Section: Partners (original content preserved) -->

                    <div class="step-content">

                      <ng-container *ngIf="partners?.length; else noPartners">
                        <div class="accordion" id="partnersAccordion">
                          <div class="accordion-item"
                               *ngFor="let partner of partners; let i = index">
                            <h2 class="accordion-header" [id]="'partnerHeading' + i">
                              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                      [attr.data-bs-target]="'#partnerCollapse' + i" aria-expanded="false"
                                      [attr.aria-controls]="'partnerCollapse' + i">
                                <div class="d-flex flex-column">
                                  <div>
                                    {{ i + 1 }} — {{ partner.name || '-' }}
                                  </div>
                                  <div class="text-muted pt-1" style="font-weight: normal; font-size: 14px;">
                                    {{ partner.typeName || partner.type || '-' }}
                                  </div>
                                </div>
                              </button>
                            </h2>
                            <div [id]="'partnerCollapse' + i" class="accordion-collapse collapse"
                                 [attr.aria-labelledby]="'partnerHeading' + i" data-bs-parent="#partnersAccordion">
                              <div class="accordion-body">
                                <div class="row">
                                  <div class="col-md-4 mb-2">
                                    <label class="form-label fw-bold">{{ 'COMMON.NAME' | translate }}</label>
                                    <div class="form-control-plaintext">{{ partner.name || '-' }}</div>
                                  </div>
                                  <div class="col-md-4 mb-2">
                                    <label class="form-label fw-bold">{{ 'COMMON.TYPE' | translate }}</label>
                                    <div class="form-control-plaintext">{{ partner.typeName || partner.type || '-' }}</div>
                                  </div>
                                  <div class="col-md-4 mb-2">
                                    <label class="form-label fw-bold">{{ 'COMMON.LICENSE_NUMBER' | translate }}</label>
                                    <div class="form-control-plaintext">{{ partner.licenseNumber || '-' }}</div>
                                  </div>
                                  <div class="col-md-4 mb-2">
                                    <label class="form-label fw-bold">{{ 'COMMON.LICENSE_ISSUER' | translate }}</label>
                                    <div class="form-control-plaintext">{{ partner.licenseIssuer || '-' }}</div>
                                  </div>
                                  <div class="col-md-4 mb-2">
                                    <label class="form-label fw-bold">{{ 'COMMON.LICENSE_EXPIRY' | translate }}</label>
                                    <div class="form-control-plaintext">{{ formatDate(partner.licenseExpiryDate) || '-' }}</div>
                                  </div>
                                  <div class="col-md-4 mb-2">
                                    <label class="form-label fw-bold">{{ 'COMMON.CONTACT_DETAILS' | translate }}</label>
                                    <div class="form-control-plaintext">{{ partner.contactDetails || '-' }}</div>
                                  </div>
                                  <div class="col-md-12 mb-2">
                                    <label class="form-label fw-bold">{{ 'COMMON.ATTACHMENTS' | translate }}</label>
                                    <div class="form-control-plaintext">
                                      <button *ngIf="partner.attachments?.length" class="btn btn-next-style"
                                              (click)="viewPartnerAttachments(partner)">
                                        <i class="fas fa-eye me-1"></i>
                                        {{ 'COMMON.VIEW' | translate }} ({{ partner.attachments?.length }})
                                      </button>
                                      <button *ngIf="!partner.attachments?.length" class="btn btn-next-style"
                                              (click)="viewPartnerAttachments(partner)">
                                        <i class="fas fa-eye me-1"></i>
                                        {{ 'COMMON.VIEW' | translate }}
                                      </button>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </ng-container>

                      <ng-template #noPartners>
                        <div class="alert alert-info">{{ 'CHARITY_EVENT_PERMIT.NO_PARTNERS' | translate }}</div>
                      </ng-template>
                    </div>

                  </div>
                </div>
              </div>

              <!-- ACCORDION ITEM 3: Attachments -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="attachmentsHeader">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#attachmentsSection" aria-expanded="false" aria-controls="attachmentsSection">
                    {{ 'CHARITY_EVENT_PERMIT.ATTACHMENTS' | translate }}
                  </button>
                </h2>
                <div id="attachmentsSection" class="accordion-collapse collapse" aria-labelledby="attachmentsHeader"
                  data-bs-parent="#charitySectionsAccordion">
                  <div class="accordion-body">
                    <!-- Section: Attachments (original content preserved) -->
                    <div class="step-content">

                      <div *ngIf="attachments?.length; else noAtts">
                        <div class="row">
                          <div class="col-xl-4 col-lg-6 mb-4" *ngFor="let attachment of attachments">
                            <div class="attachment-box">
                              <h6 class="card-title">
                                {{
                                attachment.attachmentTitle || ('CHARITY_EVENT_PERMIT.ATTACHMENT' | translate)
                                }}
                              </h6>
                              <p class="mb-4">
                                {{ 'COMMON.UPLOADED_ON' | translate }}: {{
                                formatDateTime(attachment.lastModified)
                                }}
                              </p>
                              <div class="d-flex justify-content-between mt-auto">
                                <button class="btn btn-next-style me-2" (click)="viewAttachment(attachment)">
                                  <i class="fas fa-eye me-1"></i>{{ 'COMMON.VIEW' | translate }}
                                </button>
                                <button class="btn btn-download-style" (click)="downloadAttachment(attachment)">
                                  <i class="fas fa-download me-1"></i>{{ 'COMMON.DOWNLOAD' | translate }}
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <ng-template #noAtts>
                        <div class="alert alert-info">
                          {{ 'CHARITY_EVENT_PERMIT.NO_ATTACHMENTS' | translate }}
                        </div>
                      </ng-template>
                    </div>
                  </div>
                </div>
              </div>

              <div class="accordion-item">
                <h2 class="accordion-header" id="wfHeader">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#wfComments" aria-expanded="false" aria-controls="wfComments">
                    {{ 'COMMON.WORKFLOW_COMMENTS' | translate }}
                  </button>
                </h2>
                <div id="wfComments" class="accordion-collapse collapse" data-bs-parent="#charitySectionsAccordion"
                  aria-labelledby="wfHeader">
                  <div class="accordion-body">
                    <div class="step-content">

                      <!-- <div class="d-flex justify-content-end align-items-center mb-4">
              <button *ngIf="targetWorkFlowStep" type="button" class="btn btn-gold" data-bs-toggle="modal"
                data-bs-target="#commentModal">
                <i class="fas fa-plus me-2"></i>
                {{ 'COMMON.ADD_COMMENT' | translate }}
              </button>
            </div> -->
                      <!-- <div class="comments-container">
                            <div class="comment-item">
                                <div
                                    class="d-flex align-items-center justify-content-between gap-3 mb-2">
                                    <h5>Department Name</h5>
                                    <div class="status-waiting">
                                        Waiting
                                    </div>
                                </div>
                                <div class="comment-area">
                                    Lorem Ipsum is simply dummy text of the printing and typesetting
                                    industry. Lorem Ipsum has been the industry's standard dummy
                                    text ever since the 1500s, when an unknown printer took a galley
                                    of type and scrambled it to make a type specimen book. It has
                                    survived not only five centuries, but also the leap into
                                    electronic typesetting, remaining essentially unchanged.
                                </div>
                                <button class="btn btn-view-attachment mt-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                        viewBox="0 0 20 20" fill="none">
                                        <g clip-path="url(#clip0_560_1674)">
                                            <path
                                                d="M19.3923 7.84858C18.0998 5.74358 15.1598 2.21191 9.9998 2.21191C4.8398 2.21191 1.8998 5.74358 0.607299 7.84858C0.207739 8.49484 -0.00390625 9.23962 -0.00390625 9.99941C-0.00390625 10.7592 0.207739 11.504 0.607299 12.1502C1.8998 14.2552 4.8398 17.7869 9.9998 17.7869C15.1598 17.7869 18.0998 14.2552 19.3923 12.1502C19.7919 11.504 20.0035 10.7592 20.0035 9.99941C20.0035 9.23962 19.7919 8.49484 19.3923 7.84858V7.84858ZM17.9715 11.2777C16.8615 13.0827 14.349 16.1202 9.9998 16.1202C5.65063 16.1202 3.13813 13.0827 2.02813 11.2777C1.79074 10.8936 1.66501 10.451 1.66501 9.99941C1.66501 9.54785 1.79074 9.10521 2.02813 8.72108C3.13813 6.91608 5.65063 3.87858 9.9998 3.87858C14.349 3.87858 16.8615 6.91275 17.9715 8.72108C18.2089 9.10521 18.3346 9.54785 18.3346 9.99941C18.3346 10.451 18.2089 10.8936 17.9715 11.2777V11.2777Z"
                                                fill="#374957" />
                                            <path
                                                d="M10.0007 5.83301C9.17656 5.83301 8.37098 6.07738 7.68578 6.53522C7.00057 6.99306 6.46652 7.6438 6.15115 8.40516C5.83579 9.16652 5.75328 10.0043 5.91405 10.8126C6.07482 11.6208 6.47166 12.3632 7.05437 12.946C7.63709 13.5287 8.37952 13.9255 9.18778 14.0863C9.99603 14.2471 10.8338 14.1645 11.5952 13.8492C12.3565 13.5338 13.0073 12.9998 13.4651 12.3146C13.9229 11.6293 14.1673 10.8238 14.1673 9.99967C14.166 8.89501 13.7266 7.83597 12.9455 7.05486C12.1644 6.27374 11.1053 5.83433 10.0007 5.83301V5.83301ZM10.0007 12.4997C9.5062 12.4997 9.02285 12.3531 8.61173 12.0783C8.2006 11.8036 7.88017 11.4132 7.69095 10.9564C7.50173 10.4996 7.45223 9.9969 7.54869 9.51195C7.64515 9.027 7.88325 8.58154 8.23289 8.23191C8.58252 7.88228 9.02797 7.64417 9.51293 7.54771C9.99788 7.45125 10.5005 7.50076 10.9574 7.68998C11.4142 7.87919 11.8046 8.19963 12.0793 8.61075C12.354 9.02187 12.5007 9.50522 12.5007 9.99967C12.5007 10.6627 12.2373 11.2986 11.7684 11.7674C11.2996 12.2363 10.6637 12.4997 10.0007 12.4997Z"
                                                fill="#374957" />
                                        </g>
                                        <defs>
                                            <clipPath id="clip0_560_1674">
                                                <rect width="20" height="20" fill="white" />
                                            </clipPath>
                                        </defs>
                                    </svg>
                                    View Attachment
                                </button>
                            </div>
                            <div class="comment-item">
                                <div
                                    class="d-flex align-items-center justify-content-between gap-3 mb-2">
                                    <h5>Department Name</h5>
                                    <div class="status-approved">
                                        Accepted
                                    </div>
                                </div>
                                <div class="comment-area">
                                    Lorem Ipsum is simply dummy text of the printing and typesetting
                                    industry. Lorem Ipsum has been the industry's standard dummy
                                    text ever since the 1500s, when an unknown printer took a galley
                                    of type and scrambled it to make a type specimen book. It has
                                    survived not only five centuries, but also the leap into
                                    electronic typesetting, remaining essentially unchanged.
                                </div>
                            </div>
                            <div class="comment-item">
                                <div
                                    class="d-flex align-items-center justify-content-between gap-3 mb-2">
                                    <h5>Department Name</h5>
                                    <div class="status-waiting">
                                        Waiting
                                    </div>
                                </div>
                                <div class="comment-area">
                                    Lorem Ipsum is simply dummy text of the printing and typesetting
                                    industry. Lorem Ipsum has been the industry's standard dummy
                                    text ever since the 1500s, when an unknown printer took a galley
                                    of type and scrambled it to make a type specimen book. It has
                                    survived not only five centuries, but also the leap into
                                    electronic typesetting, remaining essentially unchanged.
                                </div>
                            </div>

                        </div> -->
                      <!-- <app-generic-data-table [columnDefs]="commentsColumnDefs" [rowData]="allWorkFlowComments"
              [totalCount]="allWorkFlowComments.length" [pageSize]="10" [currentPage]="0"
              [showActionColumn]="false" [columnHeaderMap]="commentsColumnHeaderMap"
              (actionClick)="onCommentsTableAction($event)" (cellClicked)="onTableCellClick($event)">
            </app-generic-data-table> -->




                      <div class="comments-container">
                        <div class="comment-item" *ngFor="let comment of allWorkFlowComments">
                          <div class="d-flex align-items-center justify-content-between gap-3 mb-2">
                            <div>
                              <h5 class="mb-0">{{ comment.employeeDepartmentName || currentUserName }}</h5>
                              <small class="text-muted">
                                {{ comment.lastModified | date:'dd/MM/yyyy' }}
                              </small>
                            </div>
                          </div>
                          <div class="comment-area">
                            {{ comment.comment }}
                          </div>
                          <div>
                            <button class="btn btn-view-attachment mt-2" data-comment-id="${comment.id}"
                              data-row-index="${p.node.rowIndex}" (click)="onTableCellClick($event,comment?.id)">
                              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"
                                fill="none">
                                <g clip-path="url(#clip0_560_1674)">
                                  <path
                                    d="M19.3923 7.84858C18.0998 5.74358 15.1598 2.21191 9.9998 2.21191C4.8398 2.21191 1.8998 5.74358 0.607299 7.84858C0.207739 8.49484 -0.00390625 9.23962 -0.00390625 9.99941C-0.00390625 10.7592 0.207739 11.504 0.607299 12.1502C1.8998 14.2552 4.8398 17.7869 9.9998 17.7869C15.1598 17.7869 18.0998 14.2552 19.3923 12.1502C19.7919 11.504 20.0035 10.7592 20.0035 9.99941C20.0035 9.23962 19.7919 8.49484 19.3923 7.84858V7.84858ZM17.9715 11.2777C16.8615 13.0827 14.349 16.1202 9.9998 16.1202C5.65063 16.1202 3.13813 13.0827 2.02813 11.2777C1.79074 10.8936 1.66501 10.451 1.66501 9.99941C1.66501 9.54785 1.79074 9.10521 2.02813 8.72108C3.13813 6.91608 5.65063 3.87858 9.9998 3.87858C14.349 3.87858 16.8615 6.91275 17.9715 8.72108C18.2089 9.10521 18.3346 9.54785 18.3346 9.99941C18.3346 10.451 18.2089 10.8936 17.9715 11.2777V11.2777Z"
                                    fill="#374957" />
                                  <path
                                    d="M10.0007 5.83301C9.17656 5.83301 8.37098 6.07738 7.68578 6.53522C7.00057 6.99306 6.46652 7.6438 6.15115 8.40516C5.83579 9.16652 5.75328 10.0043 5.91405 10.8126C6.07482 11.6208 6.47166 12.3632 7.05437 12.946C7.63709 13.5287 8.37952 13.9255 9.18778 14.0863C9.99603 14.2471 10.8338 14.1645 11.5952 13.8492C12.3565 13.5338 13.0073 12.9998 13.4651 12.3146C13.9229 11.6293 14.1673 10.8238 14.1673 9.99967C14.166 8.89501 13.7266 7.83597 12.9455 7.05486C12.1644 6.27374 11.1053 5.83433 10.0007 5.83301V5.83301ZM10.0007 12.4997C9.5062 12.4997 9.02285 12.3531 8.61173 12.0783C8.2006 11.8036 7.88017 11.4132 7.69095 10.9564C7.50173 10.4996 7.45223 9.9969 7.54869 9.51195C7.64515 9.027 7.88325 8.58154 8.23289 8.23191C8.58252 7.88228 9.02797 7.64417 9.51293 7.54771C9.99788 7.45125 10.5005 7.50076 10.9574 7.68998C11.4142 7.87919 11.8046 8.19963 12.0793 8.61075C12.354 9.02187 12.5007 9.50522 12.5007 9.99967C12.5007 10.6627 12.2373 11.2986 11.7684 11.7674C11.2996 12.2363 10.6637 12.4997 10.0007 12.4997Z"
                                    fill="#374957" />
                                </g>
                                <defs>
                                  <clipPath id="clip0_560_1674">
                                    <rect width="20" height="20" fill="white" />
                                  </clipPath>
                                </defs>
                              </svg>
                              {{ 'COMMON.VIEW' | translate}}
                            </button>
                          </div>
                        </div>
                      </div>








                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

      </div>

    </div>
  </section>
</div>

<!-- Comment Attachments Modal (kept as provided) -->
<div class="modal fade show" tabindex="-1"
  [ngStyle]="{ display: showAttachmentModal ? 'block' : 'none', background: 'rgba(0,0,0,0.5)' }"
  *ngIf="showAttachmentModal">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 rounded-4 shadow-lg">
      <div class="modal-header bg-info text-white rounded-top-4 border-0">
        <h5 class="modal-title fs-4 fw-bold">
          <i class="fas fa-paperclip me-2"></i>{{ 'COMMON.ATTACHMENTS' | translate }}
        </h5>
        <button type="button" class="btn-close btn-close-white" aria-label="Close"
          (click)="closeAttachmentModal()"></button>
      </div>
      <div class="modal-body p-4">
        <div *ngIf="isLoadingAttachments" class="text-center py-5">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-3 text-muted">{{ 'COMMON.LOADING_ATTACHMENTS' | translate }}</p>
        </div>

        <div *ngIf="!isLoadingAttachments && selectedCommentAttachments.length === 0"
          class="text-center text-muted py-4">
          <i class="fas fa-file-alt fa-3x mb-3 text-muted"></i>
          <p>{{ 'COMMON.NO_ATTACHMENTS' | translate }}</p>
        </div>

        <div *ngIf="!isLoadingAttachments && selectedCommentAttachments.length > 0" class="row g-3">
          <div *ngFor="let attachment of selectedCommentAttachments" class="col-md-6 col-lg-4">
            <div class="card h-100 border-0 shadow-sm hover-shadow">
              <div class="card-body text-center p-3">
                <div class="mb-3"><i class="fas fa-file-alt fa-2x text-primary"></i></div>
                <h6 class="card-title small mb-2">
                  {{
                  attachment.attachmentTitle || ('CHARITY_EVENT_PERMIT.ATTACHMENT' |
                  translate)
                  }}
                </h6>
                <div class="d-grid gap-2">
                  <button class="btn btn-download-style" (click)="downloadAttachment(attachment)">
                    <i class="fas fa-download me-1"></i>{{ 'COMMON.DOWNLOAD' | translate }}
                  </button>
                  <button class="btn btn-next-style" (click)="viewAttachment(attachment)">
                    <i class="fas fa-eye me-1"></i>{{ 'COMMON.VIEW' | translate }}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
      <div class="modal-footer border-0 rounded-bottom-4 justify-content-center">
        <button type="button" class="btn btn-secondary" (click)="closeAttachmentModal()">
          {{ 'COMMON.CLOSE' | translate }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Partner Attachments Modal (kept as provided) -->
<div class="modal fade show" tabindex="-1"
  [ngStyle]="{ display: showPartnerAttachmentModal ? 'block' : 'none', background: 'rgba(0,0,0,0.5)' }"
  *ngIf="showPartnerAttachmentModal">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header   ">
        <h5 class="modal-title fs-4 fw-bold">
          <i class="fas fa-user-tie me-2"></i>{{ 'CHARITY_EVENT_PERMIT.PARTNER_ATTACHMENTS' | translate }}
          <span *ngIf="selectedPartner" class="fw-normal"> - {{ selectedPartner?.name }}</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" aria-label="Close"
          (click)="closePartnerAttachmentModal()"></button>
      </div>
      <div class="modal-body p-4">
        <div *ngIf="isLoadingPartnerAttachments" class="text-center py-5">
          <div class="spinner-border text-success" role="status"></div>
          <p class="mt-3 text-muted">{{ 'COMMON.LOADING_ATTACHMENTS' | translate }}</p>
        </div>

        <div *ngIf="!isLoadingPartnerAttachments && selectedPartnerAttachments.length === 0"
          class="text-center text-muted py-4">
          <i class="fas fa-file-alt fa-3x mb-3 text-muted"></i>
          <p>{{ 'COMMON.NO_ATTACHMENTS' | translate }}</p>
        </div>

        <div *ngIf="!isLoadingPartnerAttachments && selectedPartnerAttachments.length > 0" class="row g-3">
          <div *ngFor="let attachment of selectedPartnerAttachments" class="col-md-6 col-lg-4">
            <div class="card h-100 border-0 shadow-sm hover-shadow">
              <div class="card-body text-center p-3">
                <div class="mb-3"><i class="fas fa-file-alt fa-2x "></i></div>
                <h6 class="card-title small mb-2">
                  {{
                  attachment.attachmentTitle || ('CHARITY_EVENT_PERMIT.ATTACHMENT' |
                  translate)
                  }}
                </h6>
                <div class="d-grid gap-2">
                  <button class="btn btn-download-style" (click)="downloadAttachment(attachment)">
                    <i class="fas fa-download me-1"></i>{{ 'COMMON.DOWNLOAD' | translate }}
                  </button>
                  <button class="btn btn-next-style" (click)="viewAttachment(attachment)">
                    <i class="fas fa-eye me-1"></i>{{ 'COMMON.VIEW' | translate }}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
      <div class="modal-footer border-0 rounded-bottom-4 justify-content-center">
        <button type="button" class="btn btn-secondary" (click)="closePartnerAttachmentModal()">
          {{ 'COMMON.CLOSE' | translate }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add Comment Modal (kept exactly as original) -->
<div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="commentModalLabel">{{ 'COMMON.ADD_COMMENT' | translate }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <form [formGroup]="commentForm" (ngSubmit)="addWorkFlowComment()">
          <div class="mb-3">
            <label for="commentText " class="form-label mb-2">{{ 'COMMON.COMMENT' | translate }}</label>
            <textarea class="form-control" id="commentText" rows="4" [(ngModel)]="newCommentText"
              [ngModelOptions]="{standalone: true}" placeholder="{{ 'COMMON.ENTER_COMMENT' | translate }}"
              required></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label mb-2">
              {{ 'COMMON.ATTACHMENTS' | translate }} ({{
              'COMMON.OPTIONAL' | translate
              }})
            </label>

            <!-- Comment Attachment Configurations -->
            <div *ngIf="commentAttachmentConfigs.length > 0" class="">
              <div>
                <div *ngFor="let config of commentAttachmentConfigs">

                  <div *ngIf="!commentSelectedFiles[config.id!] || commentSelectedFiles[config.id!].length === 0"
                    class="upload-area" (dragover)="onCommentDragOver($event)" (dragleave)="onCommentDragLeave($event)"
                    (drop)="onCommentDrop($event, config.id!)" [class.drag-over]="isCommentDragOver"
                    [class.border-danger]="isCommentAttachmentMandatory(config.id!) && (!commentSelectedFiles[config.id!] || commentSelectedFiles[config.id!].length === 0) && commentValidationSubmitted"
                    [class.border-success]="commentSelectedFiles[config.id!] && commentSelectedFiles[config.id!].length > 0">
                    <input type="file" class="d-none" [id]="'comment-file-' + config.id"
                      (change)="onCommentFileSelected($event, config.id!)" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                      multiple>
                    <label [for]="'comment-file-' + config.id" class="upload-label">
                      <i class="fas fa-cloud-upload-alt mb-2"></i>
                      <div>{{ 'ATTACHMENTS.DRAG_DROP_OR_CLICK' | translate }}</div>
                      <small class="text-muted">
                        {{
                        'ATTACHMENTS.SUPPORTED_FORMATS' | translate
                        }}
                      </small>
                      <small class="text-muted d-block mt-1">
                        {{
                        'ATTACHMENTS.MULTIPLE_FILES_ALLOWED' | translate
                        }}
                      </small>
                    </label>
                  </div>

                  <!-- Multiple Files Display -->
                  <div *ngIf="commentSelectedFiles[config.id!] && commentSelectedFiles[config.id!].length > 0"
                    class="uploaded-files-list">
                    <!-- Hidden file input for "Add More Files" functionality -->
                    <input type="file" class="d-none" [id]="'comment-file-more-' + config.id"
                      (change)="onCommentFileSelected($event, config.id!)" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                      multiple>

                    <div class="d-flex align-items-center justify-content-between mb-2">
                      <h6 class="mb-0">{{ getCommentAttachmentName(config) }}</h6>
                      <button type="button" class="btn btn-sm btn-gold" (click)="addMoreFiles(config.id!)">
                        <i class="fas fa-plus me-1"></i>{{ 'Common.MORE_FILES' | translate }}
                      </button>
                    </div>

                    <div class="file-list">
                      <div *ngFor="let file of commentSelectedFiles[config.id!]; let fileIndex = index"
                        class="file-item d-flex align-items-center gap-2 p-2 border rounded mb-2">
                        <div class="file-preview me-2">
                          <img *ngIf="commentFilePreviews[config.id!]?.[fileIndex] && file.type?.startsWith('image/')"
                            [src]="commentFilePreviews[config.id!]?.[fileIndex]"
                            class="img-thumbnail uploaded-img-small" [alt]="file.name">
                          <i *ngIf="!file.type?.startsWith('image/')" class="fas fa-file-alt text-primary fa-lg"></i>
                        </div>
                        <div class="file-info flex-grow-1">
                          <div class="file-name">{{ file.name }}</div>
                          <small class="text-muted">{{ formatFileSize(file.size) }}</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger"
                          (click)="removeCommentFile(config.id!, fileIndex)">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div>

            <!-- Legacy file input (keeping for backward compatibility) -->
            <div *ngIf="commentAttachmentConfigs.length === 0" class="mb-3">
              <input type="file" class="form-control" id="commentFiles" multiple (change)="onFileSelected($event)">

              <div *ngIf="selectedFiles.length > 0" class="mt-2">
                <div class="d-flex flex-wrap gap-2">
                  <span *ngFor="let file of selectedFiles; let i = index" class="badge bg-light text-dark border">
                    {{file.name}}
                    <button type="button" class="btn-close btn-close-sm ms-2" (click)="removeSelectedFile(i)"></button>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" data-bs-dismiss="modal">
          {{ 'COMMON.CANCEL' | translate }}
        </button>
        <button type="button" class="btn btn-gold" (click)="addWorkFlowComment()"
          [disabled]="!newCommentText.trim() || isSavingComment">
          <span *ngIf="isSavingComment" class="spinner-border spinner-border-sm me-2" role="status"></span>
          {{ 'COMMON.ADD_COMMENT' | translate }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ============== modal add advertisement ============== -->
<!-- Modal for Add Advertisement -->
<div class="modal fade" id="addAdvertisementModal" tabindex="-1" aria-labelledby="addAdvertisementModalLabel"
  aria-hidden="true">
  <div class="modal-dialog  modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addAdvertisementModalLabel">{{ 'ADD_ADVERTISEMENT' | translate }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="advertForm">
          <input type="hidden" formControlName="parentId">
          <input type="hidden" formControlName="mainApplyServiceId">
          <input type="hidden" formControlName="requestNo">
          <input type="hidden" formControlName="userId">
          <input type="hidden" formControlName="requestEventPermitId">

          <!-- Request Date (readonly visual) -->
          <div class="mb-3">
            <label class="form-label">{{ 'CHARITY_EVENT.REQUEST_DATE' | translate }}</label>
            <div class="form-control" readonly>
              {{ advertForm.value.requestDate | date:'medium' }}
            </div>
          </div>

          <!-- Ad Title -->
          <div class="mb-3">
            <label for="adTitle" class="form-label">
              {{ 'CHARITY_EVENT.AD_TITLE' | translate }} <span class="text-danger">*</span>
            </label>
            <input type="text" id="adTitle" class="form-control" formControlName="adTitle" required>
            <div class="invalid-feedback"
              *ngIf="advertForm.get('adTitle')?.touched && advertForm.get('adTitle')?.invalid">
              {{ 'VALIDATION.REQUIRED_FIELD' | translate }}
            </div>
          </div>

          <!-- Range Date -->
          <div class="mb-3">
            <label class="form-label">
              {{ 'CHARITY_EVENT.START_DATE' | translate }} <span class="text-danger">*</span>
            </label>
            <input type="datetime-local" class="form-control" formControlName="startDate"
              [class.is-invalid]="(advertForm.get('startDate')?.touched && advertForm.get('startDate')?.invalid) || advertForm.hasError('dateRange')">
            <div class="invalid-feedback"
              *ngIf="advertForm.get('startDate')?.touched && advertForm.get('startDate')?.errors">
              {{ 'VALIDATION.REQUIRED_FIELD' | translate }}
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">
              {{ 'CHARITY_EVENT.END_DATE' | translate }} <span class="text-danger">*</span>
            </label>
            <input type="datetime-local" class="form-control" formControlName="endDate"
              [class.is-invalid]="(advertForm.get('endDate')?.touched && advertForm.get('endDate')?.invalid) || advertForm.hasError('dateRange')">
            <div class="invalid-feedback"
              *ngIf="advertForm.get('endDate')?.touched && advertForm.get('endDate')?.errors">
              {{ 'VALIDATION.REQUIRED_FIELD' | translate }}
            </div>
          </div>

          <div class="mb-3" *ngIf="advertForm.hasError('dateRange')">
            <div class="text-danger small">{{ 'VALIDATION.DATE_RANGE' | translate }}</div>
          </div>

          <!-- Targets (multi) -> requestAdvertisementTargets -->
          <div class="mb-3">
            <label class="form-label">
              {{ 'CHARITY_EVENT.TARGET_TYPES' | translate }} <span class="text-danger">*</span>
            </label>
            <ng-select formControlName="targetTypeIds" [items]="advertisementTargetType" bindLabel="text" bindValue="id"
              [multiple]="true" [closeOnSelect]="false" [clearable]="true" [searchable]="true"
              [placeholder]="'COMMON.SELECT_OPTION' | translate" class="ng-select-custom"
              [ngClass]="{'is-invalid': advertForm.get('targetTypeIds')?.touched && advertForm.get('targetTypeIds')?.invalid}">
            </ng-select>
            <div class="invalid-feedback d-block" *ngIf="advertForm.get('targetTypeIds')?.hasError('minArrayLength')">
              {{ 'VALIDATION.MIN_ONE_TARGET' | translate }}
            </div>
          </div>

          <!-- Methods (multi) -> requestAdvertisementAdMethods -->
          <div class="mb-3">
            <label class="form-label">
              {{ 'CHARITY_EVENT.AD_METHODS' | translate }} <span class="text-danger">*</span>
            </label>
            <ng-select formControlName="adMethodIds" [items]="advertisementMethodType" bindLabel="text" bindValue="id"
              [multiple]="true" [closeOnSelect]="false" [clearable]="true" [searchable]="true"
              [placeholder]="'COMMON.SELECT_OPTION' | translate" class="ng-select-custom"
              [ngClass]="{'is-invalid': advertForm.get('adMethodIds')?.touched && advertForm.get('adMethodIds')?.invalid}">
            </ng-select>
            <div class="invalid-feedback d-block" *ngIf="advertForm.get('adMethodIds')?.hasError('minArrayLength')">
              {{ 'VALIDATION.MIN_ONE_METHOD' | translate }}
            </div>
          </div>

          <!-- Ad Attachments (RequestAnEventAnnouncementOrDonationCampaign) -->
          <div class="mb-3">
            <h6 class="mb-3">{{ 'REQUEST_PLAINT.ATTACHMENTS' | translate }}</h6>

            <div *ngFor="let cfg of state(AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign).configs"
              class="mb-3">
              <label>
                {{
                getAttachmentName(AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign, cfg.id!)
                }}
              </label>
              <div *ngIf="!hasSelected(AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign, cfg.id!)"
                class="upload-area" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)"
                (drop)="onDrop($event, AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign, cfg.id!)"
                [class.drag-over]="isDragOver">
                <input type="file" class="d-none" [id]="'file-reqAd-' + cfg.id"
                  (change)="onFileSelectednew($event, AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign, cfg.id!)"
                  accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                <label [for]="'file-reqAd-' + cfg.id" class="upload-label">
                  <i class="fas fa-cloud-upload-alt"></i>
                  <span>{{ 'ATTACHMENTS.DRAG_DROP_OR_CLICK' | translate }}</span>
                </label>
              </div>

              <div *ngIf="hasSelected(AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign, cfg.id!)"
                class="file-preview">
                <span class="file-name">
                  {{ selectedFileName(AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign, cfg.id!) }}
                </span>
                <img
                  *ngIf="getPreview(AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign, cfg.id!) &&
                           state(AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign).selected[cfg.id!].type.startsWith('image/')"
                  [src]="getPreview(AttachmentsConfigType.RequestAnEventAnnouncementOrDonationCampaign, cfg.id!)"
                  class="preview-image w-100">
              </div>
            </div>
          </div>

          <!-- Add button -->
          <div class="d-flex justify-content-end mt-3">
            <button type="button" class="btn btn-primary" (click)="addAdvertisement()">
              {{
              'COMMON.ADD' | translate
              }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Workflow Steps Modal -->
<div class="modal fade show" tabindex="-1" *ngIf="showWfModal"
  [ngStyle]="{ display: showWfModal ? 'block' : 'none', background: 'rgba(0,0,0,0.5)' }">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 rounded-4 shadow-lg">

      <div class="modal-header">
        <h5 class="modal-title" id="addAdvertisementModalLabel"><i class="fas fa-route me-2"></i>{{
          'WORKFLOW.PROCESS_STEPS' | translate }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <!-- <div class="modal-header bg-primary text-white rounded-top-4 border-0">
        <h5 class="modal-title fs-5 fw-bold">
          <i class="fas fa-route me-2"></i>{{ 'WORKFLOW.PROCESS_STEPS' | translate }}
        </h5>
        <button type="button" class="btn-close btn-close-white" aria-label="Close" (click)="closeWfModal()"></button>
      </div> -->

      <div class="modal-body p-4">
        <div *ngIf="!addWorkFlowSteps?.length" class="alert alert-info mb-0">
          {{ 'COMMON.NO_DATA' | translate }}
        </div>

        <div class="workflow-timeline" *ngIf="addWorkFlowSteps?.length">
          <div *ngFor="let step of addWorkFlowSteps; let i = index; trackBy: trackByStepId" class="workflow-step-item"
            [class.completed]="isStepCompleted(step.serviceStatus)"
            [class.rejected]="isStepRejected(step.serviceStatus)" [class.pending]="isStepPending(step.serviceStatus)"
            [class.last-step]="i === addWorkFlowSteps.length - 1">

            <div class="step-circle" [style.background-color]="getStatusColor(step.serviceStatus)"
              [style.border-color]="getStatusColor(step.serviceStatus)">
              <i [class]="getStatusIcon(step.serviceStatus)"></i>
            </div>

            <div class="step-line" *ngIf="i < addWorkFlowSteps.length - 1"
              [class.completed-line]="isStepCompleted(step.serviceStatus)"></div>

            <div>
              <div class="step-header">

                <div class="step-number">
                  <!--{{ 'WORKFLOW.STEP' | translate }} {{step.stepOrder}}-->
                  {{ step?.stepName || (('WORKFLOW.STEP' | translate) + ' ' + step?.stepOrder) }}
                </div>
                <div class="step-status" [style.color]="getStatusColor(step.serviceStatus)">
                  <i [class]="getStatusIcon(step.serviceStatus)" class="me-1"></i>
                  {{ step.serviceStatusName || (getStatusLabel(step.serviceStatus) | translate) }}
                </div>
              </div>
              <h6 class="department-name">{{ step.departmentName }}</h6>
              <button type="button" class="btn btn-link p-0" (click)="openHistoryModal(step.workFlowHistories || [])">
                <i class="bi bi-clock-history me-1"></i>{{'WORKFLOW.VIEW_HISTORY' | translate}}
              </button>
            </div>

          </div>
        </div>
      </div>

      <div class="modal-footer border-0 rounded-bottom-4 justify-content-center">
        <button type="button" class="btn btn-secondary" (click)="closeWfModal()">
          {{ 'COMMON.CLOSE' | translate }}
        </button>
      </div>

    </div>
  </div>
</div>


<div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="historyModalLabel" class="modal-title">
          {{ 'WORKFLOW.HISTORY' | translate }}
        </h5>
        <button type="button" class="btn-close" (click)="closeHistoryModal()" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <ng-container *ngIf="historyForModal?.length; else noHistory">

          <div class="history-timeline">
            <div class="history-item" *ngFor="let h of historyForModal; let i = index">
              <div class="dot"></div>
              <div class="content">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <div class="step-status" [style.color]="getStatusColor(h.serviceStatus)">
                    <i [class]="getStatusIcon(h.serviceStatus)" class="me-1"></i>
                    {{h.serviceStatusName || (getStatusLabel(h.serviceStatus) | translate)}}
                  </div>
                  <small class="text-muted">
                    {{ h.historyDate | date:'medium' }}
                  </small>
                </div>

                <div class="mb-1">
                  <small class="text-muted">{{ 'mainApplyServiceResourceName.WORKFLOW.BY' | translate }}:</small>
                  <span>{{ h.userName }}</span>
                </div>

                <div class="mb-1" *ngIf="h.fromDepartmentName">
                  <small class="text-muted">{{ 'mainApplyServiceResourceName.WORKFLOW.FROM_DEPT' | translate }}:</small>
                  <span>{{ h.fromDepartmentName }}</span>
                </div>

                <div class="mb-1" *ngIf="h.toDepartmentName">
                  <small class="text-muted">{{ 'mainApplyServiceResourceName.WORKFLOW.TO_DEPT' | translate }}:</small>
                  <span>{{ h.toDepartmentName }}</span>
                </div>

                <div class="mb-1" *ngIf="getHistoryNote(h)">
                  <small class="text-muted">{{ 'mainApplyServiceResourceName.WORKFLOW.NOTE' | translate }}:</small>
                  <span>{{ getHistoryNote(h) }}</span>
                </div>

                <div class="mb-1" *ngIf="h.description">
                  <small class="text-muted">{{ 'mainApplyServiceResourceName.WORKFLOW.DESCRIPTION' | translate
                    }}:</small>
                  <span>{{ h.description }}</span>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <ng-template #noHistory>
          <div class="text-center text-muted py-4">
            {{ 'WORKFLOW.NO_HISTORY' | translate }}
          </div>
        </ng-template>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" (click)="closeHistoryModal()">
          {{ 'COMMON.CLOSE' | translate }}
        </button>
      </div>
    </div>
  </div>
</div>
