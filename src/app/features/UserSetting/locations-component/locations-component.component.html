<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="title">{{ 'LOCATIONS.TITLE' | translate }}</h1>
    <button class="btn btn-gold" (click)="openAddModal()">
      <i class="fas fa-plus"></i> {{ 'LOCATIONS.ADD_NEW' | translate }}
    </button>
  </div>

  <!-- Filter Section -->
  <div class="filter mb-3">
    <div class="d-flex justify-content-between align-items-center">
      <h4 class="filter-title mb-0">{{ 'Common.SearchTitle' | translate }}</h4>
      <button class="btn btn-filter" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFilterTab">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none">
          <path
            d="M17.7499 6.31657H13.0999C12.7749 6.31657 12.5166 6.05824 12.5166 5.73324C12.5166 5.40824 12.7749 5.1499 13.0999 5.1499H17.7499C18.0749 5.1499 18.3333 5.40824 18.3333 5.73324C18.3333 6.05824 18.0749 6.31657 17.7499 6.31657Z"
            fill="" />
          <path
            d="M5.35033 6.31657H2.25033C1.92533 6.31657 1.66699 6.05824 1.66699 5.73324C1.66699 5.40824 1.92533 5.1499 2.25033 5.1499H5.35033C5.67533 5.1499 5.93366 5.40824 5.93366 5.73324C5.93366 6.05824 5.66699 6.31657 5.35033 6.31657Z"
            fill="" />
          <path
            d="M8.44987 9.02523C10.2678 9.02523 11.7415 7.5515 11.7415 5.73356C11.7415 3.91562 10.2678 2.44189 8.44987 2.44189C6.63193 2.44189 5.1582 3.91562 5.1582 5.73356C5.1582 7.5515 6.63193 9.02523 8.44987 9.02523Z"
            fill="" />
          <path
            d="M17.7497 14.8415H14.6497C14.3247 14.8415 14.0664 14.5831 14.0664 14.2581C14.0664 13.9331 14.3247 13.6748 14.6497 13.6748H17.7497C18.0747 13.6748 18.3331 13.9331 18.3331 14.2581C18.3331 14.5831 18.0747 14.8415 17.7497 14.8415Z"
            fill="" />
          <path
            d="M6.90033 14.8415H2.25033C1.92533 14.8415 1.66699 14.5831 1.66699 14.2581C1.66699 13.9331 1.92533 13.6748 2.25033 13.6748H6.90033C7.22533 13.6748 7.48366 13.9331 7.48366 14.2581C7.48366 14.5831 7.21699 14.8415 6.90033 14.8415Z"
            fill="" />
          <path
            d="M11.5505 17.5584C13.3684 17.5584 14.8421 16.0847 14.8421 14.2668C14.8421 12.4488 13.3684 10.9751 11.5505 10.9751C9.73252 10.9751 8.25879 12.4488 8.25879 14.2668C8.25879 16.0847 9.73252 17.5584 11.5505 17.5584Z"
            fill="" />
        </svg>
      </button>
    </div>

    <div class="collapse" id="collapseFilterTab">
      <div class="card card-body">
        <div class="row mb-3">
          <div class="col-xl-6 mb-3">
            <label for="searchName" class="form-label">{{ 'LOCATIONS.SEARCH_NAME' | translate }}</label>
            <input type="text" class="form-control" id="searchName"
              placeholder="{{ 'LOCATIONS.SEARCH_PLACEHOLDER' | translate }}" [(ngModel)]="searchValue"
              name="searchName">
          </div>
        </div>

        <div class="d-flex gap-2 justify-content-center">
          <button class="btn btn-outline" (click)="clear()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
              <path
                d="M16.19 2H7.81C4.17 2 2 4.17 2 7.81V16.18C2 19.83 4.17 22 7.81 22H16.18C19.82 22 21.99 19.83 21.99 16.19V7.81C22 4.17 19.83 2 16.19 2ZM16 12.75H8C7.59 12.75 7.25 12.41 7.25 12C7.25 11.59 7.59 11.25 8 11.25H16C16.41 11.25 16.75 11.59 16.75 12C16.75 12.41 16.41 12.75 16 12.75Z"
                fill="#5B5B5B" />
            </svg>
            {{ 'Common.Clear' | translate }}
          </button>
          <button class="btn btn-gold" (click)="onSearch()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
              <path
                d="M16.19 2H7.81C4.17 2 2 4.17 2 7.81V16.18C2 19.83 4.17 22 7.81 22H16.18C19.82 22 21.99 19.83 21.99 16.19V7.81C22 4.17 19.83 2 16.19 2ZM16.78 9.7L11.11 15.37C10.97 15.51 10.78 15.59 10.58 15.59C10.38 15.59 10.19 15.51 10.05 15.37L7.22 12.54C6.93 12.25 6.93 11.77 7.22 11.48C7.51 11.19 7.99 11.19 8.28 11.48L10.58 13.78L15.72 8.64C16.01 8.35 16.49 8.35 16.78 8.64C17.07 8.93 17.07 9.4 16.78 9.7Z"
                fill="white" />
            </svg>
            {{ 'Common.Search' | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Generic Data Table -->
  <app-generic-data-table [columnDefs]="columnDefs" [rowData]="locations" [totalCount]="totalCount"
    [pageSize]="pageSize" [currentPage]="currentPage" [showActionColumn]="true" [rowActions]="rowActions"
    (actionClick)="onActionClick($event)" (pageChange)="onPageChange($event)" (search)="onSearch($event)">
  </app-generic-data-table>

  <!-- Location Modal -->
  <div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="locationModalLabel">
            {{ mode === 'add' ? ('LOCATIONS.ADD_NEW' | translate) : mode === 'edit' ? ('LOCATIONS.EDIT' | translate) :
            ('LOCATIONS.VIEW' | translate) }}
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <form [formGroup]="locationForm" (ngSubmit)="submit()">
          <div class="modal-body">
            <!-- Basic Information -->
            <div class="row">
              <div class="col-xl-6 mb-3">
                <label for="locationName" class="form-label">{{ 'LOCATIONS.LOCATION_NAME' | translate }}</label>
                <input type="text" id="locationName" class="form-control"
                  [ngClass]="{'is-invalid': locationForm.get('locationName')?.invalid && (locationForm.get('locationName')?.touched || submitted)}"
                  formControlName="locationName" placeholder="{{ 'LOCATIONS.ENTER_LOCATION_NAME' | translate }}"
                  [readonly]="mode === 'view'" />
                <div
                  *ngIf="locationForm.get('locationName')?.invalid && (locationForm.get('locationName')?.touched || submitted)"
                  class="invalid-feedback">
                  {{ getFieldError('locationName') }}
                </div>
              </div>

              <div class="col-xl-6 mb-3">
                <label for="address" class="form-label">{{ 'LOCATIONS.LOCATION_ADDRESS' | translate }}</label>
                <input type="text" id="address" class="form-control"
                  [ngClass]="{'is-invalid': locationForm.get('address')?.invalid && (locationForm.get('address')?.touched || submitted)}"
                  formControlName="address" placeholder="{{ 'LOCATIONS.ENTER_LOCATION_ADDRESS' | translate }}"
                  [readonly]="mode === 'view'" />
                <div *ngIf="locationForm.get('address')?.invalid && (locationForm.get('address')?.touched || submitted)"
                  class="invalid-feedback">
                  {{ getFieldError('address') }}
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-xl-6 mb-3">
                <label for="street" class="form-label">Street</label>
                <input type="text" id="street" class="form-control" formControlName="street" placeholder="Enter street"
                  [readonly]="mode === 'view'" />
              </div>

              <div class="col-xl-6 mb-3">
                <label for="regionId" class="form-label">Region</label>
                <div *ngIf="mode === 'view'" class="form-control bg-light">
                  {{ getRegionDisplayText(locationForm.get('regionId')?.value) || 'No region selected' }}
                </div>
                <ng-select *ngIf="mode !== 'view'" id="regionId" formControlName="regionId" [items]="regions"
                  [clearable]="false" [searchable]="true" placeholder="Select Region"
                  [ngClass]="{'is-invalid': locationForm.get('regionId')?.invalid && (locationForm.get('regionId')?.touched || submitted)}"
                  bindLabel="text" bindValue="id" [loading]="isLoadingDropdowns" class="ng-select-custom">
                </ng-select>
                <div
                  *ngIf="locationForm.get('regionId')?.invalid && (locationForm.get('regionId')?.touched || submitted)"
                  class="invalid-feedback">
                  {{ getFieldError('regionId') }}
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-xl-6 mb-3">
                <label for="locationTypeId" class="form-label">Location Type</label>
                <div *ngIf="mode === 'view'" class="form-control bg-light">
                  {{ getLocationTypeDisplayText(locationForm.get('locationTypeId')?.value) || 'No location type
                  selected' }}
                </div>
                <ng-select *ngIf="mode !== 'view'" id="locationTypeId" formControlName="locationTypeId"
                  [items]="locationTypes" [clearable]="false" [searchable]="true" placeholder="Select Location Type"
                  [ngClass]="{'is-invalid': locationForm.get('locationTypeId')?.invalid && (locationForm.get('locationTypeId')?.touched || submitted)}"
                  bindLabel="text" bindValue="id" [loading]="isLoadingDropdowns" class="ng-select-custom">
                </ng-select>
                <div
                  *ngIf="locationForm.get('locationTypeId')?.invalid && (locationForm.get('locationTypeId')?.touched || submitted)"
                  class="invalid-feedback">
                  {{ getFieldError('locationTypeId') }}
                </div>
              </div>

              <div class="col-xl-6 mb-3">
                <label for="isActive" class="form-label">{{ 'LOCATIONS.STATUS' | translate }}</label>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="isActive" formControlName="isActive"
                    [disabled]="mode === 'view'">
                  <label class="form-check-label" for="isActive">{{ 'LOCATIONS.ACTIVE' | translate }}</label>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-xl-12 mb-3">
                <label for="notes" class="form-label">Notes</label>
                <textarea class="form-control" id="notes" rows="3" formControlName="notes" placeholder="Enter notes"
                  [readonly]="mode === 'view'"></textarea>
              </div>
            </div>

            <!-- Map Section -->
            <div class="row">
              <div class="col-xl-12 mb-3">
                <label class="form-label">Location on Map</label>
                <div class="d-flex justify-content-between align-items-center mb-2" *ngIf="mode !== 'view'">
                  <small class="text-muted">Click on the map to set the location coordinates</small>
                  <button type="button" class="btn btn-sm btn-outline-primary" (click)="getCoordinatesFromAddress()"
                    [disabled]="!locationForm.get('address')?.value">
                    <i class="fas fa-map-marker-alt"></i> Get from Address
                  </button>
                </div>
                <div id="locationMap" class="map-container">
                  <div class="map-loading">
                    <div>Map Loading...</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Coordinates Display -->
            <div class="row">
              <div class="col-xl-6 mb-3">
                <label class="form-label">Coordinates Display</label>
                <div class="form-control bg-light">
                  <span *ngIf="selectedCoordinates; else noCoordinates">
                    <strong>Lat:</strong> {{ selectedCoordinates.lat | number:'1.6-6' }} |
                    <strong>Lng:</strong> {{ selectedCoordinates.lng | number:'1.6-6' }}
                  </span>
                  <ng-template #noCoordinates>
                    <span class="text-muted">No coordinates selected</span>
                  </ng-template>
                </div>
              </div>
            </div>

            <!-- File Upload Section -->
            <div class="row" *ngIf="mode !== 'view'">
              <div class="col-xl-12 mb-3">
                <div class="file-upload-section">
                  <label for="locationImage" class="form-label">
                    <i class="fas fa-image me-2"></i>Location Image
                    <span class="text-danger">*</span>
                  </label>

                  <!-- Enhanced Existing Image Display for Edit Mode -->
                  <div *ngIf="existingImageUrl && mode === 'edit'" class="existing-image-container mb-3">
                    <div class="image-header">
                      <div class="image-info">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <span class="text-success fw-bold">Current Image</span>
                      </div>
                      <div class="image-actions">
                        <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeExistingImage()">
                          <i class="fas fa-trash"></i> Remove
                        </button>
                      </div>
                    </div>
                    <div class="image-preview-container">
                      <img [src]="existingImageUrl" alt="Current Location Image" class="enhanced-img-preview"
                        (error)="onImageError($event)" (load)="onImageLoad($event)">
                      <div class="image-overlay">
                        <div class="image-actions-overlay">
                          <button type="button" class="btn btn-sm btn-light" (click)="openImageInNewTab()">
                            <i class="fas fa-external-link-alt"></i> View Full
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Enhanced File Input Area -->
                  <div class="file-input-container">
                    <div class="file-drop-zone" [class.has-file]="selectedFile || (existingImageUrl && mode === 'edit')"
                      [class.is-dragover]="isDragOver" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)"
                      (drop)="onDrop($event)">
                      <div class="file-drop-content">
                        <i class="fas fa-cloud-upload-alt file-upload-icon"></i>
                        <h6 class="file-upload-title">
                          {{ selectedFile ? 'File Selected' : (existingImageUrl && mode === 'edit' ? 'Current Image
                          Available' : 'Drop your image here') }}
                        </h6>
                        <p class="file-upload-subtitle">
                          {{ selectedFile ? selectedFile.name : 'or click to browse' }}
                        </p>
                        <div class="file-requirements">
                          <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Supported formats: JPG, PNG, PDF (Max 2MB)
                          </small>
                        </div>
                      </div>
                      <input type="file" class="form-control file-input" id="locationImage"
                        accept=".jpg,.jpeg,.png,.pdf" (change)="onFileSelected($event)">
                    </div>
                  </div>

                  <!-- Enhanced New File Preview -->
                  <div *ngIf="filePreview" class="new-file-preview mt-3">
                    <div class="preview-header">
                      <div class="preview-info">
                        <i class="icon-frame-view text-primary me-2"></i>
                        <span class="text-primary fw-bold">New File Preview</span>
                      </div>
                      <div class="preview-actions">
                        <button type="button" class="btn btn-sm btn-outline-success me-2"
                          (click)="confirmFileSelection()">
                          <i class="fas fa-check"></i> Confirm
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeFile()">
                          <i class="fas fa-times"></i> Remove
                        </button>
                      </div>
                    </div>
                    <div class="preview-container">
                      <img [src]="filePreview" alt="File Preview" class="enhanced-img-preview">
                    </div>
                  </div>

                  <!-- File Upload Progress (if needed) -->
                  <div *ngIf="uploadProgress > 0 && uploadProgress < 100" class="upload-progress mt-3">
                    <div class="progress">
                      <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                        [style.width.%]="uploadProgress" [attr.aria-valuenow]="uploadProgress" aria-valuemin="0"
                        aria-valuemax="100">
                        {{ uploadProgress }}%
                      </div>
                    </div>
                  </div>

                  <!-- Enhanced Validation Messages -->
                  <div class="validation-messages mt-2">
                    <div *ngIf="fileValidationErrors.length > 0" class="alert alert-danger">
                      <i class="fas fa-exclamation-triangle me-2"></i>
                      <ul class="mb-0">
                        <li *ngFor="let error of fileValidationErrors">{{ error }}</li>
                      </ul>
                    </div>
                    <div *ngIf="fileValidationSuccess" class="alert alert-success">
                      <i class="fas fa-check-circle me-2"></i>
                      File is valid and ready for upload
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Enhanced File Display Section for View Mode -->
            <div class="row" *ngIf="mode === 'view' && existingImageUrl">
              <div class="col-xl-12 mb-3">
                <div class="view-image-section">
                  <label class="form-label">
                    <i class="fas fa-image me-2"></i>Location Image
                  </label>
                  <div class="view-image-container">
                    <img [src]="existingImageUrl" alt="Location Image" class="enhanced-img-preview view-mode"
                      (error)="onImageError($event)" (load)="onImageLoad($event)">
                    <div class="view-image-overlay">
                      <button type="button" class="btn btn-sm btn-light" (click)="openImageInNewTab()">
                        <i class="fas fa-external-link-alt"></i> View Full Size
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="modal-footer" *ngIf="mode !== 'view'">
            <button type="button" class="btn btn-outline" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-gold" [disabled]="locationForm.invalid || submitted">
              {{ mode === 'add' ? 'Create' : 'Update' }}
            </button>
          </div>
          <div class="modal-footer" *ngIf="mode === 'view'">
            <button type="button" class="btn btn-outline" data-bs-dismiss="modal">Close</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteLocationModal" tabindex="-1" aria-labelledby="deleteLocationModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteLocationModalLabel">Confirm Delete</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete this location?</p>
          <div *ngIf="selectedLocationToDelete" class="delete-confirmation-details">
            <strong>{{ 'LOCATIONS.LOCATION_NAME' | translate }}:</strong> {{ selectedLocationToDelete.locationName
            }}<br>
            <strong>{{ 'LOCATIONS.LOCATION_ADDRESS' | translate }}:</strong> {{ selectedLocationToDelete.address ||
            'N/A' }}<br>
            <strong>Street:</strong> {{ selectedLocationToDelete.street || 'N/A' }}<br>
            <strong>Region:</strong> {{ selectedLocationToDelete.regionName || 'N/A' }}<br>
            <strong>Location Type:</strong> {{ selectedLocationToDelete.locationType || 'N/A' }}<br>
            <strong>{{ 'LOCATIONS.STATUS' | translate }}:</strong> {{ selectedLocationToDelete.isActive ? 'Active' :
            'Inactive' }}<br>
            <strong>Notes:</strong> {{ selectedLocationToDelete.notes || 'N/A' }}
          </div>
          <p class="text-danger">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" (click)="deleteLocation()"
            data-bs-dismiss="modal">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Attachment Confirmation Modal -->
  <div class="modal fade" id="deleteAttachmentModal" tabindex="-1" aria-labelledby="deleteAttachmentModalLabel"
    aria-hidden="true" (hidden.bs.modal)="cancelDeleteAttachment()">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteAttachmentModalLabel">Confirm Delete Attachment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
            (click)="cancelDeleteAttachment()"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete this attachment?</p>
          <div *ngIf="selectedAttachmentToDelete" class="delete-confirmation-details">
            <strong>Attachment Title:</strong> {{ selectedAttachmentToDelete.attachmentTitle || 'N/A' }}<br>
            <strong>File Path:</strong> {{ selectedAttachmentToDelete.imgPath || 'N/A' }}<br>
            <strong>Master Type:</strong> {{ selectedAttachmentToDelete.masterType || 'N/A' }}<br>
            <strong>Master ID:</strong> {{ selectedAttachmentToDelete.masterId || 'N/A' }}<br>
            <strong>Config ID:</strong> {{ selectedAttachmentToDelete.attConfigID || 'N/A' }}
          </div>
          <p class="text-danger">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline" data-bs-dismiss="modal"
            (click)="cancelDeleteAttachment()">Cancel</button>
          <button type="button" class="btn btn-danger" (click)="confirmDeleteAttachment()"
            data-bs-dismiss="modal">Delete</button>
        </div>
      </div>
    </div>
  </div>
</div>