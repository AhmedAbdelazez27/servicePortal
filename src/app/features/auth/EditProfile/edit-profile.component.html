<div class="registration-container">
  <section>
    <div class="container">
     

      <div class="row">
        <div class="col-xl-1"></div>
        <div class="col-xl-10">
          
          <!-- Loading State -->
          <div *ngIf="isLoadingUserData" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">{{ 'EDIT_PROFILE.LOADING' | translate }}</span>
            </div>
            <p class="mt-3">{{ 'EDIT_PROFILE.LOADING_PROFILE' | translate }}</p>
          </div>

          <!-- Profile Form -->
          <form [formGroup]="profileForm" *ngIf="!isLoadingUserData">
            
            <!-- Page Title -->
            <!-- <h4 class="title">{{ 'EDIT_PROFILE.PROFILE' | translate }}</h4> -->

            <!-- Change Password Button -->
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2 class="title">{{ 'EDIT_PROFILE.PROFILE' | translate }}</h2>
              <button 
                type="button" 
                class="btn btn-gold"
                (click)="openPasswordModal()">
                <i class="fas fa-key me-2"></i>
                <span>{{ 'EDIT_PROFILE.CHANGE_PASSWORD' | translate }}</span>
              </button>
            </div>

            <!-- Basic Information Section -->
            <div class="login-box mb-4">
              <div class="card-header">
                <h2 class="title gold mb-4">{{ 'REGISTRATION.BASIC_INFO' | translate }}</h2>
                <button 
                  type="button" 
                  class="btn btn-gold"
                  (click)="toggleBasicInfoEditMode()"
                  *ngIf="!isBasicInfoEditMode">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <g clip-path="url(#clip0_4_1412)">
                      <path d="M22.853 1.14795C22.1732 0.469151 21.2517 0.0878906 20.291 0.0878906C19.3303 0.0878906 18.4089 0.469151 17.729 1.14795L1.46502 17.412C0.999266 17.8751 0.629977 18.426 0.378513 19.0327C0.127049 19.6395 -0.00159798 20.2901 1.49812e-05 20.947V23C1.49812e-05 23.2652 0.105372 23.5195 0.292908 23.7071C0.480445 23.8946 0.734799 24 1.00002 24H3.05301C3.70978 24.0018 4.36038 23.8734 4.96717 23.6221C5.57396 23.3708 6.12487 23.0016 6.58801 22.536L22.853 6.27095C23.5315 5.59115 23.9126 4.66992 23.9126 3.70945C23.9126 2.74899 23.5315 1.82776 22.853 1.14795ZM5.17401 21.122C4.61002 21.6822 3.84798 21.9977 3.05301 22H2.00002V20.947C1.999 20.5529 2.07617 20.1625 2.22705 19.7984C2.37793 19.4343 2.59953 19.1038 2.87901 18.826L15.222 6.48295L17.522 8.78295L5.17401 21.122ZM21.438 4.85695L18.932 7.36395L16.632 5.06895L19.139 2.56195C19.29 2.41126 19.4693 2.29179 19.6664 2.21036C19.8636 2.12893 20.0749 2.08714 20.2883 2.08738C20.5016 2.08761 20.7128 2.12986 20.9098 2.21172C21.1069 2.29357 21.2858 2.41343 21.4365 2.56445C21.5872 2.71547 21.7067 2.8947 21.7881 3.09189C21.8695 3.28908 21.9113 3.50038 21.9111 3.71372C21.9109 3.92706 21.8686 4.13827 21.7868 4.33529C21.7049 4.5323 21.585 4.71126 21.434 4.86195L21.438 4.85695Z" fill="#ffffff"/>
                    </g>
                    <defs>
                      <clipPath id="clip0_4_1412">
                        <rect width="24" height="24" fill="white"/>
                      </clipPath>
                    </defs>
                  </svg>
                  <span>{{ 'EDIT_PROFILE.EDIT' | translate }}</span>
                </button>
              </div>
              
              <div class="info-data">
                <!-- Profile Photo Section -->
                <div class="info-data">
                  <div class="info-data" *ngIf="!isBasicInfoEditMode">
                    <img 
                      class="profile-img" 
                      [src]="profilePhotoPreview || 'assets/images/profile-img.png'" 
                      [alt]="'EDIT_PROFILE.PROFILE_PHOTO' | translate" />
                  </div>
                  
                  <div class="profile-photo-upload" *ngIf="isBasicInfoEditMode" (click)="triggerProfilePhotoInput()">
                    <!-- Show current photo with overlay when in edit mode -->
                    <div class="photo-with-overlay" *ngIf="profilePhotoPreview">
                      <img 
                        class="profile-img" 
                        [src]="profilePhotoPreview" 
                        [alt]="'EDIT_PROFILE.PROFILE_PHOTO' | translate" />
                      <div class="photo-edit-overlay">
                        <div class="camera-icon">
                          <i class="fas fa-camera" style="font-size: 2rem;"></i>
                        </div>
                        <div>{{ 'EDIT_PROFILE.CHANGE_PHOTO' | translate }}</div>
                      </div>
                    </div>
                    
                    <!-- Show placeholder only when no photo exists -->
                    <div class="photo-placeholder" *ngIf="!profilePhotoPreview">
                      <div class="text-center">
                        <div class="camera-icon">
                          <i class="fas fa-camera" style="font-size: 2rem;"></i>
                        </div>
                        <div>{{ 'EDIT_PROFILE.UPLOAD_PHOTO' | translate }}</div>
                      </div>
                    </div>
                    
                    <input 
                      type="file" 
                      id="profilePhotoInput"
                      accept="image/*"
                      (change)="onProfilePhotoSelected($event)"
                      style="display: none;">
                  </div>
                </div>

                <!-- Basic Information Fields -->
                <div class="pig-gr">
                  <div class="gr-1">
                    <div class="data-1">
                      <h2>{{ 'REGISTRATION.NAME_EN' | translate }}</h2>
                      <p *ngIf="!isBasicInfoEditMode">{{ profileForm.get('nameEn')?.value || '-' }}</p>
                      <input 
                        *ngIf="isBasicInfoEditMode"
                        type="text" 
                        class="form-control" 
                        formControlName="nameEn"
                        [class.is-invalid]="isFieldInvalid('nameEn')"
                        placeholder="{{ 'REGISTRATION.ENTER_NAME_EN' | translate }}">
                      <div class="invalid-feedback" *ngIf="isBasicInfoEditMode && isFieldInvalid('nameEn')">
                        {{ getFieldError('nameEn') }}
                      </div>
                    </div>

                    <div class="data-1">
                      <h2>{{ 'REGISTRATION.NAME_AR' | translate }}</h2>
                      <p *ngIf="!isBasicInfoEditMode">{{ profileForm.get('name')?.value || '-' }}</p>
                      <input 
                        *ngIf="isBasicInfoEditMode"
                        type="text" 
                        class="form-control" 
                        formControlName="name"
                        [class.is-invalid]="isFieldInvalid('name')"
                        placeholder="{{ 'REGISTRATION.ENTER_NAME_AR' | translate }}">
                      <div class="invalid-feedback" *ngIf="isBasicInfoEditMode && isFieldInvalid('name')">
                        {{ getFieldError('name') }}
                      </div>
                    </div>
                  </div>

                  <div class="gr-1">
                    <div class="data-1">
                      <h2>{{ 'REGISTRATION.USERNAME' | translate }}</h2>
                      <p *ngIf="!isBasicInfoEditMode">{{ profileForm.get('userName')?.value || '-' }}</p>
                      <input 
                        *ngIf="isBasicInfoEditMode"
                        type="text" 
                        class="form-control" 
                        formControlName="userName"
                        [class.is-invalid]="isFieldInvalid('userName')"
                        placeholder="{{ 'REGISTRATION.ENTER_USERNAME' | translate }}">
                      <div class="invalid-feedback" *ngIf="isBasicInfoEditMode && isFieldInvalid('userName')">
                        {{ getFieldError('userName') }}
                      </div>
                    </div>

                    <div class="data-1">
                      <h2>{{ 'REGISTRATION.CIVIL_ID' | translate }}</h2>
                      <p *ngIf="!isBasicInfoEditMode">{{ profileForm.get('civilId')?.value || '-' }}</p>
                      <input 
                        *ngIf="isBasicInfoEditMode"
                        type="text" 
                        class="form-control" 
                        formControlName="civilId"
                        [class.is-invalid]="isFieldInvalid('civilId')"
                        placeholder="{{ 'REGISTRATION.ENTER_CIVIL_ID' | translate }}">
                      <div class="invalid-feedback" *ngIf="isBasicInfoEditMode && isFieldInvalid('civilId')">
                        {{ getFieldError('civilId') }}
                      </div>
                    </div>

                    <!-- Individual User Fields -->
                    <div class="data-1" *ngIf="isIndividualUser()">
                      <h2>{{ 'REGISTRATION.GENDER' | translate }}</h2>
                      <p *ngIf="!isBasicInfoEditMode">{{ getGenderDisplayValue() }}</p>
                      <input 
                        *ngIf="isBasicInfoEditMode"
                        type="text" 
                        class="form-control" 
                        [value]="getGenderDisplayValue()"
                        [disabled]="true"
                        readonly>
                    </div>
                  </div>

                  <!-- Institution User Fields -->
                  
                  <div class="gr-1" *ngIf="isInstitutionUser()">
                    <div class="data-1">
                      <h2>{{ 'REGISTRATION.ENTITY' | translate }}</h2>
                      <p *ngIf="!isBasicInfoEditMode">
                        {{ getEntityDisplayValue() }}
                      </p>
                      <ng-select 
                        *ngIf="isBasicInfoEditMode"
                        formControlName="entityId"
                        [class.is-invalid]="isFieldInvalid('entityId')"
                        [placeholder]="'REGISTRATION.SELECT_ENTITY' | translate"
                        [items]="entities"
                        bindLabel="text"
                        class="w-100"
                        bindValue="id"
                        [loading]="entitiesLoading"
                        (scrollToEnd)="onEntitiesScrollToEnd()">
                      </ng-select>
                      <div class="invalid-feedback" *ngIf="isBasicInfoEditMode && isFieldInvalid('entityId')">
                        {{ getFieldError('entityId') }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Edit Mode Buttons -->
              <div class="btn-grp" *ngIf="isBasicInfoEditMode">
                <button 
                  type="button" 
                  class="btn btn-gray" 
                  (click)="cancelBasicInfo()">
                  <span>{{ 'EDIT_PROFILE.CANCEL' | translate }}</span>
                </button>

                <button 
                  type="button" 
                  class="btn btn-gold" 
                  (click)="saveBasicInfo()"
                  [disabled]="isLoading">
                  <span *ngIf="!isLoading">{{ 'EDIT_PROFILE.SAVE' | translate }}</span>
                  <span *ngIf="isLoading">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    {{ 'EDIT_PROFILE.SAVING' | translate }}
                  </span>
                </button>
              </div>
            </div>

            <!-- Contact Information & Address Section (Combined) -->
            <div class="login-box mb-4">
              <div class="card-header">
                <h2 class="title gold mb-4">{{ 'EDIT_PROFILE.CONTACT_ADDRESS_INFO' | translate }}</h2>
                <button 
                  type="button" 
                  class="btn btn-gold"
                  (click)="toggleContactAddressEditMode()"
                  *ngIf="!isContactAddressEditMode">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <g clip-path="url(#clip0_4_1412)">
                      <path d="M22.853 1.14795C22.1732 0.469151 21.2517 0.0878906 20.291 0.0878906C19.3303 0.0878906 18.4089 0.469151 17.729 1.14795L1.46502 17.412C0.999266 17.8751 0.629977 18.426 0.378513 19.0327C0.127049 19.6395 -0.00159798 20.2901 1.49812e-05 20.947V23C1.49812e-05 23.2652 0.105372 23.5195 0.292908 23.7071C0.480445 23.8946 0.734799 24 1.00002 24H3.05301C3.70978 24.0018 4.36038 23.8734 4.96717 23.6221C5.57396 23.3708 6.12487 23.0016 6.58801 22.536L22.853 6.27095C23.5315 5.59115 23.9126 4.66992 23.9126 3.70945C23.9126 2.74899 23.5315 1.82776 22.853 1.14795ZM5.17401 21.122C4.61002 21.6822 3.84798 21.9977 3.05301 22H2.00002V20.947C1.999 20.5529 2.07617 20.1625 2.22705 19.7984C2.37793 19.4343 2.59953 19.1038 2.87901 18.826L15.222 6.48295L17.522 8.78295L5.17401 21.122ZM21.438 4.85695L18.932 7.36395L16.632 5.06895L19.139 2.56195C19.29 2.41126 19.4693 2.29179 19.6664 2.21036C19.8636 2.12893 20.0749 2.08714 20.2883 2.08738C20.5016 2.08761 20.7128 2.12986 20.9098 2.21172C21.1069 2.29357 21.2858 2.41343 21.4365 2.56445C21.5872 2.71547 21.7067 2.8947 21.7881 3.09189C21.8695 3.28908 21.9113 3.50038 21.9111 3.71372C21.9109 3.92706 21.8686 4.13827 21.7868 4.33529C21.7049 4.5323 21.585 4.71126 21.434 4.86195L21.438 4.85695Z" fill="#ffffff"/>
                    </g>
                    <defs>
                      <clipPath id="clip0_4_1412">
                        <rect width="24" height="24" fill="white"/>
                      </clipPath>
                    </defs>
                  </svg>
                  <span>{{ 'EDIT_PROFILE.EDIT' | translate }}</span>
                </button>
              </div>
              
              <div class="pig-gr">
                <!-- Contact Information -->
                <div class="gr-1">
                  <div class="data-1">
                    <h2>{{ 'REGISTRATION.EMAIL' | translate }}</h2>
                    <p *ngIf="!isContactAddressEditMode">{{ profileForm.get('email')?.value || '-' }}</p>
                    <input 
                      *ngIf="isContactAddressEditMode"
                      type="email" 
                      class="form-control" 
                      formControlName="email"
                      [class.is-invalid]="isFieldInvalid('email')"
                      placeholder="{{ 'REGISTRATION.ENTER_EMAIL' | translate }}">
                    <div class="invalid-feedback" *ngIf="isContactAddressEditMode && isFieldInvalid('email')">
                      {{ getFieldError('email') }}
                    </div>
                  </div>

                  <div class="data-1">
                    <h2>{{ 'REGISTRATION.MOBILE' | translate }}</h2>
                    <p *ngIf="!isContactAddressEditMode">{{ profileForm.get('phoneNumber')?.value || '-' }}</p>
                    
                    <!-- Mobile Number Input with UAE Flag and +971 prefix -->
                    <div *ngIf="isContactAddressEditMode" class="mobile-input-container" [class.is-invalid]="isFieldInvalid('phoneNumber')">
                      <div class="mobile-prefix-container">
                        <img src="assets/images/Flag_of_the_United_Arab_Emirates.svg.png" alt="UAE Flag" class="uae-flag-image">
                        <span class="mobile-prefix">971</span>
                      </div>
                      <input 
                        type="tel" 
                        class="form-control mobile-number-input" 
                        formControlName="phoneNumber"
                        placeholder="565666666"
                        maxlength="9"
                        (keypress)="restrictMobileInput($event)"
                        (input)="onMobileNumberInput()"
                        (blur)="onMobileNumberBlur()">
                    </div>
                    
                    <div class="invalid-feedback" *ngIf="isContactAddressEditMode && isFieldInvalid('phoneNumber')">
                      {{ getFieldError('phoneNumber') }}
                    </div>
                  </div>

                  <div class="data-1">
                    <h2>{{ 'REGISTRATION.TELEPHONE' | translate }}</h2>
                    <p *ngIf="!isContactAddressEditMode">{{ profileForm.get('telNumber')?.value || '-' }}</p>
                    <input 
                      *ngIf="isContactAddressEditMode"
                      type="tel" 
                      class="form-control" 
                      formControlName="telNumber"
                      [class.is-invalid]="isFieldInvalid('telNumber')"
                      placeholder="{{ 'REGISTRATION.ENTER_TELEPHONE' | translate }}">
                    <div class="invalid-feedback" *ngIf="isContactAddressEditMode && isFieldInvalid('telNumber')">
                      {{ getFieldError('telNumber') }}
                    </div>
                  </div>
                </div>

                <!-- Address Information -->
                <div class="gr-1">
                  <div class="data-1">
                    <h2>{{ 'REGISTRATION.COUNTRY' | translate }}</h2>
                    <p *ngIf="!isContactAddressEditMode">
                      {{ getCountryDisplayValue() }}
                    </p>
                    <ng-select 
                      *ngIf="isContactAddressEditMode"
                      formControlName="countryId"
                      class="w-100"
                      [class.is-invalid]="isFieldInvalid('countryId')"
                      [placeholder]="'REGISTRATION.SELECT_COUNTRY' | translate"
                      [items]="countries"
                      bindLabel="text"
                      bindValue="id"
                      [loading]="countriesLoading"
                      (scrollToEnd)="onCountriesScrollToEnd()">
                    </ng-select>
                    <div class="invalid-feedback" *ngIf="isContactAddressEditMode && isFieldInvalid('countryId')">
                      {{ getFieldError('countryId') }}
                    </div>
                  </div>

                  <div class="data-1">
                    <h2>{{ 'REGISTRATION.CITY' | translate }}</h2>
                    <p *ngIf="!isContactAddressEditMode">
                      {{ getCityDisplayValue() }}
                    </p>
                    <ng-select 
                      *ngIf="isContactAddressEditMode"
                      formControlName="cityId"
                      class="w-100"
                      [class.is-invalid]="isFieldInvalid('cityId')"
                      [placeholder]="'REGISTRATION.SELECT_CITY' | translate"
                      [items]="cities"
                      bindLabel="text"
                      bindValue="id"
                      [loading]="citiesLoading"
                      (scrollToEnd)="onCitiesScrollToEnd()">
                    </ng-select>
                    <div class="invalid-feedback" *ngIf="isContactAddressEditMode && isFieldInvalid('cityId')">
                      {{ getFieldError('cityId') }}
                    </div>
                  </div>
                </div>

                <div class="gr-1">
                  <div class="data-1 address-field">
                    <h2>{{ 'REGISTRATION.ADDRESS' | translate }}</h2>
                    <p *ngIf="!isContactAddressEditMode">{{ profileForm.get('address')?.value || '-' }}</p>
                    <textarea 
                      *ngIf="isContactAddressEditMode"
                      class="form-control" 
                      rows="3"
                      formControlName="address"
                      [class.is-invalid]="isFieldInvalid('address')"
                      placeholder="{{ 'REGISTRATION.ENTER_ADDRESS' | translate }}"></textarea>
                    <div class="invalid-feedback" *ngIf="isContactAddressEditMode && isFieldInvalid('address')">
                      {{ getFieldError('address') }}
                    </div>
                  </div>

                  <div class="data-1">
                    <h2>{{ 'REGISTRATION.PO_BOX' | translate }}</h2>
                    <p *ngIf="!isContactAddressEditMode">{{ profileForm.get('poBox')?.value || '-' }}</p>
                    <input 
                      *ngIf="isContactAddressEditMode"
                      type="text" 
                      class="form-control" 
                      formControlName="poBox"
                      [class.is-invalid]="isFieldInvalid('poBox')"
                      placeholder="{{ 'REGISTRATION.ENTER_PO_BOX' | translate }}">
                    <div class="invalid-feedback" *ngIf="isContactAddressEditMode && isFieldInvalid('poBox')">
                      {{ getFieldError('poBox') }}
                    </div>
                  </div>
                </div>

                <!-- Date Fields Section -->
                <div class="gr-1">
                  <div class="data-1">
                    <h2>{{ 'REGISTRATION.ID_NUMBER_ISSUE_DATE' | translate }}</h2>
                    <p *ngIf="!isContactAddressEditMode">{{ profileForm.get('idNumberIssueDate')?.value || '-' }}</p>
                    <input 
                      *ngIf="isContactAddressEditMode"
                      type="date" 
                      class="form-control" 
                      formControlName="idNumberIssueDate"
                      [class.is-invalid]="isFieldInvalid('idNumberIssueDate')"
                      [class.is-valid]="profileForm.get('idNumberIssueDate')?.valid && (profileForm.get('idNumberIssueDate')?.touched || submitted)">
                    <div class="invalid-feedback" *ngIf="isContactAddressEditMode && isFieldInvalid('idNumberIssueDate')">
                      {{ getFieldError('idNumberIssueDate') }}
                    </div>
                  </div>

                  <div class="data-1">
                    <h2>{{ 'REGISTRATION.ID_NUMBER_EXPIRY_DATE' | translate }}</h2>
                    <p *ngIf="!isContactAddressEditMode">{{ profileForm.get('idNumberExpiryDate')?.value || '-' }}</p>
                    <input 
                      *ngIf="isContactAddressEditMode"
                      type="date" 
                      class="form-control" 
                      formControlName="idNumberExpiryDate"
                      [class.is-invalid]="isFieldInvalid('idNumberExpiryDate')"
                      [class.is-valid]="profileForm.get('idNumberExpiryDate')?.valid && (profileForm.get('idNumberExpiryDate')?.touched || submitted)">
                    <div class="invalid-feedback" *ngIf="isContactAddressEditMode && isFieldInvalid('idNumberExpiryDate')">
                      {{ getFieldError('idNumberExpiryDate') }}
                    </div>
                  </div>

                  <div class="data-1">
                    <h2>{{ 'REGISTRATION.DATE_OF_BIRTH' | translate }}</h2>
                    <p *ngIf="!isContactAddressEditMode">{{ profileForm.get('dateOfBirth')?.value || '-' }}</p>
                    <input 
                      *ngIf="isContactAddressEditMode"
                      type="date" 
                      class="form-control" 
                      formControlName="dateOfBirth"
                      [class.is-invalid]="isFieldInvalid('dateOfBirth')"
                      [class.is-valid]="profileForm.get('dateOfBirth')?.valid && (profileForm.get('dateOfBirth')?.touched || submitted)">
                    <div class="invalid-feedback" *ngIf="isContactAddressEditMode && isFieldInvalid('dateOfBirth')">
                      {{ getFieldError('dateOfBirth') }}
                    </div>
                  </div>
                </div>
              </div>

              <!-- Edit Mode Buttons -->
              <div class="btn-grp" *ngIf="isContactAddressEditMode">
                <button 
                  type="button" 
                  class="btn btn-gray" 
                  (click)="cancelContactAddress()">
                  <span>{{ 'EDIT_PROFILE.CANCEL' | translate }}</span>
                </button>

                <button 
                  type="button" 
                  class="btn btn-gold" 
                  (click)="saveContactAddress()"
                  [disabled]="isLoading">
                  <span *ngIf="!isLoading">{{ 'EDIT_PROFILE.SAVE' | translate }}</span>
                  <span *ngIf="isLoading">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    {{ 'EDIT_PROFILE.SAVING' | translate }}
                  </span>
                </button>
              </div>
            </div>

            <!-- Documents/Attachments Section -->
            <div class="login-box mb-4 documents-section" *ngIf="attachmentConfigs.length > 0 && userType !== 1">
              <div class="card-header">
                <h2 class="title gold mb-4">{{ 'EDIT_PROFILE.DOCUMENTS' | translate }}</h2>
                <button 
                  type="button" 
                  class="btn btn-gold"
                  (click)="toggleAttachmentsEditMode()"
                  *ngIf="!isAttachmentsEditMode">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <g clip-path="url(#clip0_4_1412)">
                      <path d="M22.853 1.14795C22.1732 0.469151 21.2517 0.0878906 20.291 0.0878906C19.3303 0.0878906 18.4089 0.469151 17.729 1.14795L1.46502 17.412C0.999266 17.8751 0.629977 18.426 0.378513 19.0327C0.127049 19.6395 -0.00159798 20.2901 1.49812e-05 20.947V23C1.49812e-05 23.2652 0.105372 23.5195 0.292908 23.7071C0.480445 23.8946 0.734799 24 1.00002 24H3.05301C3.70978 24.0018 4.36038 23.8734 4.96717 23.6221C5.57396 23.3708 6.12487 23.0016 6.58801 22.536L22.853 6.27095C23.5315 5.59115 23.9126 4.66992 23.9126 3.70945C23.9126 2.74899 23.5315 1.82776 22.853 1.14795ZM5.17401 21.122C4.61002 21.6822 3.84798 21.9977 3.05301 22H2.00002V20.947C1.999 20.5529 2.07617 20.1625 2.22705 19.7984C2.37793 19.4343 2.59953 19.1038 2.87901 18.826L15.222 6.48295L17.522 8.78295L5.17401 21.122ZM21.438 4.85695L18.932 7.36395L16.632 5.06895L19.139 2.56195C19.29 2.41126 19.4693 2.29179 19.6664 2.21036C19.8636 2.12893 20.0749 2.08714 20.2883 2.08738C20.5016 2.08761 20.7128 2.12986 20.9098 2.21172C21.1069 2.29357 21.2858 2.41343 21.4365 2.56445C21.5872 2.71547 21.7067 2.8947 21.7881 3.09189C21.8695 3.28908 21.9113 3.50038 21.9111 3.71372C21.9109 3.92706 21.8686 4.13827 21.7868 4.33529C21.7049 4.5323 21.585 4.71126 21.434 4.86195L21.438 4.85695Z" fill="#ffffff"/>
                    </g>
                    <defs>
                      <clipPath id="clip0_4_1412">
                        <rect width="24" height="24" fill="white"/>
                      </clipPath>
                    </defs>
                  </svg>
                  <span>{{ 'EDIT_PROFILE.EDIT' | translate }}</span>
                </button>
              </div>
              
              <!-- Existing Attachments Grid Display -->
              <div *ngIf="getExistingAttachments().length > 0" class="mb-4">
                <div class="row">
                  <div class="col-xl-4 col-lg-6 mb-4" *ngFor="let config of getExistingAttachments()">
                    <div class="attachment-box">
                      <div class="attachment-card-header">
                        <h6 class="card-title">{{ getAttachmentDisplayName(config) }}</h6>
                        <div class="attachment-badges">
                          <span class="badge" 
                                [class.badge-success]="isAttachmentRequired(config)"
                                [class.badge-warning]="!isAttachmentRequired(config)">
                            {{ isAttachmentRequired(config) ? ('EDIT_PROFILE.MANDATORY' | translate) : ('EDIT_PROFILE.OPTIONAL' | translate) }}
                          </span>
                        </div>
                      </div>
                      
                      <div class="attachment-preview-container">
                        <img 
                          [src]="filePreviews[config.id]" 
                          [alt]="'EDIT_PROFILE.FILE_PREVIEW' | translate" 
                          class="attachment-preview-image"
                          (error)="onImageError($event)" />
                        <div class="attachment-overlay">
                          <i class="fas fa-check-circle text-success"></i>
                          <span class="fw-semibold text-success">{{ 'EDIT_PROFILE.EXISTING_FILE' | translate }}</span>
                        </div>
                      </div>
                      
                      <p class="mb-4">{{ 'COMMON.UPLOADED_ON' | translate }}: {{ formatDateTime(getExistingFileDate(config.id)) }}</p>
                      
                      <div class="d-flex justify-content-between mt-auto">
                        <button 
                          type="button" 
                          class="btn btn-next-style me-2"
                          (click)="viewAttachment(config.id)"
                          [title]="'EDIT_PROFILE.VIEW_ATTACHMENT' | translate">
                          <i class="fas fa-eye me-1"></i>
                          {{ 'COMMON.VIEW' | translate }}
                        </button>
                        
                        <!-- Edit mode buttons -->
                        <div *ngIf="isAttachmentsEditMode" class="edit-actions">
                          <button 
                            type="button" 
                            class="btn btn-delete-attachment me-1"
                            (click)="removeExistingFile(config.id)"
                            [title]="'EDIT_PROFILE.DELETE_ATTACHMENT' | translate">
                            <i class="fas fa-trash"></i>
                          </button>
                          
                          <button 
                            type="button" 
                            class="btn btn-update-attachment"
                            (click)="triggerFileInput(config.id)"
                            [title]="'EDIT_PROFILE.UPDATE_ATTACHMENT' | translate">
                            <i class="fas fa-edit"></i>
                          </button>
                        </div>
                      </div>
                      
                      <!-- Hidden file input for existing attachments (needed for edit functionality) -->
                      <input 
                        type="file" 
                        [id]="'file-' + config.id"
                        class="file-input" 
                        (change)="onFileSelected($event, config.id)"
                        accept=".jpg,.jpeg,.png,.gif,.pdf"
                        style="display: none;">
                    </div>
                  </div>
                </div>
              </div>

              <!-- File Upload Areas for attachment configs without existing files (only in edit mode) -->
              <div class="row" *ngFor="let config of getAttachmentConfigsNeedingUpload()">
                <div class="col-xl-12">
                  <div class="mb-4">
                    <label class="form-label">
                      {{ getAttachmentDisplayName(config) }}
                      <span class="text-danger" *ngIf="isAttachmentRequired(config)">*</span>
                    </label>
                    
                    <!-- File Upload Area (only show when in edit mode and no existing file) -->
                    <div class="upload-area" 
                         [class.has-file]="selectedFiles[config.id]"
                         [class.is-invalid]="isAttachmentRequired(config) && !selectedFiles[config.id] && !hasExistingFile(config.id) && submitted"
                         [class.clickable]="isAttachmentsEditMode"
                         (click)="isAttachmentsEditMode ? triggerFileInput(config.id) : null">
                      
                      <div class="upload-content" *ngIf="!selectedFiles[config.id]">
                        <div class="upload-icon">
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <g clip-path="url(#clip0_206_15001)">
                              <path d="M18.4001 7.37889C18.2192 7.32729 18.0541 7.23128 17.9198 7.09959C17.7855 6.9679 17.6862 6.80472 17.6311 6.62489C17.3248 5.58693 16.8112 4.6219 16.1213 3.78818C15.4313 2.95447 14.5793 2.2694 13.617 1.77445C12.6546 1.27949 11.6018 0.984934 10.5223 0.908599C9.44286 0.832265 8.3591 0.975741 7.33666 1.33034C6.31422 1.68495 5.37436 2.24331 4.57394 2.97163C3.77352 3.69996 3.1292 4.58311 2.67995 5.56764C2.2307 6.55218 1.98588 7.61762 1.96029 8.6995C1.9347 9.78139 2.12888 10.8572 2.53107 11.8619C2.62347 12.0733 2.64336 12.3094 2.58766 12.5333C2.53195 12.7572 2.40377 12.9564 2.22307 13.0999C1.4268 13.6909 0.805119 14.4862 0.423825 15.4015C0.0425303 16.3169 -0.0841907 17.3184 0.0570735 18.2999C0.277527 19.6268 0.966398 20.8306 1.99866 21.693C3.03091 22.5553 4.33814 23.019 5.68307 22.9999H11.0001C11.2653 22.9999 11.5196 22.8945 11.7072 22.707C11.8947 22.5195 12.0001 22.2651 12.0001 21.9999C12.0001 21.7347 11.8947 21.4803 11.7072 21.2928C11.5196 21.1052 11.2653 20.9999 11.0001 20.9999H5.68307C4.81935 21.0208 3.9767 20.7317 3.30783 20.1848C2.63897 19.6379 2.18815 18.8696 2.03707 18.0189C1.94127 17.3936 2.01891 16.7541 2.26155 16.1699C2.50418 15.5857 2.90249 15.0793 3.41307 14.7059C3.94939 14.3051 4.33736 13.7374 4.51601 13.0921C4.69466 12.4468 4.65388 11.7605 4.40007 11.1409C3.89823 9.81559 3.87242 8.35711 4.32707 7.01489C4.69027 5.96346 5.34066 5.03477 6.20456 4.334C7.06846 3.63323 8.11134 3.18839 9.21507 3.04989C9.47109 3.01693 9.72894 3.00023 9.98707 2.99989C11.2801 2.99562 12.5398 3.41032 13.5774 4.18188C14.6151 4.95344 15.3749 6.04036 15.7431 7.27989C15.8868 7.75226 16.1458 8.18146 16.4966 8.52884C16.8475 8.87623 17.2793 9.13089 17.7531 9.26989C18.9126 9.61281 19.9396 10.3018 20.6968 11.2445C21.4539 12.1873 21.905 13.3388 21.9896 14.545C22.0742 15.7511 21.7883 16.9544 21.1702 17.9936C20.5522 19.0328 19.6313 19.8584 18.5311 20.3599C18.3682 20.4433 18.2321 20.5707 18.1382 20.7277C18.0443 20.8847 17.9965 21.065 18.0001 21.2479C17.9981 21.4134 18.0378 21.5767 18.1154 21.7228C18.193 21.869 18.3061 21.9933 18.4442 22.0844C18.5824 22.1755 18.7412 22.2304 18.9061 22.2441C19.071 22.2578 19.2368 22.2299 19.3881 22.1629C23.5221 20.1759 25.7681 14.9489 22.2681 9.89889C21.3044 8.64181 19.9394 7.75251 18.4001 7.37889Z" fill="#8D734D" />
                              <path d="M18.7074 16.7065C18.8949 16.519 19.0002 16.2646 19.0002 15.9995C19.0002 15.7343 18.8949 15.48 18.7074 15.2925L17.1214 13.7065C16.5588 13.1441 15.7959 12.8281 15.0004 12.8281C14.2049 12.8281 13.442 13.1441 12.8794 13.7065L11.2934 15.2925C11.1112 15.4811 11.0105 15.7337 11.0127 15.9959C11.015 16.2581 11.1202 16.5089 11.3056 16.6943C11.491 16.8797 11.7418 16.9849 12.004 16.9872C12.2662 16.9894 12.5188 16.8886 12.7074 16.7065L14.0004 15.4135V22.9995C14.0004 23.2647 14.1058 23.5191 14.2933 23.7066C14.4808 23.8941 14.7352 23.9995 15.0004 23.9995C15.2656 23.9995 15.52 23.8941 15.7075 23.7066C15.8951 23.5191 16.0004 23.2647 16.0004 22.9995V15.4135L17.2934 16.7065C17.4809 16.894 17.7352 16.9993 18.0004 16.9993C18.2656 16.9993 18.5199 16.894 18.7074 16.7065Z" fill="#8D734D" />
                            </g>
                            <defs>
                              <clipPath id="clip0_206_15001">
                                <rect width="24" height="24" fill="white" />
                              </clipPath>
                            </defs>
                          </svg>
                        </div>
                        <p class="mb-2">
                          <span class="font-semibold">
                            {{ hasExistingFile(config.id) ? ('EDIT_PROFILE.CLICK_TO_UPDATE' | translate) : ('EDIT_PROFILE.CLICK_TO_UPLOAD_NEW' | translate) }}
                          </span>
                        </p>
                        <p class="mb-0">{{ 'REGISTRATION.FILE_TYPES' | translate }}</p>
                      </div>

                      <!-- New File Preview -->
                      <div class="uploaded-file" *ngIf="selectedFiles[config.id]" (click)="$event.stopPropagation()">
                        <div class="d-flex gap-2">
                          <img 
                            [src]="filePreviews[config.id]" 
                            [alt]="'EDIT_PROFILE.FILE_PREVIEW' | translate" 
                            class="file-preview"
                            (error)="onImageError($event)" />
                          <div>
                            <div class="d-flex align-items-center gap-2">
                              <i class="fas fa-plus-circle text-primary"></i>
                              <span class="fw-semibold text-primary">{{ 'EDIT_PROFILE.NEW_FILE' | translate }}</span>
                            </div>
                            <p class="black mb-0">{{ selectedFiles[config.id].name }}</p>
                            <p class="gray mb-0">{{ (selectedFiles[config.id].size / 1024).toFixed(1) }} {{ 'EDIT_PROFILE.KILOBYTES' | translate }}</p>
                          </div>
                        </div>
                        <button type="button" class="btn-remove-uploaded-file" (click)="removeFile(config.id)">
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M21 4H17.9C17.6679 2.87141 17.0538 1.85735 16.1613 1.12872C15.2687 0.40009 14.1522 0.00145452 13 0L11 0C9.8478 0.00145452 8.73132 0.40009 7.83875 1.12872C6.94618 1.85735 6.3321 2.87141 6.1 4H3C2.73478 4 2.48043 4.10536 2.29289 4.29289C2.10536 4.48043 2 4.73478 2 5C2 5.26522 2.10536 5.51957 2.29289 5.70711C2.48043 5.89464 2.73478 6 3 6H4V19C4.00159 20.3256 4.52888 21.5964 5.46622 22.5338C6.40356 23.4711 7.67441 23.9984 9 24H15C16.3256 23.9984 17.5964 23.4711 18.5338 22.5338C19.4711 21.5964 19.9984 20.3256 20 19V6H21C21.2652 6 21.5196 5.89464 21.7071 5.70711C21.8946 5.51957 22 5.26522 22 5C22 4.73478 21.8946 4.48043 21.7071 4.29289C21.5196 4.10536 21.2652 4 21 4ZM11 2H13C13.6203 2.00076 14.2251 2.19338 14.7316 2.55144C15.2381 2.90951 15.6214 3.41549 15.829 4H8.171C8.37858 3.41549 8.7619 2.90951 9.26839 2.55144C9.77487 2.19338 10.3797 2.00076 11 2ZM18 19C18 19.7956 17.6839 20.5587 17.1213 21.1213C16.5587 21.6839 15.7956 22 15 22H9C8.20435 22 7.44129 21.6839 6.87868 21.1213C6.31607 20.5587 6 19.7956 6 19V6H18V19Z" fill="#5B5B5B" />
                            <path d="M10 18C10.2652 18 10.5196 17.8946 10.7071 17.7071C10.8946 17.5196 11 17.2652 11 17V11C11 10.7348 10.8946 10.4804 10.7071 10.2929C10.5196 10.1054 10.2652 10 10 10C9.73478 10 9.48043 10.1054 9.29289 10.2929C9.10536 10.4804 9 10.7348 9 11V17C9 17.2652 9.10536 17.5196 9.29289 17.7071C9.48043 17.8946 9.73478 18 10 18Z" fill="#5B5B5B" />
                            <path d="M14 18C14.2652 18 14.5196 17.8946 14.7071 17.7071C14.8947 17.5196 15 17.2652 15 17V11C15 10.7348 14.8947 10.4804 14.7071 10.2929C14.5196 10.1054 14.2652 10 14 10C13.7348 10 13.4804 10.1054 13.2929 10.2929C13.1054 10.4804 13 10.7348 13 11V17C13 17.2652 13.1054 17.5196 13.2929 17.7071C13.4804 17.8946 13.7348 18 14 18Z" fill="#5B5B5B" />
                          </svg>
                        </button>
                      </div>
                      
                      <!-- Hidden file input (always present but only functional in edit mode) -->
                      <input 
                        type="file" 
                        [id]="'file-' + config.id"
                        class="file-input" 
                        (change)="onFileSelected($event, config.id)"
                        accept=".jpg,.jpeg,.png,.gif,.pdf"
                        style="display: none;">
                    </div>
                    
                    <div class="invalid-feedback" *ngIf="isAttachmentRequired(config) && !selectedFiles[config.id] && !hasExistingFile(config.id) && submitted">
                      {{ 'REGISTRATION.ATTACHMENT_REQUIRED' | translate }}
                    </div>
                  </div>
                </div>
              </div>

              <!-- Edit Mode Buttons -->
              <div class="btn-grp" *ngIf="isAttachmentsEditMode">
                <button 
                  type="button" 
                  class="btn btn-gray" 
                  (click)="toggleAttachmentsEditMode()">
                  <span>{{ 'EDIT_PROFILE.CANCEL' | translate }}</span>
                </button>

                <button 
                  type="button" 
                  class="btn btn-gold" 
                  (click)="saveAttachments()"
                  [disabled]="isLoading">
                  <span *ngIf="!isLoading">{{ 'EDIT_PROFILE.SAVE' | translate }}</span>
                  <span *ngIf="isLoading">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    {{ 'EDIT_PROFILE.SAVING' | translate }}
                  </span>
                </button>
              </div>
            </div>

          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- Password Change Modal -->
  <div class="modal fade" [class.show]="showPasswordModal" [style.display]="showPasswordModal ? 'block' : 'none'" 
       *ngIf="showPasswordModal" tabindex="-1" role="dialog" aria-labelledby="passwordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="passwordModalLabel">{{ 'EDIT_PROFILE.CHANGE_PASSWORD' | translate }}</h5>
          <button type="button" class="btn-close" (click)="closePasswordModal()" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form [formGroup]="profileForm">
            <div class="row">
              <div class="col-xl-12">
                <div class="mb-4">
                  <label for="currentPassword" class="form-label">{{ 'EDIT_PROFILE.CURRENT_PASSWORD' | translate }} *</label>
                  <input 
                    type="password" 
                    class="form-control" 
                    id="currentPassword" 
                    formControlName="currentPassword"
                    [class.is-invalid]="isFieldInvalid('currentPassword')"
                    placeholder="{{ 'EDIT_PROFILE.ENTER_CURRENT_PASSWORD' | translate }}">
                  <div class="invalid-feedback" *ngIf="isFieldInvalid('currentPassword')">
                    {{ getFieldError('currentPassword') }}
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-xl-6">
                <div class="mb-4">
                  <label for="password" class="form-label">{{ 'EDIT_PROFILE.NEW_PASSWORD' | translate }} *</label>
                  <input 
                    type="password" 
                    class="form-control" 
                    id="password" 
                    formControlName="password"
                    [class.is-invalid]="isFieldInvalid('password')"
                    placeholder="{{ 'EDIT_PROFILE.ENTER_NEW_PASSWORD' | translate }}">
                  <div class="invalid-feedback" *ngIf="isFieldInvalid('password')">
                    {{ getFieldError('password') }}
                  </div>
                </div>
              </div>
              <div class="col-xl-6">
                <div class="mb-4">
                  <label for="confirmPassword" class="form-label">{{ 'EDIT_PROFILE.CONFIRM_NEW_PASSWORD' | translate }} *</label>
                  <input 
                    type="password" 
                    class="form-control" 
                    id="confirmPassword" 
                    formControlName="confirmPassword"
                    [class.is-invalid]="isFieldInvalid('confirmPassword')"
                    placeholder="{{ 'EDIT_PROFILE.CONFIRM_NEW_PASSWORD' | translate }}">
                  <div class="invalid-feedback" *ngIf="isFieldInvalid('confirmPassword')">
                    {{ getFieldError('confirmPassword') }}
                  </div>
                  <div class="valid-feedback" *ngIf="showPasswordMatch()">
                    {{ 'REGISTRATION.PASSWORDS_MATCH' | translate }}
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-gray" (click)="closePasswordModal()">
            {{ 'EDIT_PROFILE.CANCEL' | translate }}
          </button>
          <button type="button" class="btn btn-gold" (click)="onSubmit()">
            {{ 'EDIT_PROFILE.SAVE_PASSWORD' | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal Backdrop -->
  <div class="modal-backdrop fade" [class.show]="showPasswordModal" *ngIf="showPasswordModal"></div>
</div>
